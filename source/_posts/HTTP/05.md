---
title: http 与 tcp
date: 2018-05-05
categories: Http
tags: Http
toc: true
thumbnail: https://gitee.com/heptaluan/backups/raw/master/cdn/cover/05.jpg
---


## http 协议

`http` 协议即**超文本传送协议**(`Hypertext Transfer Protocol`)，定义了浏览器怎样向万维网服务器请求万维网文档，以及服务器怎样把文档传送给浏览器

<!--more-->

从层次的角度看，`http` 是面向（`transaction-oriented`）应用层协议，它是万维网上能够可靠地交换文件（包括文本，声音，图像等各种多媒体文件）的重要基础，也是 `Web` 联网的基础，也是手机联网常用的协议之一，`http` 协议是建立在 `tcp` 协议之上的一种应用

## tcp（Transmission Control Protocol）

手机等一些移动设备，能够使用联网功能是因为手机**底层**实现了 `tcp/IP` 协议，可以使手机终端通过无线网络建立 `tcp` 连接

`tcp` 协议可以对上层网络提供接口，使上层网络数据的传输建立在"无差别"的网络之上

在具体介绍之前，先来弄清一些基本概念

* `SYN`（`synchronous`）是 `tcp/IP` 建立连接时使用的握手信号，表示建立连接

* `FIN` 表示关闭连接

* `ACK`（`Acknowledgement`）既确认字符，在数据通信中，接收站发给发送站的一种传输类控制字符，表示发来的数据已确认接收无误，表示响应

* `LISTEN` 表示服务器端的某个 `SOCKET` 处于监听状态，可以接受连接了

* `MIME` 类型 在把输出结果传送到浏览器上的时候，浏览器必须启动适当的应用程序来处理这个输出文档

  * 这可以通过多种类型 `MIME`（多功能网际邮件扩充协议）来完成，在 `http` 中，`MIME` 类型被定义在 `Content-Type header` 中


`tcp` 传输控制协议，是一种面向连接的、可靠的、基于字节流的传输层通信协议

通讯双方建立一次 `tcp` 连接，需要经过三次步骤，可以见下方的三次握手

## URL（Uniform Resource Locator）统一资源定位符

`URL` 统一资源定位符（`URL`）也被称为网页地址，是因特网上标准的资源的地址，现在几乎所有的 `URI` 都是 `URL`，如下所示

```js                      
 协议      ip 地址      资源的具体位置
  |          |              |
  |          |              |
-----  ----------------  -------
http://192.168.1.1:8888/index.html
```

* 第一部分是协议（或称为服务方式）

* 第二部分是存有该资源的主机 `IP` 地址（有时也包括端口号）

* 第三部分是主机资源的具体位置（如目录和文件名等）

* 第一部分和第三部分之间用 `'：//'` 符号隔开，第二部分和第三部分用 `'/'` 符号分隔，第一部分和第二部分是不可缺少的，第三部分有时也可以省略




## tcp 三次握手

我们要和服务端连接 `tcp` 连接，需要通过三次连接，包括：**请求**，**确认**，**建立连接**，即传说中的三次握手协议

![](https://gitee.com/heptaluan/backups/raw/master/cdn/http/06.png)

* 第一次握手：客户端发送 `syn` 包`（syn = j）`到服务器，并进入 `SYN_SEND` 状态，等待服务器确认

* 第二次握手：服务器收到 `syn` 包，必须确认客户的 `SYN（ack = j + 1）`，同时自己也发送一个 `SYN` 包`（syn = k）`，即 `SYN + ACK` 包，此时服务器进入 `SYN_RECV` 状态

* 第三次握手：客户端收到服务器的 `SYN ＋ ACK` 包，向服务器发送确认包 `ACK（ack = k + 1）`，此包发送完毕，客户端和服务器进入 `ESTABLISHED` 状态，完成三次握手


**握手过程中传送的包里不包含数据**，三次握手完毕后，客户端与服务器才正式开始传送数据

理想状态下，`tcp` 连接一旦建立，在通信双方中的任何一方主动关闭连接之前，`tcp` 连接都将被一直保持下去

但是由于 `tcp` 连接是全双工的，所以每个方向都必须单独进行关闭，这原则是当一方完成它的数据发送任务后就能发送一个 `FIN` 来终止这个方向的连接

收到一个 `FIN` 只意味着这一方向上没有数据流动，一个 `tcp` 连接在收到一个 `FIN` 后仍能发送数据，首先进行关闭的一方将执行主动关闭，而另一方执行被动关闭



## tcp 四次挥手

断开连接时服务器和客户端均可以主动发起断开 `tcp` 连接的请求，断开过程需要经过"四次挥手"


![](https://gitee.com/heptaluan/backups/raw/master/cdn/http/07.png)


* 第一次挥手：`tcp` 客户端发送一个 `FIN`，用来关闭客户到服务器的数据传送

* 第二次挥手：服务器收到这个 `FIN`，它发回一个 `ACK`，确认序号为收到的序号加 `1`，和 `SYN` 一样，一个 `FIN` 将占用一个序号

* 第三次挥手：服务器关闭客户端的连接，发送一个 `FIN` 给客户端

* 第四次挥手：客户端发回 `ACK` 报文确认，并将确认序号设置为收到序号加 `1`


那么这里就会有一个问题了，为什么建立连接协议是三次握手，而关闭连接却是四次握手呢？

这是因为服务端的 `LISTEN` 状态下的 `SOCKET` 当收到 `SYN` 报文的建连请求后，它可以把 `ACK` 和 `SYN`（`ACK` 起应答作用，而 `SYN` 起同步作用）放在一个报文里来发送

但关闭连接时，当收到对方的 `FIN` 报文通知时，它仅仅表示对方没有数据发送给你了，但未必你所有的数据都全部发送给对方了，所以你可以未必会马上会关闭 `SOCKET`

也即你可能还需要发送一些数据给对方之后，再发送 `FIN` 报文给对方来表示你同意现在可以关闭连接了，所以它这里的 `ACK` 报文和 `FIN` 报文多数情况下都是分开发送的








## 总结

* `http` 是要基于 `tcp` 连接基础上的，简单的说，`tcp` 就是单纯建立连接，不涉及任何我们需要请求的实际数据，简单的传输，`http` 是用来收发数据，即实际应用上来的

  * `tcp` 是**底层通讯协议**，定义的是 **数据传输和连接方式的规范**

  * `http` 是**应用层协议**，定义的是 **传输数据的内容的规范**

* `http` 协议中的数据是利用 `tcp` 协议传输的，所以支持 `http` 也就一定支持 `tcp`

* `http` 支持的是 `www` 服务，而 `tcp/IP` 是协议，它是 `Internet` 国际互联网络的基础，`tcp/IP` 是网络中使用的基本的通信协议

* `tcp/IP` 实际上是一组协议，它包括上百个各种功能的协议，如：远程登录、文件传输和电子邮件等，而 `tcp` 协议和 `IP` 协议是保证数据完整传输的两个基本的重要协议，通常说 `tcp/IP` 是 `Internet` 协议族，而不单单是 `tcp` 和 `IP`

