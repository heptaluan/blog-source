---
title: TCP/IP 协议
date: 2020-09-20
categories: HTTP
tags: HTTP
toc: true
thumbnail: https://gitee.com/heptaluan/backups/raw/master/cdn/cover/14.jpg
---

在之前的章节当中，我们梳理了 [HTTP 协议](https://heptaluan.github.io/2020/09/01/HTTP/10/)，[HTTPS](https://heptaluan.github.io/2020/08/09/HTTP/09/)，[HTTP/2](https://heptaluan.github.io/2020/09/06/HTTP/11/) 和 [HTTP/3](https://heptaluan.github.io/2020/09/12/HTTP/12/) 的一些相关内容，本章我们再来看看姑且算是最后一部分内容，也算是补充部分的 `TCP/IP` 协议相关内容，这部分内容主要参考的是 [图解 TCP/IP](https://book.douban.com/subject/24737674/)

但是在本章当中关于 `TCP/IP` 协议的相关内容不会像 `HTTP` 协议那样梳理的十分细致，因为关于这部分的内容在工作之中接触有限，所以在这里简单记录一下也就当做是扩展知识了

<!--more-->



## 协议

`TCP/IP` 是通信协议的统称，不过在此之前，我们有必要先来理清协议的概念，在计算机网络与信息通信领城里，人们经常提及协议一词，互联网中常用的具有代表性的协议有 `IP`、`TCP`、 `HTTP` 等，而 `LAN`（局域网）中常用的协议有 `IPX/SPX` 等，计算机网络体系结构将这些网络协议进行了系统的归纳，`TCP/IP` 就是 `IP`、`TCP`、`HTTP` 等协议的集合

网絡体系结构 | 协议 | 主要用途
-|-|-
`TCP/IP` | `IP/ICMP/TCP/UDP/HTTP/TELNET/SNMP/SMTP` 等 | 互联网、局城网
`IPX/SPX`（`NetWare`） | `IPX/SPX/NPC` 等 | 个人电脑局域网
`AplcTalk` | `DDP/RTMP/AEP/ATP/ZIP` 等 | 苹果公司现有产品的局城网
`DECnet` | `DPR/NSP/SCP` 等 | 前 `DEC` 小型机
`OSI` | `FTAM/MOTIS/VT/CMIS/CMIP,CLNP/CONP` | -
`XNS` | `IDP/SPP/PEP` 等 | 施乐公司网络


#### 协议的必要性

简单来说，协议就是计算机与计算机之间通过网络实现通信时事先达成的一种约定，这种约定使那些由不同厂商的设备、不同的 `CPU` 以及不同的操作系统组成的计算机之间，只要遵循相同的协议就能够实现通信，反之如果所使用的协议不同，就无法实现通信，但是在计算机通信诞生之初，系统化与标准化并未得到足够的重视，每家计算机厂商都出产各自的网络产品来实现计算机通信，对于协议的系统化、分层化等事宜没有特别强烈的意识

为了解决上述问题，`ISO` 制定了一个国际标准 `OSI`，对通信系统进行了标准化，现在 `OSI` 所定义的协议虽然并没有得到普及，但是在 `OSI` 协议设计之初作为其指导方针的 `OSI` 参考模型却常被用于网络协议的制定当中

但是我们在本章当中介绍的 `TCP/IP` 并非 `ISO` 所制定的某种国际标准，而是由 `IETF` 所建议的、致力于推进其标准化作业的一种协议，在当时大学等研究机构和计算机行业作为中心力量，推动了 `TCP/IP` 的标准化进程，`TCP/IP` 作为互联网之上的一种标准，也作为业界标准，俨然已成为全世界所广泛应用的通信协议，那些础知识支持互联网的设备及软件，也正着力遵循由 `IETF` 标准化的 `TCP/IP` 协议

协议得以标准化也使所有遵循标准协议的设备不再因计算机硬件或操作系统的差异而无法通信，因此协议的标准化也推动了计算机网络的普及


## OSI 参考模型

`IS0` 在制定标准化 `OSI` 之前，对网络体系结构相关的问题进行了充分的讨论，最终提出了作为通信协议设计指标的 `OSI` 参考模型，这一模型将通信协议中必要的功能分成了七层，通过这些分层，使得那些比较复杂的网络协议更加简单化，在这一模型中，每个分层都接收由它下一层所提供的特定服务，并且负责为自己的上一层提供特定的服务

* 上下层之间进行交互时所遵循的约定叫做接口
* 同一层之间的交互所遵循的约定叫做协议

协议分层就如同计算机软件中的模块化开发，`OSI` 参考模型的建议是比较理想化的，它希望实现从第一层到第七层的所有模块，并将它们组合起来实现网络通信，分层可以将每个分层独立使用，即使系统中某些分层发生变化，也不会波及整个系统，因此可以构造一个扩展性和灵活性都较强的系统

* 此外通过层能够细分通信功能，更易于单独实现每个分层的协议，并界定各个分层的具体责任和义务，这些都属于分层的优点
* 而分层的劣势，可能就在于过分模块化、使处理变得更加沉重以及每个模块都不得不实现相似的处理:逻辑等问题


#### OSI 参考模型

如下图所示

![](https://gitee.com/heptaluan/backups/raw/master/cdn/http/14-06.png)

不过，`OSI` 参考模型终究只是一个模型，它也只是对各层的作用做了一系列粗略的界定，并没有对协议和接口进行详细的定义，它对学习和设计协议只能起到一个引导的作用，许多通信协议，都对应了  `OSI` 参考模型七个分层中的某层，通过这一点，可以大致了解该协议在整个通信功能中的位置和作用

> 这里需要区分开来 `OSI` 协议与 `OSI` 参考模型

* `OSI` 协议是为了让异构的计算机之间能够相互通信的、由 `ISO` 和 `ITU-T` 推进其标准化的一种网絡体系结构，`OST`（参考模型）将通信功能划分为七个分层，称作 `OSI` 参考模型
* 而 `OSI` 协议以 `OSI` 参考模型为基础界定了每个阶层的协议和每个阶层之间接口相关的标准，遵循 `OSI` 协议的产品叫 `OSI` 产品，而它们所遵循的通信则被称为 `OSI` 通信



## TCP/IP 基础

从字面意义上讲，有人可能会认为 `TCP/IP` 是指 `TCP` 和 `IP` 两种协议，实际生活当中有时也确实就是指这两种协议，然而在很多情况下，它只是利用 `IP` 进行通信时所必须用到的协议群的统称，具体来说，`IP` 或 `ICMP`、`TCP` 或 `UDP`、`TELNET` 或 `FTP`、以及 `HTTP` 等都属于 `TCP/IP` 协议，他们与 `TCP` 或 `IP` 的关系紧密，是互联网必不可少的组成部分，`TCP/IP` 一词泛指这些协议

因此，有时也称 `TCP/IP` 为网际协议群，互联网进行通信时，需要相应的网络协议，`TCP/IP` 原本就是为使用互联网而开发制定的协议族，因此互联网的协议就是 `TCP/IP`，`TCP/IP` 就是互联网的协议

![](https://gitee.com/heptaluan/backups/raw/master/cdn/http/14-07.png)




## TCP/IP 协议分层模型

![](https://gitee.com/heptaluan/backups/raw/master/cdn/http/14-08.png)

不难看出，`TCP/IP` 与 `OSI` 在分层模块上稍有区别，`OSI` 参考模型注重 **通信协议必要的功能是什么**，而 `TCP/IP` 则更强调 **在计算机上实现协议应该开发哪种程序**




## 数据包

包、帧、数据包、段、消息以上五个术语都用来表述数据的单位，大致区分如下

* 包可以说是全能性术语
* 帧用于表示数据链路层中包的单位
* 数据包是 `IP` 和 `UDP` 等网络层以上的分层中包的单位
* 段则表示 `TCP` 数据流中的信息
* 消息是指应用协议中数据的单位

![](https://gitee.com/heptaluan/backups/raw/master/cdn/http/14-09.png)

每个分层中，都会对所发送的数据附加一个首部，在这个首部中包含了该层必要的信息，如发送的目标地址以及协议相关信息，通常为协议提供的信息为包首部，所要发送的内容为数据，如上图，在下一层的角度看，从上一分层收到的包全部都被认为是本层的数据

网络中传输的数据包由两部分组成

* 一部分是协议所要用到的首部
* 另一部分是上一层传过来的数据

首部的结构由协议的具体规范详细定义，在数据包的首部，明确标明了协议应该如何读取数据，反过来说，看到首部也就能够了解该协议必要的信息以及所要处理的数据，**包首部就像协议的脸**




## 数据处理流程

我们以一个发送邮件的流程为例，如下图

![](https://gitee.com/heptaluan/backups/raw/master/cdn/http/14-10.png)

1. 应用程序处理首先应用程序会进行编码处理，这些编码相当于 `OSI` 的表示层功能，编码转化后邮件不一定马上被发送出去，这种何时建立通信连接何时发送数据的管理功能，相当于 `OSI` 的会话层功能
2. `TCP` 模块的处理，`TCP` 根据应用的指示，负责建立连接、发送数据以及断开连接，`TCP` 提供将应用层发来的数据顺利发送至对端的可靠传输，为了实现这一功能，需要在应用层数据的前端附加一个 `TCP` 首部
3. `IP` 模块的处理，`IP` 将 `TCP` 传过来的 `TCP` 首部和 `TCP` 数据合起来当做自己的数据，并在 `TCP` 首部的前端加上自己的 `IP` 首部，`IP` 包生成后，参考路由控制表决定接受此 `IP` 包的路由或主机
4. 网络接口（以太网驱动）的处理从 `IP` 传过来的 `IP` 包对于以太网来说就是数据，给这些数据附加上以太网首部并进行发送处理，生成的以太网数据包将通过物理层传输给接收端
5. 网络接口（以太网驱动）的处理主机收到以太网包后，首先从以太网包首部找到 `MAC` 地址判断是否为发送给自己的包，若不是则丢弃数据，如果是发送给自己的包，则从以太网包首部中的类型确定数据类型，再传给相应的模块，如 `IP`、`ARP` 等，这里的例子则是 `IP` 
6. `IP` 模块的处理`IP` 模块接收到 数据后也做类似的处理，从包首部中判断此 `IP` 地址是否与自己的 `IP` 地址匹配，如果匹配则根据首部的协议类型将数据发送给对应的模块，如 `TCP`、`UDP`，这里的例子则是 `TCP`，另外对于有路由器的情况，接收端地址往往不是自己的地址，此时需要借助路由控制表，在调查应该送往的主机或路由器之后再进行转发数据
7. `TCP` 模块的处理在 `TCP` 模块中，首先会计算一下校验和，判断数据是否被破坏，然后检查是否在按照序号接收数据，最后检查端口号，确定具体的应用程序，数据被完整地接收以后，会传给由端口号识别的应用程序
8. 应用程序的处理接收端应用程序会直接接收发送端发送的数据，通过解析数据，展示相应的内容




## IP 协议

IP（IPv4、IPv6）相当于 OSI 参考模型中的第3层——网络层。网络层的主要作用是“实现终端节点之间的通信”。这种终端节点之间的通信也叫“点对点通信”。而网络的下一层——数据链路层的主要作用是在互连同一种数据链路的节点之间进行包传递。而一旦跨越多种数据链路，就需要借助网络层。网络层可以跨越不同的数据链路，即使是在不同的数据链路上也能实现两端节点之间的数据包传输。

IP 大致分为三大作用模块，它们是 IP 寻址、路由（最终节点为止的转发）以及 IP 分包与组包。下面我们就一个一个来介绍


## IP 地址

在计算机通信中，为了识别通信对端，必须要有一个类似于地址的识别码进行标识。在数据链路中的 MAC 地址正是用来标识同一个链路中不同计算机的一种识别码。作为网络层的 IP ,也有这种地址信息，一般叫做 IP 地址。IP 地址用于在“连接到网络中的所有主机中识别出进行通信的目标地址”。因此，在 TCP/IP 通信中所有主机或路由器必须设定自己的 IP 地址。但是不论一台主机与哪种数据链路连接，其 IP 地址的形式都保持不变。


#### IP 地址的定义

在用TCP/IP通信时，用IP地址识别主机和路由器。为了保证正常通信，有必要为每个设备配置正确的IP地址。在互联网通信中，全世界都必须设定正确的IP地址。否则，根本无法实现正常的通信。因此，IP 地址就像是TCP/IP通信的一-块基石。

IP 地址（IPv4 地址）由32位正整数来表示。IP 地址在计算机内部以二进制方式被处理。然而，由于我们并不习惯于采用二进制方式，我们将32位的 IP 地址以每8位为一组，分成4组，每组以 “.” 隔开，再将每组数转换成十进制数。如下：

`2^8` | `2^8` | `2^8` | `2^8` | -
-|-|-|-|-
`10101100` | `00010100` | `00000001` | `00000001` |  二进制
`10101100.` | `00010100.` | `00000001.` | `00000001` | 二进制
`172.` | `20.` | `1.` | `1` | 十进制


#### 组成

IP 地址由网络和主机两部分标识组成，如下图，网络标识在数据链路的每个段配置不同的值。网络标识必须保证相互连接的每个段的地址不相重复。而相同段内相连的主机必须有相同的网络地址。IP 地址的“主机标识”则不允许在同一个网段内重复出现。由此，可以通过设置网络地址和主机地址，在相互连接的整个网络中保证每台主机的 IP 地址都不会相互重叠。即 IP 地址具有了唯一性。

![](https://gitee.com/heptaluan/backups/raw/master/cdn/http/14-11.png)

IP 包被转发到途中某个路由器时，正是利用目标 IP 地址的网络标识进行路由。因为即使不看主机标识，只要一见到网络标识就能判断出是否为该网段内的主机。

![](https://gitee.com/heptaluan/backups/raw/master/cdn/http/14-12.png)


#### 分类

IP 地址分为四个级别，分别为A类、B类、C类、D类。它根据 IP 地址中从第 1 位到第 4 位的比特列对其网络标识和主机标识进行区分。

* A 类地址
  * A 类 IP 地址是首位以 “0” 开头的地址。从第 1 位到第 8 位是它的网络标识。用十进制表示的话，0.0.0.0~127.0.0.0 是 A 类的网络地址。A 类地址的后 24 位相当于主机标识。因此，一个网段内可容纳的主机地址上限为16,777,214个。
* B 类地址
  * B 类 IP 地址是前两位 “10” 的地址。从第 1 位到第 16 位是它的网络标识。用十进制表示的话，128.0.0.0~191.255.0.0 是 B 类的网络地址。B 类地址的后 16 位相当于主机标识。因此，一个网段内可容纳的主机地址上限为65,534个。
* C 类地址
  * C 类 IP 地址是前三位为 “110” 的地址。从第 1 位到第 24 位是它的网络标识。用十进制表示的话，192.0.0.0~223.255.255.0 是 C 类的网络地址。C 类地址的后 8 位相当于主机标识。因此，一个网段内可容纳的主机地址上限为254个。
* D 类地址
  * D 类 IP 地址是前四位为 “1110” 的地址。从第 1 位到第 32 位是它的网络标识。用十进制表示的话，224.0.0.0~239.255.255.255 是 D 类的网络地址。D 类地址没有主机标识，常用于多播。

在分配 IP 地址时关于主机标识有一点需要注意。即要用比特位表示主机地址时，不可以全部为 0 或全部为 1。因为全部为 0 只有在表示对应的网络地址或 IP 地址不可以获知的情况下才使用。而全部为 1 的主机通常作为广播地址。因此，在分配过程中，应该去掉这两种情况。这也是为什么 C 类地址每个网段最多只能有 254（ 28 - 2 = 254）个主机地址的原因。



#### 广播地址

* 广播地址用于在同一个链路中相互连接的主机之间发送数据包。将 IP 地址中的主机地址部分全部设置为 1，就成了广播地址。
* 广播分为本地广播和直接广播两种。在本网络内的广播叫做本地广播；在不同网络之间的广播叫做直接广播。


#### IP 多播

* 多播用于将包发送给特定组内的所有主机。由于其直接使用 IP 地址，因此也不存在可靠传输。
* 相比于广播，多播既可以穿透路由器，又可以实现只给那些必要的组发送数据包。

![](https://gitee.com/heptaluan/backups/raw/master/cdn/http/14-13.png)

多播使用 D 类地址。因此，如果从首位开始到第 4 位是 “1110”，就可以认为是多播地址。而剩下的 28 位可以成为多播的组编号。

此外， 对于多播，所有的主机（路由器以外的主机和终端主机）必须属于 224.0.0.1 的组，所有的路由器必须属于 224.0.0.2 的组。


#### 子网掩码

一个IP地址只要确定了其分类，也就确定了它的网络标识和主机标识。例如A类地址前8位(除首位“0"还有7位)、B类地址前16位(除首位“10”还有14位)、C类地址前24位(除首位“110"还有21位)分别是它们各自的网络标识部分。

但是直接使用A类或B类地址，确实有些浪费。随着互联网的覆盖范围逐渐增大，网络地址会越来越不足以应对需求，直接使用A类、B类、C类地址就更加显得浪费资源。为此，人们已经开始- -种新的组合方式以减少这种浪费。

而现在，一个 IP 地址的网络标识和主机标识已不再受限于该地址的类别，而是由一个叫做“子网掩码”的识别码通过子网网络地址细分出比 A 类、B 类、C 类更小粒度的网络。这种方式实际上就是将原来 A 类、B 类、C 类等分类中的主机地址部分用作子网地址，可以将原网络分为多个物理网络的一种机制。

子网掩码用二进制方式表示的话，也是一个 32 位的数字。它对应 IP 地址网络标识部分的位全部为 “1”，对应 IP 地址主机标识的部分则全部为 “0”。由此，一个 IP 地址可以不再受限于自己的类别，而是可以用这样的子网掩码自由地定位自己的网络标识长度。当然，子网掩码必须是 IP 地址的首位开始连续的 “1”。

对于子网掩码，目前有两种表示方式。第一种是，将 IP 地址与子网掩码的地址分别用两行来表示。以 172.20.100.52 的前 26 位是网络地址的情况为例，如下：

 | | | | 
-|-|-|-|-
IP 地址 | 172. | 20. | 100. | 52
子网掩码 | 255. | 255. | 255. | 192
网络地址 | 172. | 20. | 100. | 0
子网掩码 | 255. | 255. | 255. | 192
广播地址 | 172. | 20. | 100. | 63
子网掩码 | 255. | 255. | 255. | 192

第二种表示方式是，在每个 IP 地址后面追加网络地址的位数用 “/ ” 隔开，如下：

 | | | | | 
-|-|-|-|-|-
IP 地址 |	`172.` | `20.` | `100.` |	`52`	| `/26`
网络地址 |	`172.` | `20.` | `100.` |	`0 ` | `/26`
广播地址 |	`172.` | `20.` | `100.` |	`63`	| `/26`


## 路由控制

发送数据包时所使用的地址是网络层的地址，即 IP 地址。然而仅仅有 IP 地址还不足以实现将数据包发送到对端目标地址，在数据发送过程中还需要类似于“指明路由器或主机”的信息，以便真正发往目标地址。保存这种信息的就是路由控制表。

该路由控制表的形成方式有两种：一种是管理员手动设置，另一种是路由器与其他路由器相互交换信息时自动刷新。前者也叫做静态路由控制，而后者叫做动态路由控制。

IP 协议始终认为路由表是正确的。然后，IP 本身并没有定义制作路由控制表的协议。即 IP 没有制作路由控制表的机制。该表示由一个叫做“路由协议”的协议制作而成。


#### IP 地址与路由控制

IP 地址的网络地址部分用于进行路由控制。
路由控制表中记录着网络地址与下一步应该发送至路由器的地址。
在发送 IP 包时，首先要确定 IP 包首部中的目标地址，再从路由控制表中找到与该地址具有相同网络地址的记录，根据该记录将 IP 包转发给相应的下一个路由器。如果路由控制表中存在多条相同网络地址的记录，就选择一个最为吻合的网络地址。

![](https://gitee.com/heptaluan/backups/raw/master/cdn/http/14-14.png)

* 默认路由
  * 如果- -张路由表中包含所有的网络及其子网的信息，将会造成无端的浪费。这时，默认路由(Default Route)是不错的选择。默认路由是指路由表中任何一个地址都能与之匹配的记录。
  * 默认路由一般标记为0.0.0. 0/0或default"。这里的0. 0.0.0/0并不是指IP地址是0.0.0.0。由于后面是“/0”， 所以并没有标识IP地址"。它只是为了避免人们误以为0.0.0.0是IP地址。有时默认路由也被标记为default,但是在计算机内部和路由协议的发送过程中还是以0.0.0. 0/0进行处理。
* 主机路由
  * “IP地址/32”也被称为主机路由( Host Route)。例如，192. 168. 153. 15/32"就是一种主机路由。它的意思是整个IP地址的所有位都将参与路由。进行主机路由，意昧着要基于主机上网卡上配置的IP地址本身，而不是基于该地址的网络地址部分进行路由。
  * 主机路由多被用于不希望通过网络地址路由的情况"。
* 环回地址
  * 环回地址是在同- -台计算机上的程序之间进行网络通信时所使用的一个默认地址。计算机使用一个特殊的IP地址127. 0.0. 1作为环回地址。与该地址具有相同意义的是一个叫做localhost的主机名。使用这个IP或主机名时，数据包不会流向网络。



#### IP 报文的分片与重组

* 每种数据链路的最大传输单元（MTU）都不尽相同，因为每个不同类型的数据链路的使用目的不同。使用目的不同，可承载的 MTU 也就不同。
* 任何一台主机都有必要对 IP 分片进行相应的处理。分片往往在网络上遇到比较大的报文无法一下子发送出去时才会进行处理。
* 经过分片之后的 IP 数据报在被重组的时候，只能由目标主机进行。路由器虽然做分片但不会进行重组。


#### 路径 MTU 发现

* 分片机制也有它的不足。如路由器的处理负荷加重之类。因此，只要允许，是不希望由路由器进行 IP 数据包的分片处理的。
* 为了应对分片机制的不足，“路径 MTU 发现” 技术应运而生。路径 MTU 指的是，从发送端主机到接收端主机之间不需要分片是最大 MTU 的大小。即路径中存在的所有数据链路中最小的 MTU 。
* 进行路径 MTU 发现，就可以避免在中途的路由器上进行分片处理，也可以在 TCP 中发送更大的包。


## IPv6

IPv6（IP version 6）是为了根本解决 IPv4 地址耗尽的问题而被标准化的网际协议。IPv4 的地址长度为 4 个 8 位字节，即 32 比特。而 IPv6 的地址长度则是原来的 4 倍，即 128 比特，一般写成 8 个 16 位字节。

#### IPv6 的特点

* IP 得知的扩大与路由控制表的聚合。
* 性能提升。包首部长度采用固定的值（40字节），不再采用首部检验码。简化首部结构，减轻路由器负担。路由器不再做分片处理。
* 支持即插即用功能。即使没有DHCP服务器也可以实现自动分配 IP 地址。
* 采用认证与加密功能。应对伪造 IP 地址的网络安全功能以及防止线路窃听的功能。
* 多播、Mobile IP 成为扩展功能。

####  IPv6 中 IP 地址的标记方法

* 一般人们将 128 比特 IP 地址以每 16 比特为一组，每组用冒号（“：”）隔开进行标记。
* 而且如果出现连续的 0 时还可以将这些 0 省略，并用两个冒号（“：：”）隔开。但是，一个 IP 地址中只允许出现一次两个连续的冒号。


#### IPv6 地址的结构

* IPv6 类似 IPv4，也是通过 IP 地址的前几位标识 IP 地址的种类。
* 在互联网通信中，使用一种全局的单播地址。它是互联网中唯一的一个地址，不需要正式分配 IP 地址。

未定义 | 0000 ... 0000（128比特） | ：：/ 128
环回地址 | 0000 ... 0001（128比特） | ：：1 / 128
唯一本地地址 | 1111 110 | FC00：/ 7
链路本地单播地址 | 1111 1110 10 | FE80：：/ 10
多播地址 | 1111 1111 | FF00：：/ 8
全局单播地址 | （其他） | 


#### 全局单播地址

* 全局单播地址是指世界上唯一的一个地址。它是互联网通信以及各个域内部通信中最为常用的一个 IPv6 地址。
* 格式如下图所示，现在 IPv6 的网络中所使用的格式为，n = 48，m = 16 以及 128 - n - m = 64。即前 64 比特为网络标识，后 64 比特为主机标识。

![](https://gitee.com/heptaluan/backups/raw/master/cdn/http/14-15.png)


#### 链路本地单播地址

链路本地单播地址是指在同一个数据链路内唯一的地址。它用于不经过路由器，在同一个链路中的通信。通常接口 ID 保存 64 比特版的 MAC 地址。

![](https://gitee.com/heptaluan/backups/raw/master/cdn/http/14-16.png)



#### 唯一本地地址

唯一本地地址是不进行互联网通信时所用的地址。
唯一本地地址虽然不会与互联网连接，但是也会尽可能地随机生成一个唯一的全局 ID。
L 通常被置为 1
全局 ID 的值随机决定
子网 ID 是指该域子网地址
接口 ID 即为接口的 ID

![](https://gitee.com/heptaluan/backups/raw/master/cdn/http/14-17.png)




#### IPv6 分段处理

* IPv6 的分片处理只在作为起点的发送端主机上进行，路由器不参与分片。
* IPv6 中最小 MTU 为 1280 字节，因此，在嵌入式系统中对于那些有一定系统资源限制的设备来说，不需要进行“路径 MTU 发现”，而是在发送 IP 包时直接以 1280 字节为单位分片送出。






## IPv4首部

通过IP进行通信时，需要在数据的前面加入IP首部信息。IP首部中包含着用于IP协议进行发包控制时所有的必要信息。了解IP首部的结构，也就能够对IP所提供的功能有一个详细的把握。

![](https://gitee.com/heptaluan/backups/raw/master/cdn/http/14-19.png)

* 版本(Version)
  * 由4比特构成，表示标识IP首部的版本号。IPv4 的版本号即为4,因此在这个字段上的值也是“4”。

* 图首部长度(IHL: Internet Header Length)
  * 由4比特构成，表明IP首部的大小，单位为4字节(32 比特)。对于没有可选项的IP包，首部长度则设置为“5”。 也就是说，当没有可选项时，IP 首部的长度为20字节(4x5 =20)。

* 区分服务(TOS: Type Of Service)
  * 由8比特构成，用来表明服务质量。每一位的具体含义如下

比特 | 含义
-|-
`0 1 2` | 优先度
`3` | 最低延迟
`4` | 最大吞吐
`5` | 最大可靠性
`6` | 最小代价
（`3 ~ 6`） | 最大安全
`7` | 未定义





## IP 协议相关技术

IP 旨在让最终目标主机收到数据包，但是在这一过程中仅仅有 IP 是无法实现通信的。必须还有能够解析主机名称和 MAC 地址的功能，以及数据包在发送过程中异常情况处理的功能。


#### DNS

* 我们平常在访问某个网站时不适用 IP 地址，而是用一串由罗马字和点号组成的字符串。而一般用户在使用 TCP/IP 进行通信时也不使用 IP 地址。能够这样做是因为有了 DNS （Domain Name System）功能的支持。DNS 可以将那串字符串自动转换为具体的 IP 地址。

* 这种 DNS 不仅适用于 IPv4，还适用于 IPv6。


#### ARP

* 只要确定了 IP 地址，就可以向这个目标地址发送 IP 数据报。然而，在底层数据链路层，进行实际通信时却有必要了解每个 IP 地址所对应的 MAC 地址。
* ARP 是一种解决地址问题的协议。以目标 IP 地址为线索，用来定位下一个应该接收数据分包的网络设备对应的 MAC 地址。不过 ARP 只适用于 IPv4，不能用于 IPv6。IPv6 中可以用 ICMPv6 替代 ARP 发送邻居探索消息。
* RARP 是将 ARP 反过来，从 MAC 地址定位 IP 地址的一种协议。



#### ICMP

* ICMP 的主要功能包括，确认 IP 包是否成功送达目标地址，通知在发送过程当中 IP 包被废弃的具体原因，改善网络设置等。
* IPv4 中 ICMP 仅作为一个辅助作用支持 IPv4。也就是说，在 IPv4 时期，即使没有 ICMP，仍然可以实现 IP 通信。然而，在 IPv6 中，ICMP 的作用被扩大，如果没有 ICMPv6，IPv6 就无法进行正常通信。


#### DHCP

* 如果逐一为每一台主机设置 IP 地址会是非常繁琐的事情。特别是在移动使用笔记本电脑、只能终端以及平板电脑等设备时，每移动到一个新的地方，都要重新设置 IP 地址。
* 于是，为了实现自动设置 IP 地址、统一管理 IP 地址分配，就产生了 DHCP（Dynamic Host Configuration Protocol）协议。有了 DHCP，计算机只要连接到网络，就可以进行 TCP/IP 通信。也就是说，DHCP 让即插即用变得可能。
* DHCP 不仅在 IPv4 中，在 IPv6 中也可以使用。



#### NAT

* NAT（Network Address Translator）是用于在本地网络中使用私有地址，在连接互联网时转而使用全局 IP 地址的技术。
* 除转换 IP 地址外，还出现了可以转换 TCP、UDP 端口号的 NAPT（Network Address Ports Translator）技术，由此可以实现用一个全局 IP 地址与多个主机的通信。
* NAT（NAPT）实际上是为正在面临地址枯竭的 IPv4 而开发的技术。不过，在 IPv6 中为了提高网络安全也在使用 NAT，在 IPv4 和 IPv6 之间的相互通信当中常常使用 NAT-PT。




#### IP 隧道

![](https://gitee.com/heptaluan/backups/raw/master/cdn/http/14-18.png)

* 如上图的网络环境中，网络 A 与网络 B 之间无法直接进行通信，为了让它们之间正常通信，这时必须得采用 IP 隧道的功能。
* IP 隧道可以将那些从网络 A 发过来的 IPv6 的包统合为一个数据，再为之追加一个 IPv4 的首部以后转发给网络 C。
* 一般情况下，紧接着 IP 首部的是 TCP 或 UDP 的首部。然而，现在的应用当中“ IP 首部的后面还是 IP 首部”或者“ IP 首部的后面是 IPv6 的首部”等情况与日俱增。这种在网络层的首部后面追加网络层首部的通信方法就叫做“ IP 隧道”。






<!-- ## IP 数据报格式

![](https://gitee.com/heptaluan/backups/raw/master/cdn/http/14-01.png)

IP数据报首部可以分为固定长度（20字节）和可选长度。固定长度是所有IP数据报所必须的。固定部分个字段的意义如下

* 版本： 占4位，指IP协议的版本，通信双方的协议版本必须一致。
* 首部长度： 占4位，可表示的最大十进制数是15（1111）。它的单位是4字节（也就是32位），因此首部长度最小值为5（固定长度部分），可选长度最长为40字节。
* 区分服务： 占8位，用来获得更好的服务。
* 总长度： 占16位，首部和数据部分的总长度，单位为字节。因此IP数据报的最大长度为2^16-1。
* 标识： 占16位。当数据报的长度超过网络的最大传送单元使，就给该数据报的所有分片赋值相同的标识，相同的标识字段的值使分片后的各数据报片能正确的重装成原来的数据报。
* 标志： 占3位，但是只有两位具有意义。
  * 标记字段中的最低位记为MF。MF=1表示后面还有分片，MF=0表示这是最后一个分片。
  * 标志字段中间的一位记为DF，意思是能否分片，只有DF=0时才能分片。
* 片偏移： 占13位。片偏移指出：较长的分组在分片后，某片在原分组中的相对位置。也就是说，数据片相对于初始位置的距离。单位是8字节。因此，除去最后一个数据片，每个数据片的长度都是8字节的倍数。
* 生存时间： 占8位，TTL（Time To Live），单位为跳数，跳数表明该数据报至多能在互联网中经过多少个路由器，每经过一个路由器就减1。
* 协议： 占8位，协议字段指出该数据报携带的数据是使用哪种协议，以便使目的主机的IP层知道应将数据部分上交给哪个协议进行处理。

协议名 |	ICMP |	IGMP |	IP |	TCP |	EGP |	IGP |	UDP |	IPv6 |	ESP |	OSPF
-|-|-|-|-|-|-|-|-|-|-
协议字段值 |	1 |	2 |	4 |	6 |	8 |	9 |	17 |	41 |	50 |	89 |

* 源地址： 占32位。
* 目的地址： 占32位。
* 首部校验和： 占16位，这个字段只检验数据报的首部，但是不包括数据部分。
  * 在发送方，先把数据报划分为许多16位的字的序列，并把校验和字段置为0，。
  * 用反码算术运算（从低位到高位计算，0+0等于0,0+1等于1,1+1等于0，但是要进1。）把所有的16位字相加后，将得到的反码写入校验和字段。
  * 接收方接收到数据报之后，将首部的所有16位字再使用反码运算相加一次，将得到的和取反码，即得出接收方的检验和的计算结果。如果结果全为0，则代表首部未发生变化，保留该数据报，反之则丢弃。

![](https://gitee.com/heptaluan/backups/raw/master/cdn/http/14-02.png)



## UDP数据报格式

UDP用户数据报分为 = 首部字段 （8个字节，4个字段，每个字段2个字节）+ 数字字段。

首部字段：
* 源端口： 源端口号。在需要对方回信的时候选用，不需要填0。
* 目的端口： 目的端口号。必填。
* 长度： UDP用户数据报的长度。最小为8。
* 检验和：检测UDP用户数据报传输过程中是否有错。有错就丢弃。

![](https://gitee.com/heptaluan/backups/raw/master/cdn/http/14-03.png)



## TCP报文段格式

TCP虽然是面向字节流的，但是TCP传输的数据单元却是报文段。一个报文段可以分为首部和数据两部分。

TCP报文段的首部的前20个字节是固定的，后面的4n字节是需要增加的选项。因此TCP首部的最小长度是20字节。

![](https://gitee.com/heptaluan/backups/raw/master/cdn/http/14-04.png)


首部部分字段的意义如下

* 源端口和目的端口：各占2个字节，分别写入源端口号和目的端口号。TCP的分用功能也是通过端口号实现的。
* 序号：占4字节。在TCP连接中传送的字节流中的每一个字节都按照顺序编号。首部中的序号字段值则代表本报文段所发送的数据的第一个字节的序号。
* 确认号：占4字节。代表期望收到对方下一个报文段的第一个数据字节的序号。需要注意：若确认号=N，则表明：到序号N-1为止的所有数据都已正确收到
* 数据偏移：占4位。他指出TCP报文段的数据起始处距离TCP报文段的起始处有多远。一般情况下为20字节，但是首部中还有不确定的选项字段。它的单位是4字节，而它的最大值是15，因此数据偏移最大值为60字节，也就是说选项不能超过40字节。
* 保留：占6位。以防后续使用。

下面是6个控制位，每个占一位：
* 紧急URG：当URG=1时，表明紧急字段有效，它告诉系统此报文中有紧急数据，应该尽快传送。
* 确认ACK：仅当ACK=1时确认号字段才有效。
* 推送PSH：当两个应用进程进行交互式的通信时，有时一端的应用进程希望在键入一个命令后立即就能收到对方的相应，这时设置PSH=1。
* 复位RST：当RST=1时，表明TCP连接中出现严重错误，必须释放连接，再重新建立运输连接。RST=1还可以用来拒绝一个非法的报文段或拒绝打开一个连接。
* 同步SYN：在建立连接时用来同步序号。当SYN=1，ACK=0时代表是连接请求报文段。若对方同意建立连接，则应在相应报文段中使SYN=1，ACK=1。也就是说，SYN=1代表连接请求或者连接接受报文。
* 终止FIN。用于释放一个连接。当FIN=1时，代表此报文段的发送方的数据已发送完毕，并且请求释放运输连接。

控制位到这结束。

* 窗口：占2字节。窗口值告诉对方：从本报文段中的确认号算起，接收方目前允许对方发送的数据量（以字节为单位）。之所以设置这个限制，是因为接收方的数据缓存空间是有限的。总之，窗口值作为接收方让发送方设置其窗口大小的依据。
* 检验和：占2字节。检验的范围包括首部字段和数据字段。和UDP检验的方法一样，只不过把伪首部第四个字段的17改成6.
* 紧急指针：占2字节。只有在紧急URG=1时才有效，它指出本报文段中的紧急数据的字节数。
* 选项：长度可变，最大40字节，注意，TCP最初只规定了一种选项，即最大报文长度MSS。MSS是每一个TCP报文段中的数据字段的最大长度，而并不是整个TCP报文段的长度。

## 以太网MAC帧格式

![](https://gitee.com/heptaluan/backups/raw/master/cdn/http/14-05.png)

以太网MAC帧较为简单，由五个字段组成，前两个字段分别为6字节长的目的地址和源地址。第三个字段是2字节的类型字段，用来标志上一层使用的是什么协议，以便把收到的MAC帧的数据上交给上一层的这个协议。第四个字段是数据字段，其长度为46~1500字节（46字节是因为最小长度64字节减去18字节的首部和尾部）。最后一个字段是4字节的帧检测序列FCS（使用CRC检测）。 -->