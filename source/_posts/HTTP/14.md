---
title: TCP/IP 协议
date: 2020-09-20
categories: HTTP
tags: HTTP
toc: true
thumbnail: https://gitee.com/heptaluan/backups/raw/master/cdn/cover/14.jpg
---

在之前的章节当中，我们梳理了 [HTTP 协议](https://heptaluan.github.io/2020/09/01/HTTP/10/)，[HTTPS](https://heptaluan.github.io/2020/08/09/HTTP/09/)，[HTTP/2](https://heptaluan.github.io/2020/09/06/HTTP/11/) 和 [HTTP/3](https://heptaluan.github.io/2020/09/12/HTTP/12/) 的一些相关内容，本章我们再来看看姑且算是最后一部分内容，也算是补充部分的 `TCP/IP` 协议相关内容，这部分内容主要参考的是 [图解 TCP/IP](https://book.douban.com/subject/24737674/)

但是在本章当中关于 `TCP/IP` 协议的相关内容不会像 `HTTP` 协议那样梳理的十分细致，因为关于这部分的内容在工作之中接触有限，所以在这里简单记录一下也就当做是扩展知识了

<!--more-->



## 协议

`TCP/IP` 是通信协议的统称，不过在此之前，我们有必要先来理清协议的概念，在计算机网络与信息通信领城里，人们经常提及协议一词，互联网中常用的具有代表性的协议有 `IP`、`TCP`、 `HTTP` 等，而 `LAN`（局域网）中常用的协议有 `IPX/SPX` 等，计算机网络体系结构将这些网络协议进行了系统的归纳，`TCP/IP` 就是 `IP`、`TCP`、`HTTP` 等协议的集合

网絡体系结构 | 协议 | 主要用途
-|-|-
`TCP/IP` | `IP/ICMP/TCP/UDP/HTTP/TELNET/SNMP/SMTP` 等 | 互联网、局城网
`IPX/SPX`（`NetWare`） | `IPX/SPX/NPC` 等 | 个人电脑局域网
`AplcTalk` | `DDP/RTMP/AEP/ATP/ZIP` 等 | 苹果公司现有产品的局城网
`DECnet` | `DPR/NSP/SCP` 等 | 前 `DEC` 小型机
`OSI` | `FTAM/MOTIS/VT/CMIS/CMIP,CLNP/CONP` | -
`XNS` | `IDP/SPP/PEP` 等 | 施乐公司网络


#### 协议的必要性

简单来说，协议就是计算机与计算机之间通过网络实现通信时事先达成的一种约定，这种约定使那些由不同厂商的设备、不同的 `CPU` 以及不同的操作系统组成的计算机之间，只要遵循相同的协议就能够实现通信，反之如果所使用的协议不同，就无法实现通信，但是在计算机通信诞生之初，系统化与标准化并未得到足够的重视，每家计算机厂商都出产各自的网络产品来实现计算机通信，对于协议的系统化、分层化等事宜没有特别强烈的意识

为了解决上述问题，`ISO` 制定了一个国际标准 `OSI`，对通信系统进行了标准化，现在 `OSI` 所定义的协议虽然并没有得到普及，但是在 `OSI` 协议设计之初作为其指导方针的 `OSI` 参考模型却常被用于网络协议的制定当中

但是我们在本章当中介绍的 `TCP/IP` 并非 `ISO` 所制定的某种国际标准，而是由 `IETF` 所建议的、致力于推进其标准化作业的一种协议，在当时大学等研究机构和计算机行业作为中心力量，推动了 `TCP/IP` 的标准化进程，`TCP/IP` 作为互联网之上的一种标准，也作为业界标准，俨然已成为全世界所广泛应用的通信协议，那些础知识支持互联网的设备及软件，也正着力遵循由 `IETF` 标准化的 `TCP/IP` 协议

协议得以标准化也使所有遵循标准协议的设备不再因计算机硬件或操作系统的差异而无法通信，因此协议的标准化也推动了计算机网络的普及


## OSI 参考模型

`IS0` 在制定标准化 `OSI` 之前，对网络体系结构相关的问题进行了充分的讨论，最终提出了作为通信协议设计指标的 `OSI` 参考模型，这一模型将通信协议中必要的功能分成了七层，通过这些分层，使得那些比较复杂的网络协议更加简单化，在这一模型中，每个分层都接收由它下一层所提供的特定服务，并且负责为自己的上一层提供特定的服务

* 上下层之间进行交互时所遵循的约定叫做接口
* 同一层之间的交互所遵循的约定叫做协议

协议分层就如同计算机软件中的模块化开发，`OSI` 参考模型的建议是比较理想化的，它希望实现从第一层到第七层的所有模块，并将它们组合起来实现网络通信，分层可以将每个分层独立使用，即使系统中某些分层发生变化，也不会波及整个系统，因此可以构造一个扩展性和灵活性都较强的系统

* 此外通过层能够细分通信功能，更易于单独实现每个分层的协议，并界定各个分层的具体责任和义务，这些都属于分层的优点
* 而分层的劣势，可能就在于过分模块化、使处理变得更加沉重以及每个模块都不得不实现相似的处理:逻辑等问题


#### OSI 参考模型

如下图所示

![](https://gitee.com/heptaluan/backups/raw/master/cdn/http/14-06.png)

不过，`OSI` 参考模型终究只是一个模型，它也只是对各层的作用做了一系列粗略的界定，并没有对协议和接口进行详细的定义，它对学习和设计协议只能起到一个引导的作用，许多通信协议，都对应了  `OSI` 参考模型七个分层中的某层，通过这一点，可以大致了解该协议在整个通信功能中的位置和作用

> 这里需要区分开来 `OSI` 协议与 `OSI` 参考模型

* `OSI` 协议是为了让异构的计算机之间能够相互通信的、由 `ISO` 和 `ITU-T` 推进其标准化的一种网絡体系结构，`OST`（参考模型）将通信功能划分为七个分层，称作 `OSI` 参考模型
* 而 `OSI` 协议以 `OSI` 参考模型为基础界定了每个阶层的协议和每个阶层之间接口相关的标准，遵循 `OSI` 协议的产品叫 `OSI` 产品，而它们所遵循的通信则被称为 `OSI` 通信



## TCP/IP 基础

从字面意义上讲，有人可能会认为 `TCP/IP` 是指 `TCP` 和 `IP` 两种协议，实际生活当中有时也确实就是指这两种协议，然而在很多情况下，它只是利用 `IP` 进行通信时所必须用到的协议群的统称，具体来说，`IP` 或 `ICMP`、`TCP` 或 `UDP`、`TELNET` 或 `FTP`、以及 `HTTP` 等都属于 `TCP/IP` 协议，他们与 `TCP` 或 `IP` 的关系紧密，是互联网必不可少的组成部分，`TCP/IP` 一词泛指这些协议

因此，有时也称 `TCP/IP` 为网际协议群，互联网进行通信时，需要相应的网络协议，`TCP/IP` 原本就是为使用互联网而开发制定的协议族，因此互联网的协议就是 `TCP/IP`，`TCP/IP` 就是互联网的协议

![](https://gitee.com/heptaluan/backups/raw/master/cdn/http/14-07.png)




## TCP/IP协议分层模型

![](https://gitee.com/heptaluan/backups/raw/master/cdn/http/14-08.png)

不难看出，`TCP/IP` 与 `OSI` 在分层模块上稍有区别，`OSI` 参考模型注重 **通信协议必要的功能是什么**，而 `TCP/IP` 则更强调 **在计算机上实现协议应该开发哪种程序**




## 数据包

包、帧、数据包、段、消息以上五个术语都用来表述数据的单位，大致区分如下

* 包可以说是全能性术语
* 帧用于表示数据链路层中包的单位
* 数据包是 `IP` 和 `UDP` 等网络层以上的分层中包的单位
* 段则表示 `TCP` 数据流中的信息
* 消息是指应用协议中数据的单位

![](https://gitee.com/heptaluan/backups/raw/master/cdn/http/14-09.png)

每个分层中，都会对所发送的数据附加一个首部，在这个首部中包含了该层必要的信息，如发送的目标地址以及协议相关信息，通常为协议提供的信息为包首部，所要发送的内容为数据，如上图，在下一层的角度看，从上一分层收到的包全部都被认为是本层的数据

网络中传输的数据包由两部分组成

* 一部分是协议所要用到的首部
* 另一部分是上一层传过来的数据

首部的结构由协议的具体规范详细定义，在数据包的首部，明确标明了协议应该如何读取数据，反过来说，看到首部也就能够了解该协议必要的信息以及所要处理的数据，**包首部就像协议的脸**




## 数据处理流程

我们以一个发送邮件的流程为例，如下图

![](https://gitee.com/heptaluan/backups/raw/master/cdn/http/14-10.png)

1. 应用程序处理首先应用程序会进行编码处理，这些编码相当于 `OSI` 的表示层功能，编码转化后邮件不一定马上被发送出去，这种何时建立通信连接何时发送数据的管理功能，相当于 `OSI` 的会话层功能
2. `TCP` 模块的处理，`TCP` 根据应用的指示，负责建立连接、发送数据以及断开连接，`TCP` 提供将应用层发来的数据顺利发送至对端的可靠传输，为了实现这一功能，需要在应用层数据的前端附加一个 `TCP` 首部
3. `IP` 模块的处理，`IP` 将 `TCP` 传过来的 `TCP` 首部和 `TCP` 数据合起来当做自己的数据，并在 `TCP` 首部的前端加上自己的 `IP` 首部，`IP` 包生成后，参考路由控制表决定接受此 `IP` 包的路由或主机
4. 网络接口（以太网驱动）的处理从 `IP` 传过来的 `IP` 包对于以太网来说就是数据，给这些数据附加上以太网首部并进行发送处理，生成的以太网数据包将通过物理层传输给接收端
5. 网络接口（以太网驱动）的处理主机收到以太网包后，首先从以太网包首部找到 `MAC` 地址判断是否为发送给自己的包，若不是则丢弃数据，如果是发送给自己的包，则从以太网包首部中的类型确定数据类型，再传给相应的模块，如 `IP`、`ARP` 等，这里的例子则是 `IP` 
6. `IP` 模块的处理`IP` 模块接收到 数据后也做类似的处理，从包首部中判断此 `IP` 地址是否与自己的 `IP` 地址匹配，如果匹配则根据首部的协议类型将数据发送给对应的模块，如 `TCP`、`UDP`，这里的例子则是 `TCP`，另外对于有路由器的情况，接收端地址往往不是自己的地址，此时需要借助路由控制表，在调查应该送往的主机或路由器之后再进行转发数据
7. `TCP` 模块的处理在 `TCP` 模块中，首先会计算一下校验和，判断数据是否被破坏，然后检查是否在按照序号接收数据，最后检查端口号，确定具体的应用程序，数据被完整地接收以后，会传给由端口号识别的应用程序
8. 应用程序的处理接收端应用程序会直接接收发送端发送的数据，通过解析数据，展示相应的内容




<!-- ## IP 数据报格式

![](https://gitee.com/heptaluan/backups/raw/master/cdn/http/14-01.png)

IP数据报首部可以分为固定长度（20字节）和可选长度。固定长度是所有IP数据报所必须的。固定部分个字段的意义如下

* 版本： 占4位，指IP协议的版本，通信双方的协议版本必须一致。
* 首部长度： 占4位，可表示的最大十进制数是15（1111）。它的单位是4字节（也就是32位），因此首部长度最小值为5（固定长度部分），可选长度最长为40字节。
* 区分服务： 占8位，用来获得更好的服务。
* 总长度： 占16位，首部和数据部分的总长度，单位为字节。因此IP数据报的最大长度为2^16-1。
* 标识： 占16位。当数据报的长度超过网络的最大传送单元使，就给该数据报的所有分片赋值相同的标识，相同的标识字段的值使分片后的各数据报片能正确的重装成原来的数据报。
* 标志： 占3位，但是只有两位具有意义。
  * 标记字段中的最低位记为MF。MF=1表示后面还有分片，MF=0表示这是最后一个分片。
  * 标志字段中间的一位记为DF，意思是能否分片，只有DF=0时才能分片。
* 片偏移： 占13位。片偏移指出：较长的分组在分片后，某片在原分组中的相对位置。也就是说，数据片相对于初始位置的距离。单位是8字节。因此，除去最后一个数据片，每个数据片的长度都是8字节的倍数。
* 生存时间： 占8位，TTL（Time To Live），单位为跳数，跳数表明该数据报至多能在互联网中经过多少个路由器，每经过一个路由器就减1。
* 协议： 占8位，协议字段指出该数据报携带的数据是使用哪种协议，以便使目的主机的IP层知道应将数据部分上交给哪个协议进行处理。

协议名 |	ICMP |	IGMP |	IP |	TCP |	EGP |	IGP |	UDP |	IPv6 |	ESP |	OSPF
-|-|-|-|-|-|-|-|-|-|-
协议字段值 |	1 |	2 |	4 |	6 |	8 |	9 |	17 |	41 |	50 |	89 |

* 源地址： 占32位。
* 目的地址： 占32位。
* 首部校验和： 占16位，这个字段只检验数据报的首部，但是不包括数据部分。
  * 在发送方，先把数据报划分为许多16位的字的序列，并把校验和字段置为0，。
  * 用反码算术运算（从低位到高位计算，0+0等于0,0+1等于1,1+1等于0，但是要进1。）把所有的16位字相加后，将得到的反码写入校验和字段。
  * 接收方接收到数据报之后，将首部的所有16位字再使用反码运算相加一次，将得到的和取反码，即得出接收方的检验和的计算结果。如果结果全为0，则代表首部未发生变化，保留该数据报，反之则丢弃。

![](https://gitee.com/heptaluan/backups/raw/master/cdn/http/14-02.png)



## UDP数据报格式

UDP用户数据报分为 = 首部字段 （8个字节，4个字段，每个字段2个字节）+ 数字字段。

首部字段：
* 源端口： 源端口号。在需要对方回信的时候选用，不需要填0。
* 目的端口： 目的端口号。必填。
* 长度： UDP用户数据报的长度。最小为8。
* 检验和：检测UDP用户数据报传输过程中是否有错。有错就丢弃。

![](https://gitee.com/heptaluan/backups/raw/master/cdn/http/14-03.png)



## TCP报文段格式

TCP虽然是面向字节流的，但是TCP传输的数据单元却是报文段。一个报文段可以分为首部和数据两部分。

TCP报文段的首部的前20个字节是固定的，后面的4n字节是需要增加的选项。因此TCP首部的最小长度是20字节。

![](https://gitee.com/heptaluan/backups/raw/master/cdn/http/14-04.png)


首部部分字段的意义如下

* 源端口和目的端口：各占2个字节，分别写入源端口号和目的端口号。TCP的分用功能也是通过端口号实现的。
* 序号：占4字节。在TCP连接中传送的字节流中的每一个字节都按照顺序编号。首部中的序号字段值则代表本报文段所发送的数据的第一个字节的序号。
* 确认号：占4字节。代表期望收到对方下一个报文段的第一个数据字节的序号。需要注意：若确认号=N，则表明：到序号N-1为止的所有数据都已正确收到
* 数据偏移：占4位。他指出TCP报文段的数据起始处距离TCP报文段的起始处有多远。一般情况下为20字节，但是首部中还有不确定的选项字段。它的单位是4字节，而它的最大值是15，因此数据偏移最大值为60字节，也就是说选项不能超过40字节。
* 保留：占6位。以防后续使用。

下面是6个控制位，每个占一位：
* 紧急URG：当URG=1时，表明紧急字段有效，它告诉系统此报文中有紧急数据，应该尽快传送。
* 确认ACK：仅当ACK=1时确认号字段才有效。
* 推送PSH：当两个应用进程进行交互式的通信时，有时一端的应用进程希望在键入一个命令后立即就能收到对方的相应，这时设置PSH=1。
* 复位RST：当RST=1时，表明TCP连接中出现严重错误，必须释放连接，再重新建立运输连接。RST=1还可以用来拒绝一个非法的报文段或拒绝打开一个连接。
* 同步SYN：在建立连接时用来同步序号。当SYN=1，ACK=0时代表是连接请求报文段。若对方同意建立连接，则应在相应报文段中使SYN=1，ACK=1。也就是说，SYN=1代表连接请求或者连接接受报文。
* 终止FIN。用于释放一个连接。当FIN=1时，代表此报文段的发送方的数据已发送完毕，并且请求释放运输连接。

控制位到这结束。

* 窗口：占2字节。窗口值告诉对方：从本报文段中的确认号算起，接收方目前允许对方发送的数据量（以字节为单位）。之所以设置这个限制，是因为接收方的数据缓存空间是有限的。总之，窗口值作为接收方让发送方设置其窗口大小的依据。
* 检验和：占2字节。检验的范围包括首部字段和数据字段。和UDP检验的方法一样，只不过把伪首部第四个字段的17改成6.
* 紧急指针：占2字节。只有在紧急URG=1时才有效，它指出本报文段中的紧急数据的字节数。
* 选项：长度可变，最大40字节，注意，TCP最初只规定了一种选项，即最大报文长度MSS。MSS是每一个TCP报文段中的数据字段的最大长度，而并不是整个TCP报文段的长度。

## 以太网MAC帧格式

![](https://gitee.com/heptaluan/backups/raw/master/cdn/http/14-05.png)

以太网MAC帧较为简单，由五个字段组成，前两个字段分别为6字节长的目的地址和源地址。第三个字段是2字节的类型字段，用来标志上一层使用的是什么协议，以便把收到的MAC帧的数据上交给上一层的这个协议。第四个字段是数据字段，其长度为46~1500字节（46字节是因为最小长度64字节减去18字节的首部和尾部）。最后一个字段是4字节的帧检测序列FCS（使用CRC检测）。 -->