<!DOCTYPE html>
<html lang="zh">
<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
<title>Fiber 架构的简单实现 - heptaluan&#39;s blog</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">



    <meta name="description" content="我们在之前的文章当中梳理了 React Fiber 相关内容，了解了 Fiber 的基本作用以及它内部一些简单的运行原理，所以在本章当中我们来继续深入理解其原理，尝试尝试手动的模拟实现一个简易版本的 Fiber 架构，本文主要参考的是 Build your own React，内容有所调整，主要是为了方便自己理解，更多详细内容可以查看原文，下面我们就先从 JSX 开始看起  完整代码地址可见 Fi">
<meta name="keywords" content="React">
<meta property="og:type" content="article">
<meta property="og:title" content="Fiber 架构的简单实现">
<meta property="og:url" content="http://yoursite.com/2020/12/19/React/19/index.html">
<meta property="og:site_name" content="heptaluan&#39;s blog">
<meta property="og:description" content="我们在之前的文章当中梳理了 React Fiber 相关内容，了解了 Fiber 的基本作用以及它内部一些简单的运行原理，所以在本章当中我们来继续深入理解其原理，尝试尝试手动的模拟实现一个简易版本的 Fiber 架构，本文主要参考的是 Build your own React，内容有所调整，主要是为了方便自己理解，更多详细内容可以查看原文，下面我们就先从 JSX 开始看起  完整代码地址可见 Fi">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://gitee.com/heptaluan/backups/raw/master/cdn/cover/19.webp">
<meta property="og:updated_time" content="2021-03-09T08:29:33.744Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Fiber 架构的简单实现">
<meta name="twitter:description" content="我们在之前的文章当中梳理了 React Fiber 相关内容，了解了 Fiber 的基本作用以及它内部一些简单的运行原理，所以在本章当中我们来继续深入理解其原理，尝试尝试手动的模拟实现一个简易版本的 Fiber 架构，本文主要参考的是 Build your own React，内容有所调整，主要是为了方便自己理解，更多详细内容可以查看原文，下面我们就先从 JSX 开始看起  完整代码地址可见 Fi">
<meta name="twitter:image" content="https://gitee.com/heptaluan/backups/raw/master/cdn/cover/19.webp">







<link rel="icon" href="https://gitee.com/heptaluan/backups/raw/master/cdn/favicon.ico">


<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.7.2/css/bulma.css">
<link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.7.0/css/font-awesome.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu:400,600|Source+Code+Pro">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.5.0/styles/atom-one-light.css">


    
    
    
    <style>body>.footer,body>.navbar,body>.section{opacity:0}</style>
    

    
    
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css">
    

    
    

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.css">


    
    
    
    

<link rel="stylesheet" href="/css/back-to-top.css">


    
    

    
    
    
    

    
    
<link rel="stylesheet" href="/css/progressbar.css">
<script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script>

    
    
    

    
    
    


<link rel="stylesheet" href="/css/style.css">
</head>
<body class="is-2-column">
    <!-- fork me on github -->
<a title="Fork me on GitHub" id="forkMe" style="position: fixed;top: 0;right: 0;z-index: 31" href="https://github.com/heptaluan" target="_blank">
    <svg style="color: #fff;fill: #a0a1a7;height: 80px;width: 80px;" viewbox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"/><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"/><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"/></svg>
</a>

<nav class="navbar navbar-main">
    <div class="container">
        <!-- <div class="navbar-brand is-flex-center">
            <a class="navbar-item navbar-logo" href="/">
            
                <img src="/images/logo.svg" alt="Fiber 架构的简单实现" height="28">
            
            </a>
        </div> -->

        <div class="navbar-menu">
            
            <div class="navbar-start">
                
                <a class="navbar-item" href="/">Home</a>
                
                <a class="navbar-item" href="/archives">Archives</a>
                
                <a class="navbar-item" href="/categories">Categories</a>
                
                <a class="navbar-item" href="https://heptaluan.github.io/demos/">Demos</a>
                
            </div>
            
            <div class="navbar-end">
                
                
                <a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;">
                    <i class="fas fa-list-ul"></i>
                </a>
                
                
                <a class="navbar-item search" title="搜索" href="javascript:;">
                    <i class="fa fa-search"></i>
                </a>
                
            </div>
        </div>
    </div>
</nav>
    
    <section class="section">
        <div class="container">
            <div class="columns">
                <div class="column is-8-tablet is-8-desktop is-9-widescreen has-order-2 column-main"><div class="card">
    
    <div class="card-image">
        <span class="image is-7by1">
            <img class="thumbnail" src="https://gitee.com/heptaluan/backups/raw/master/cdn/cover/19.webp" alt="Fiber 架构的简单实现">
        </span>
    </div>
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <div class="level-item has-text-grey">2020-12-19</div>
                <!-- <time class="level-item has-text-grey" datetime="2020-12-18T16:00:00.000Z">2020-12-19</time> -->
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/React/">React</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    1 小时 读完 (大约 9341 个字)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                Fiber 架构的简单实现
            
        </h1>
        <div class="content">
            <p>我们在之前的文章当中梳理了 <a href="https://heptaluan.github.io/2020/12/06/React/18/" target="_blank" rel="noopener">React Fiber</a> 相关内容，了解了 <code>Fiber</code> 的基本作用以及它内部一些简单的运行原理，所以在本章当中我们来继续深入理解其原理，尝试尝试手动的模拟实现一个简易版本的 <code>Fiber</code> 架构，本文主要参考的是 <a href="https://pomb.us/build-your-own-react/" target="_blank" rel="noopener">Build your own React</a>，内容有所调整，主要是为了方便自己理解，更多详细内容可以查看原文，下面我们就先从 <code>JSX</code> 开始看起</p>
<blockquote>
<p>完整代码地址可见 <a href="https://github.com/heptaluan/react-example/tree/master/example/Fiber%20%E6%9E%B6%E6%9E%84%E7%9A%84%E7%AE%80%E5%8D%95%E5%AE%9E%E7%8E%B0" target="_blank" rel="noopener">Fiber 架构的简单实现</a></p>
</blockquote>
<a id="more"></a>


<h2 id="JSX"><a href="#JSX" class="headerlink" title="JSX"></a>JSX</h2><p>我们都知道，<code>JSX</code> 是一种特殊的语法，在之前版本的 <code>React</code> 当中如果想要支持 <code>JSX</code> 语法的话还需要一个额外库的来进行支持（<code>JSXTransformer.js</code>），不过后来 <code>JSX</code> 的转换工作全部都集成到了 <code>Babel</code> 当中，比如下面这段简单的代码</p>
<figure class="highlight js hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">const</span> App = (</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;h1 id=<span class="hljs-string">"title"</span>&gt;Title&lt;<span class="hljs-regexp">/h1&gt;</span></span><br><span class="line"><span class="hljs-regexp">    &lt;a href="###"&gt;Link&lt;/</span>a&gt;</span><br><span class="line">    &lt;section&gt;</span><br><span class="line">      &lt;p&gt;</span><br><span class="line">        Article</span><br><span class="line">      &lt;<span class="hljs-regexp">/p&gt;</span></span><br><span class="line"><span class="hljs-regexp">    &lt;/</span>section&gt;</span><br><span class="line">  &lt;<span class="hljs-regexp">/div&gt;</span></span><br><span class="line"><span class="hljs-regexp">)</span></span><br></pre></td></tr></table></figure>

<p>我们可以通过 <code>Babel</code> 的 <a href="https://www.babeljs.cn/repl#?browsers=&build=&builtIns=false&spec=false&loose=false&code_lz=MYewdgzgLgBAggBwTAvDAFAKBjAPAEwEsA3APmxzwAsBGGQ_FAIikKgBsBTJ0gFTa64A9LXKU8AQxhUATpwBmzAMQ8AMoTABrYRLGVcETsFbg943AjPj4M1sC4VzQy47xDDxwqYrCiZTACUQA&debug=false&forceAllTransforms=false&shippedProposals=false&circleciRepo=&evaluate=false&fileSize=false&timeTravel=false&sourceType=module&lineWrap=true&presets=es2015%2Creact%2Cstage-2&prettier=false&targets=&version=7.12.11&externalPlugins=" target="_blank" rel="noopener">在线预览功能</a> 来查看它转化后的样子，它是下面这样的</p>
<figure class="highlight js hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">var</span> App = React.createElement(</span><br><span class="line">  <span class="hljs-string">'div'</span>,</span><br><span class="line">  <span class="hljs-literal">null</span>,</span><br><span class="line">  React.createElement(</span><br><span class="line">    <span class="hljs-string">'h1'</span>,</span><br><span class="line">    &#123;</span><br><span class="line">      id: <span class="hljs-string">'title'</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="hljs-string">'Title'</span>,</span><br><span class="line">  ),</span><br><span class="line">  React.createElement(</span><br><span class="line">    <span class="hljs-string">'a'</span>,</span><br><span class="line">    &#123;</span><br><span class="line">      href: <span class="hljs-string">'###'</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="hljs-string">'Link'</span>,</span><br><span class="line">  ),</span><br><span class="line">  React.createElement(</span><br><span class="line">    <span class="hljs-string">'section'</span>,</span><br><span class="line">    <span class="hljs-literal">null</span>,</span><br><span class="line">    React.createElement(<span class="hljs-string">'p'</span>, <span class="hljs-literal">null</span>, <span class="hljs-string">'Article'</span>),</span><br><span class="line">  ),</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>可以发现，我们书写的 <code>JSX</code> 代码已经被转换成了 <code>React.createElement</code> 的写法，同时从转换后的代码我们也可以发现 <code>React.createElement</code> 是支持多个参数的</p>
<ul>
<li><code>type</code>，也就是节点类型</li>
<li><code>config</code>，节点上的属性，比如 <code>id</code> 和 <code>href</code></li>
<li><code>children</code>，从第三个参数开始就全部是子元素，子元素可以有多个，类型可以是简单的文本，也可以还是 <code>React.createElement</code>，如果是 <code>React.createElement</code> 的话其实就是子节点了，子节点下面还可以有子节点，这样就用 <code>React.createElement</code> 的嵌套关系实现了 <code>HTML</code> 节点的树形结构</li>
</ul>
<p>而我们上面这段 <code>JSX</code> 代码如果想在 <code>React</code> 框架下运行起来，还需要 <code>React</code> 提供的额外两个库来进行支持，如下</p>
<figure class="highlight js hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">import</span> React <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span></span><br><span class="line"><span class="hljs-keyword">import</span> ReactDOM <span class="hljs-keyword">from</span> <span class="hljs-string">'react-dom'</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">const</span> App = <span class="hljs-function"><span class="hljs-params">_</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="hljs-keyword">return</span> (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;h1 id=<span class="hljs-string">"title"</span>&gt;Title&lt;<span class="hljs-regexp">/h1&gt;</span></span><br><span class="line"><span class="hljs-regexp">      &lt;a href="###"&gt;Link&lt;/</span>a&gt;</span><br><span class="line">      &lt;section&gt;</span><br><span class="line">        &lt;p&gt;</span><br><span class="line">          Article</span><br><span class="line">      &lt;<span class="hljs-regexp">/p&gt;</span></span><br><span class="line"><span class="hljs-regexp">      &lt;/</span>section&gt;</span><br><span class="line">    &lt;<span class="hljs-regexp">/div&gt;</span></span><br><span class="line"><span class="hljs-regexp">  )</span></span><br><span class="line"><span class="hljs-regexp">&#125;</span></span><br><span class="line"><span class="hljs-regexp"></span></span><br><span class="line"><span class="hljs-regexp">ReactDOM.render(&lt;App /</span>&gt;, <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">'root'</span>))</span><br></pre></td></tr></table></figure>

<p>通过观察我们可以发现，这里面用到了 <code>React</code> 的地方其实就两个，一个是 <code>JSX</code>，也就是 <code>React.createElement</code>，另一个就是 <code>ReactDOM.render</code>，所以下面我们就先来简单的看看 <code>createElement</code> 和 <code>render</code> 这两个方法</p>
<h2 id="createElement"><a href="#createElement" class="headerlink" title="createElement"></a>createElement</h2><p>对于 <code>&lt;h1 id=&quot;title&quot;&gt;Title&lt;/h1&gt;</code> 这样一个简单的节点，我们都知道原生 <code>DOM</code> 会附加一大堆属性和方法在上面，所以我们在 <code>createElement</code> 的时候最好能将它转换为一种比较简单的数据结构，只包含我们需要的元素，比如下面这样</p>
<figure class="highlight js hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  type: <span class="hljs-string">'h1'</span>,</span><br><span class="line">  props: &#123;</span><br><span class="line">    id: <span class="hljs-string">'title'</span>,</span><br><span class="line">    children: <span class="hljs-string">'Title'</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>有了这个数据结构后，我们对于 <code>DOM</code> 的操作其实可以转化为对这个数据结构的操作，新老 <code>DOM</code> 的对比其实也可以转化为这个数据结构的对比，这样我们就不需要每次操作都去渲染页面，而是等到需要渲染的时候才将这个数据结构渲染到页面上，这其实就是所谓的『虚拟 <code>DOM</code>』（以下我们简称为 <code>vDom</code>），而我们 <code>createElement</code> 就是负责来构建这个 <code>vDom</code> 的方法</p>
<p>这里关于 <code>createElement</code> 的实现就不具体展开了，详细可以参考我们之前已经整理过的 <a href="https://heptaluan.github.io/2019/12/15/React/06/" target="_blank" rel="noopener">什么是 Virtual DOM</a> 系列文章或是 <a href="https://github.com/facebook/react/blob/60016c448bb7d19fc989acd05dda5aca2e124381/packages/react/src/ReactElement.js#L348" target="_blank" rel="noopener">官方源码</a> ，核心逻辑并不复杂，这里我们只需要知道它是用来帮助我们构建 <code>vDom</code> 的方法即可</p>
<h2 id="render"><a href="#render" class="headerlink" title="render"></a>render</h2><p>在上面的代码中我们使用 <code>createElement</code> 将 <code>JSX</code> 代码转换成了 <code>vDom</code>，但是我们又该如何将 <code>vDom</code> 渲染为真实的 <code>DOM</code> 节点呢？所以我们还需要一个 <code>render</code> 方法来帮助我们实现这个功能，我们通过上面的使用可以发现，<code>render</code> 方法接收两个参数</p>
<ul>
<li>根组件，其实是一个 <code>JSX</code> 组件，也就是一个 <code>createElement</code> 返回的 <code>vDom</code></li>
<li>父节点，也就是我们要将这个 <code>vDom</code> 渲染的位置</li>
</ul>
<p>有了这些了解以后我们就可以来实现我们自己的 <code>render</code> 方法了</p>
<figure class="highlight js hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">render</span>(<span class="hljs-params">vDom, container</span>) </span>&#123;</span><br><span class="line">  <span class="hljs-keyword">let</span> dom</span><br><span class="line">  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> vDom !== <span class="hljs-string">'object'</span>) &#123;</span><br><span class="line">    dom = <span class="hljs-built_in">document</span>.createTextNode(vDom)</span><br><span class="line">  &#125; <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">    dom = <span class="hljs-built_in">document</span>.createElement(vDom.type)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="hljs-comment">// 将 vDom 上除了 children 外的属性都挂载到真正的 DOM 上去</span></span><br><span class="line">  <span class="hljs-keyword">if</span> (vDom.props) &#123;</span><br><span class="line">    <span class="hljs-built_in">Object</span>.keys(vDom.props)</span><br><span class="line">      .filter(<span class="hljs-function"><span class="hljs-params">key</span> =&gt;</span> key != <span class="hljs-string">'children'</span>)</span><br><span class="line">      .forEach(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> &#123;</span><br><span class="line">        dom[item] = vDom.props[item]</span><br><span class="line">      &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="hljs-comment">// 如果还有子元素，递归调用</span></span><br><span class="line">  <span class="hljs-keyword">if</span> (vDom.props &amp;&amp; vDom.props.children &amp;&amp; vDom.props.children.length) &#123;</span><br><span class="line">    vDom.props.children.forEach(<span class="hljs-function"><span class="hljs-params">child</span> =&gt;</span> render(child, dom))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  container.appendChild(dom)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当然，上述代码只是简化版本的 <code>render</code> 方法，我们没有考虑节点具体类型的区别，又或是挂载和更新的不同处理逻辑等，详细内容同样可以参考我们之前已经整理过的 <a href="https://heptaluan.github.io/2019/12/15/React/06/" target="_blank" rel="noopener">什么是 Virtual DOM</a> 系列文章或是对应的 <a href="https://github.com/facebook/react/blob/3e94bce765d355d74f6a60feb4addb6d196e3482/packages/react-dom/src/client/ReactDOMLegacy.js#L287" target="_blank" rel="noopener">官方源码</a> 来了解更多，因为这一部分在本文当中不是我们重点关注的内容，所以我们只是简单介绍一二，下面我们主要来看看 <code>Fiber</code> 的相关内容</p>
<h2 id="render-的拆分"><a href="#render-的拆分" class="headerlink" title="render 的拆分"></a>render 的拆分</h2><p>我们在上面实现了将 <code>vDom</code> 渲染到页面上的代码，这部分的工作在 <code>React</code> 官方当中被称为 <code>renderer</code>，<code>renderer</code> 是第三方可以自己实现的一个模块，其中有个核心模块叫做 <code>reconsiler</code>，而 <code>reconsiler</code> 的一大功能就是大家熟知的 <code>Diff</code>，它会计算出应该更新哪些页面节点，然后将需要更新的节点 <code>vDom</code> 传递给 <code>renderer</code>，<code>renderer</code> 负责将这些节点渲染到页面上</p>
<p>但是这个流程有个问题，也是我们在 <a href="https://heptaluan.github.io/2020/12/06/React/18/" target="_blank" rel="noopener">React Fiber</a> 章节开头部分所提到的，那就是虽然 <code>React</code> 的 <code>Diff</code> 算法是经过优化的，但是它却是同步的，<code>renderer</code> 负责操作 <code>DOM</code> 的一些操作也是同步的，也就是说如果有大量节点需要更新，<code>JavaScript</code> 线程的运行时间可能会比较长，在这段时间浏览器是不会响应其它事件的，因为 <code>JavaScript</code> 线程和 <code>GUI</code> 线程是互斥的，如果这个时间太长了，用户就可能看到卡顿，这也就是为什么 <code>React</code> 会推出 <code>Fiber</code> 的原因，<code>Fiber</code> 可以将长时间的同步任务拆分成多个小任务，从而让浏览器能够抽身去响应其它事件，等它有空了再回来继续计算</p>
<p>但是我们在上面实现的 <code>render</code> 方法，它是直接递归遍历了整个树，如果我们在中途某一步停下来，下次再调用时其实并不知道上次在哪里停下来的，不知道从哪里开始，即使你将上次的结束节点记下来了，你也不知道下一个该执行哪个，所以之前简单的 <code>vDom</code> 树形结构并不满足中途暂停，下次继续的需求，所以我们就需要改造它的数据结构</p>
<p>而另一个需要解决的问题是，拆分下来的小任务什么时候执行？我们的目的是让用户有更流畅的体验，所以我们最好不要阻塞高优先级的任务，比如用户输入，动画之类，等它们执行完了我们再计算，那我怎么知道现在有没有高优先级任务，浏览器是不是空闲呢？所以总结下来，<code>Fiber</code> 要想达到目的，需要解决两个问题</p>
<ul>
<li>新的任务调度，有高优先级任务的时候将浏览器让出来，等浏览器空了再继续执行</li>
<li>新的数据结构，可以随时中断，下次进来可以接着执行</li>
</ul>
<p>所幸，针对这两点我们都已经有了对应的解决方式，也就是 <a href="https://heptaluan.github.io/2020/12/06/React/18/" target="_blank" rel="noopener">之前文章</a> 当中所提及到的 <code>Fiber</code> 数据结构与 <code>requestIdleCallback</code> 这个 <code>API</code>，这里我们就不过多介绍了，只简单提及一二</p>
<h4 id="requestIdleCallback"><a href="#requestIdleCallback" class="headerlink" title="requestIdleCallback"></a>requestIdleCallback</h4><p><code>requestIdleCallback</code> 接收一个回调，这个回调会在浏览器空闲时调用，每次调用会传入一个 <code>IdleDeadline</code>，可以得到当前还空余多久，<code>options</code> 可以传入参数最多等多久，等到了时间浏览器还不空就强制执行了，使用这个 <code>API</code> 可以解决我们之前提到的任务调度的问题，让浏览器在空闲时才计算 <code>Diff</code> 并渲染，调用方式如下</p>
<figure class="highlight js hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">// 开启调用</span></span><br><span class="line"><span class="hljs-keyword">var</span> handle = <span class="hljs-built_in">window</span>.requestIdleCallback(callback[, options])</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// 结束调用</span></span><br><span class="line">Window.cancelIdleCallback(handle)</span><br></pre></td></tr></table></figure>

<p>但是这个 <code>API</code> 还处在实验阶段，兼容性不好，所以 <code>React</code> 官方自己实现了一套，但是在这里我们就不考虑那么多了，还是使用 <code>requestIdleCallback</code> 来进行任务调度，我们进行任务调度的思想是将任务拆分成多个小任务，<code>requestIdleCallback</code> 里面不断的把小任务拿出来执行，当所有任务都执行完或者超时了就结束本次执行，同时要注册下次执行</p>
<p>这里我们可以借住官方的 <a href="https://github.com/facebook/react/blob/4c7036e807fa18a3e21a5182983c7c0f05c5936e/packages/react-reconciler/src/ReactFiberWorkLoop.new.js#L1481" target="_blank" rel="noopener">workLoopSync</a> 实现方式得出大致架子，如下所示</p>
<figure class="highlight js hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">workLoop</span>(<span class="hljs-params">deadline</span>) </span>&#123;</span><br><span class="line">  <span class="hljs-comment">// while 循环会在任务执行完或者时间到了的时候结束</span></span><br><span class="line">  <span class="hljs-keyword">while</span> (nextUnitOfWork &amp;&amp; deadline.timeRemaining() &gt; <span class="hljs-number">1</span>) &#123;</span><br><span class="line">    nextUnitOfWork = performUnitOfWork(nextUnitOfWork)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="hljs-comment">// 如果任务还没完，但是时间到了，我们需要继续注册 requestIdleCallback</span></span><br><span class="line">  requestIdleCallback(workLoop)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// performUnitOfWork 用来执行任务，参数是我们的当前 fiber 任务，返回值是下一个任务</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">performUnitOfWork</span>(<span class="hljs-params">fiber</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">requestIdleCallback(workLoop)</span><br></pre></td></tr></table></figure>

<h4 id="Fiber-数据结构"><a href="#Fiber-数据结构" class="headerlink" title="Fiber 数据结构"></a>Fiber 数据结构</h4><p>在上面的代码中，我们完成了任务的拆分，下面我们就来看看如果能让我们的任务可以随时中断，并且下次进来的时候还可以接着执行，上面示例中的 <code>performUnitOfWork</code> 方法我们暂时还没有实现，但是从上面的结构可以看出来，它接收的参数是一个小任务，同时通过这个小任务还可以找到它的下一个小任务，而 <code>Fiber</code> 构建的就是这样一个数据结构，而我们之前的 <code>vDom</code> 的数据结构是一棵树，父节点的 <code>children</code> 指向了子节点，但是只有这一个指针是不能实现中断继续的，所以我们需要对之前的结构进行一定的调整，可以参考官方演讲当中的方式，如下</p>
<p><img src="https://gitee.com/heptaluan/backups/raw/master/cdn/react/19-01.png" alt></p>
<p>我们可以发现和之前 <code>vDom</code> 当中父节点指向所有子节点不同，这里有三个指针</p>
<ul>
<li><code>child</code>，父节点指向第一个子元素的指针</li>
<li><code>sibling</code>，从第一个子元素往后，指向下一个兄弟元素</li>
<li><code>return</code>，所有子元素都有的指向父元素的指针</li>
</ul>
<p>有了这几个指针后，我们可以在任意一个元素中断遍历并恢复，比如在上图 <code>List</code> 处中断了，恢复的时候可以通过 <code>child</code> 找到他的子元素，也可以通过 <code>return</code> 找到他的父元素，如果他还有兄弟节点也可以用 <code>sibling</code> 找到，<code>Fiber</code> 这个结构外形看着还是棵树，但是没有了指向所有子元素的指针，父节点只指向第一个子节点，然后子节点有指向其他子节点的指针，所以可以发现这其实是个『链表结构』</p>
<blockquote>
<p>这里需要注意的是，真正的 <code>Fiber</code> 结构并不仅仅只多了这三个节点，但是这里我们只使用这三个节点来理解其原理就足够了，更多 <code>Fiber</code> 节点相关内容可见 <a href="https://heptaluan.github.io/2020/12/06/React/18/#Fiber-节点" target="_blank" rel="noopener">Fiber 节点</a></p>
</blockquote>
<h2 id="Fiber-的实现"><a href="#Fiber-的实现" class="headerlink" title="Fiber 的实现"></a>Fiber 的实现</h2><p>有了以上内容的铺垫以后，下面我们就可以来实现一下我们自己的 <code>Fiber</code> 了，我们需要将我们之前的 <code>vDom</code> 结构转换为 <code>Fiber</code> 的数据结构，同时需要能够通过其中任意一个节点返回下一个节点，其实就是遍历这个链表</p>
<p>遍历的时候从根节点出发，先找子元素，如果子元素存在，直接返回，如果没有子元素了就找兄弟元素，找完所有的兄弟元素后再返回父元素，然后再找这个父元素的兄弟元素，整个遍历过程其实是个『深度优先遍历』，从上到下，然后最后一行开始从左到右遍历</p>
<p>比如下图从 <code>div1</code> 开始遍历的话，遍历的顺序就应该是 <code>div1 ==&gt; div2 ==&gt; h1 ==&gt; a ==&gt; div2 ==&gt; p ==&gt; div1</code>，可以看到这个序列中，当我们 <code>return</code> 父节点时，这些父节点会被第二次遍历，所以我们在设计的时候，<code>return</code> 的父节点不会作为下一个任务返回，只有 <code>sibling</code> 和 <code>child</code> 才会作为下一个任务返回</p>
<p><img src="https://gitee.com/heptaluan/backups/raw/master/cdn/react/19-02.png" alt></p>
<p>同样我们可以参考官方当中的 <a href="https://github.com/facebook/react/blob/4c7036e807fa18a3e21a5182983c7c0f05c5936e/packages/react-reconciler/src/ReactFiberWorkLoop.new.js#L1541" target="_blank" rel="noopener">performUnitOfWork</a> 来进行实现，它的作用是用来执行任务，参数是我们当前的 <code>Fiber</code> 任务，返回值是下一个任务，我们这里只是简单的模拟实现，官方版本当中的实现方式远比我们要复杂很多</p>
<figure class="highlight js hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">performUnitOfWork</span>(<span class="hljs-params">fiber</span>) </span>&#123;</span><br><span class="line">  <span class="hljs-keyword">if</span> (!fiber.dom) &#123;                             <span class="hljs-comment">// 根节点的 dom 就是 container，如果没有这个属性，说明当前 fiber 不是根节点</span></span><br><span class="line">    fiber.dom = createDom(fiber)                <span class="hljs-comment">// 创建一个DOM挂载上去</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="hljs-keyword">if</span> (fiber.return) &#123;                           <span class="hljs-comment">// 如果有父节点，将当前节点挂载到父节点上</span></span><br><span class="line">    fiber.return.dom.appendChild(fiber.dom)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="hljs-keyword">const</span> elements = fiber.children               <span class="hljs-comment">// 将我们前面的 vDom 结构转换为 fiber 结构</span></span><br><span class="line">  <span class="hljs-keyword">let</span> prevSibling = <span class="hljs-literal">null</span></span><br><span class="line">  <span class="hljs-keyword">if</span> (elements &amp;&amp; elements.length) &#123;</span><br><span class="line">    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; elements.length; i++) &#123;</span><br><span class="line">      <span class="hljs-keyword">const</span> element = elements[i]</span><br><span class="line">      <span class="hljs-keyword">const</span> newFiber = &#123;</span><br><span class="line">        type: element.type,</span><br><span class="line">        props: element.props,</span><br><span class="line">        <span class="hljs-keyword">return</span>: fiber,</span><br><span class="line">        dom: <span class="hljs-literal">null</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="hljs-keyword">if</span> (i === <span class="hljs-number">0</span>) &#123;                            <span class="hljs-comment">// 父级的 child 指向第一个子元素</span></span><br><span class="line">        fiber.child = newFiber</span><br><span class="line">      &#125; <span class="hljs-keyword">else</span> &#123;                                  <span class="hljs-comment">// 每个子元素拥有指向下一个子元素的指针</span></span><br><span class="line">        prevSibling.sibling = newFiber</span><br><span class="line">      &#125;</span><br><span class="line">      prevSibling = newFiber</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="hljs-comment">// 这个函数的返回值是下一个任务，这其实是一个深度优先遍历</span></span><br><span class="line">  <span class="hljs-comment">// 先找子元素，没有子元素了就找兄弟元素，兄弟元素也没有了就返回父元素</span></span><br><span class="line">  <span class="hljs-comment">// 然后再找这个父元素的兄弟元素，最后到根节点结束</span></span><br><span class="line">  <span class="hljs-comment">// 这个遍历的顺序其实就是从上到下，从左到右</span></span><br><span class="line">  <span class="hljs-keyword">if</span> (fiber.child) &#123;</span><br><span class="line">    <span class="hljs-keyword">return</span> fiber.child</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">let</span> nextFiber = fiber</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">while</span> (nextFiber) &#123;</span><br><span class="line">    <span class="hljs-keyword">if</span> (nextFiber.sibling) &#123;</span><br><span class="line">      <span class="hljs-keyword">return</span> nextFiber.sibling</span><br><span class="line">    &#125;</span><br><span class="line">    nextFiber = nextFiber.return</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="统一提交"><a href="#统一提交" class="headerlink" title="统一提交"></a>统一提交</h2><p>上面我们的 <code>performUnitOfWork</code> 一边构建 <code>Fiber</code> 结构一边操作 <code>DOM</code>（<code>appendChild</code>），但是如果某次我们同时更新了好几个节点，而且在操作了第一个节点之后就中断了，那么我们可能只会看到第一个节点渲染到了页面，后续几个节点要等到浏览器空了才会去陆续渲染</p>
<p>为了避免这种情况，我们应该将 <code>DOM</code> 操作都搜集起来，最后统一执行，而这就是 <code>commit</code> 操作，为了能够记录位置，我们还需要一个全局变量 <code>workInProgressRoot</code> 来记录根节点，然后在 <code>workLoop</code> 检测如果任务执行完了，就统一 <code>commit</code></p>
<figure class="highlight js hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">workLoop</span>(<span class="hljs-params">deadline</span>) </span>&#123;</span><br><span class="line">  <span class="hljs-comment">// while 循环会在任务执行完或者时间到了的时候结束</span></span><br><span class="line">  <span class="hljs-keyword">while</span> (nextUnitOfWork &amp;&amp; deadline.timeRemaining() &gt; <span class="hljs-number">1</span>) &#123;</span><br><span class="line">    nextUnitOfWork = performUnitOfWork(nextUnitOfWork)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="hljs-comment">// 任务做完后统一渲染</span></span><br><span class="line">  <span class="hljs-keyword">if</span> (!nextUnitOfWork &amp;&amp; workInProgressRoot) &#123;</span><br><span class="line">    commitRoot()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="hljs-comment">// 如果任务还没完，但是时间到了，我们需要继续注册 requestIdleCallback</span></span><br><span class="line">  requestIdleCallback(workLoop)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>因为我们是在 <code>Fiber</code> 树完全构建后再执行的 <code>commit</code>，而且有一个变量 <code>workInProgressRoot</code> 指向了 <code>Fiber</code> 的根节点，所以我们可以直接把 <code>workInProgressRoot</code> 拿过来递归渲染就行了</p>
<figure class="highlight js hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">// 统一操作 DOM</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">commitRoot</span>(<span class="hljs-params"></span>) </span>&#123;</span><br><span class="line">  commitRootImpl(workInProgressRoot.child)  <span class="hljs-comment">// 开启递归</span></span><br><span class="line">  workInProgressRoot = <span class="hljs-literal">null</span>                 <span class="hljs-comment">// 操作完后将 workInProgressRoot 重置</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">commitRootImpl</span>(<span class="hljs-params">fiber</span>) </span>&#123;</span><br><span class="line">  <span class="hljs-keyword">if</span> (!fiber) &#123;</span><br><span class="line">    <span class="hljs-keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">const</span> parentDom = fiber.return.dom</span><br><span class="line">  parentDom.appendChild(fiber.dom)</span><br><span class="line"></span><br><span class="line">  <span class="hljs-comment">// 递归操作子元素和兄弟元素</span></span><br><span class="line">  commitRootImpl(fiber.child)</span><br><span class="line">  commitRootImpl(fiber.sibling)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="协调"><a href="#协调" class="headerlink" title="协调"></a>协调</h2><p>协调其实就是 <code>vDom</code> 的 <code>Diff</code> 操作，需要添加新的节点，删除不需要的节点和更新修改过的节点，为了能在中断后能回到工作位置，我们还需要一个变量 <code>currentRoot</code>，然后在 <code>fiber</code> 节点里面添加一个属性 <code>alternate</code>，这个属性指向上一次运行的根节点，也就是 <code>currentRoot</code></p>
<p><code>currentRoot</code> 会在第一次 <code>render</code> 后的 <code>commit</code> 阶段赋值，也就是每次计算完后都会把当次状态记录在 <code>alternate</code> 上，后面更新了就可以把 <code>alternate</code> 拿出来跟新的状态做 <code>Diff</code>，然后 <code>performUnitOfWork</code> 里面需要添加协调子元素的代码，所以我们可以新增一个比对函数 <code>reconcileChildren</code> 来将老节点跟新节点进行对比，逻辑如下</p>
<ol>
<li>如果新老节点类型一样，复用老节点 <code>DOM</code>，更新 <code>props</code></li>
<li>如果类型不一样，而且新的节点存在，创建新节点替换老节点</li>
<li>如果类型不一样，没有新节点，有老节点，删除老节点</li>
</ol>
<p>注意删除老节点的操作是直接将 <code>oldFiber</code> 加上一个删除标记就行，同时用一个全局变量 <code>deletions</code> 记录所有需要删除的节点</p>
<figure class="highlight js hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">reconcileChildren</span>(<span class="hljs-params">workInProgressFiber, elements</span>) </span>&#123;</span><br><span class="line">  <span class="hljs-comment">// 构建 fiber 结构</span></span><br><span class="line">  <span class="hljs-keyword">let</span> oldFiber = workInProgressFiber.alternate</span><br><span class="line">    &amp;&amp; workInProgressFiber.alternate.child         <span class="hljs-comment">// 获取上次的 fiber 树</span></span><br><span class="line">  <span class="hljs-keyword">let</span> prevSibling = <span class="hljs-literal">null</span></span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">let</span> index = <span class="hljs-number">0</span></span><br><span class="line">  <span class="hljs-keyword">if</span> (elements &amp;&amp; elements.length) &#123;</span><br><span class="line">    <span class="hljs-keyword">if</span> (!oldFiber) &#123;                               <span class="hljs-comment">// 第一次没有 oldFiber，那全部是 REPLACEMENT</span></span><br><span class="line">      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; elements.length; i++) &#123;</span><br><span class="line">        <span class="hljs-keyword">const</span> element = elements[i]</span><br><span class="line">        <span class="hljs-keyword">const</span> newFiber = buildNewFiber(element, workInProgressFiber)</span><br><span class="line">        <span class="hljs-keyword">if</span> (i === <span class="hljs-number">0</span>) &#123;                             <span class="hljs-comment">// 父级的 child 指向第一个子元素</span></span><br><span class="line">          workInProgressFiber.child = newFiber</span><br><span class="line">        &#125; <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">          prevSibling.sibling = newFiber           <span class="hljs-comment">// 每个子元素拥有指向下一个子元素的指针</span></span><br><span class="line">        &#125;</span><br><span class="line">        prevSibling = newFiber</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">while</span> (index &lt; elements.length &amp;&amp; oldFiber) &#123;</span><br><span class="line">      <span class="hljs-keyword">let</span> element = elements[index]</span><br><span class="line">      <span class="hljs-keyword">let</span> newFiber = <span class="hljs-literal">null</span></span><br><span class="line">      <span class="hljs-keyword">const</span> sameType = oldFiber                    <span class="hljs-comment">// 对比 oldFiber 和当前 element（检测类型是否一样）</span></span><br><span class="line">        &amp;&amp; element</span><br><span class="line">        &amp;&amp; oldFiber.type === element.type</span><br><span class="line">      <span class="hljs-keyword">if</span> (sameType) &#123;                              <span class="hljs-comment">// 先比较元素类型，如果类型一样，复用节点，更新 props</span></span><br><span class="line">        newFiber = &#123;</span><br><span class="line">          type: oldFiber.type,</span><br><span class="line">          props: element.props,</span><br><span class="line">          dom: oldFiber.dom,</span><br><span class="line">          <span class="hljs-keyword">return</span>: workInProgressFiber,</span><br><span class="line">          alternate: oldFiber,                     <span class="hljs-comment">// 记录下上次状态</span></span><br><span class="line">          effectTag: <span class="hljs-string">'UPDATE'</span>                      <span class="hljs-comment">// 添加一个操作标记</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!sameType &amp;&amp; element) &#123;           <span class="hljs-comment">// 如果类型不一样，有新的节点，创建新节点替换老节点</span></span><br><span class="line">        newFiber = buildNewFiber(element, workInProgressFiber)</span><br><span class="line">      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!sameType &amp;&amp; oldFiber) &#123;          <span class="hljs-comment">// 如果类型不一样，没有新节点，有老节点，删除老节点</span></span><br><span class="line">        oldFiber.effectTag = <span class="hljs-string">'DELETION'</span>            <span class="hljs-comment">// 添加删除标记</span></span><br><span class="line">        deletions.push(oldFiber)                   <span class="hljs-comment">// 一个数组收集所有需要删除的节点</span></span><br><span class="line">      &#125;</span><br><span class="line">      oldFiber = oldFiber.sibling                  <span class="hljs-comment">// 循环处理兄弟元素</span></span><br><span class="line">      <span class="hljs-keyword">if</span> (index === <span class="hljs-number">0</span>) &#123;                           <span class="hljs-comment">// 父级的child指向第一个子元素</span></span><br><span class="line">        workInProgressFiber.child = newFiber</span><br><span class="line">      &#125; <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">        prevSibling.sibling = newFiber             <span class="hljs-comment">// 每个子元素拥有指向下一个子元素的指针</span></span><br><span class="line">      &#125;</span><br><span class="line">      prevSibling = newFiber</span><br><span class="line">      index++</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后就是在 <code>commit</code> 阶段处理真正的 <code>DOM</code> 操作，具体的操作是根据我们的 <code>effectTag</code> 来进行判断的</p>
<figure class="highlight js hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">commitRootImpl</span>(<span class="hljs-params">fiber</span>) </span>&#123;</span><br><span class="line">  <span class="hljs-keyword">if</span> (!fiber) &#123;</span><br><span class="line">    <span class="hljs-keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="hljs-keyword">const</span> parentDom = fiber.return.dom</span><br><span class="line">  <span class="hljs-keyword">if</span> (fiber.effectTag === <span class="hljs-string">'REPLACEMENT'</span> &amp;&amp; fiber.dom) &#123;</span><br><span class="line">    parentDom.appendChild(fiber.dom)</span><br><span class="line">  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (fiber.effectTag === <span class="hljs-string">'DELETION'</span>) &#123;</span><br><span class="line">    parentDom.removeChild(fiber.dom)</span><br><span class="line">  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (fiber.effectTag === <span class="hljs-string">'UPDATE'</span> &amp;&amp; fiber.dom) &#123;</span><br><span class="line">    <span class="hljs-comment">// 更新 DOM 属性</span></span><br><span class="line">    updateDom(fiber.dom, fiber.alternate.props, fiber.props)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="hljs-comment">// 递归操作子元素和兄弟元素</span></span><br><span class="line">  commitRootImpl(fiber.child)</span><br><span class="line">  commitRootImpl(fiber.sibling)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>替换和删除的 <code>DOM</code> 操作都比较简单，更新属性的会稍微麻烦点，需要再写一个辅助函数 <code>updateDom</code> 来实现</p>
<figure class="highlight js hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">// 更新 DOM 的操作</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">updateDom</span>(<span class="hljs-params">dom, prevProps, nextProps</span>) </span>&#123;</span><br><span class="line">  <span class="hljs-comment">// 1、过滤 children 属性</span></span><br><span class="line">  <span class="hljs-comment">// 2、老的存在，新的没了，取消</span></span><br><span class="line">  <span class="hljs-comment">// 3、新的存在，老的没有，新增</span></span><br><span class="line">  <span class="hljs-built_in">Object</span>.keys(prevProps)</span><br><span class="line">    .filter(<span class="hljs-function"><span class="hljs-params">name</span> =&gt;</span> name !== <span class="hljs-string">'children'</span>)</span><br><span class="line">    .filter(<span class="hljs-function"><span class="hljs-params">name</span> =&gt;</span> !(name <span class="hljs-keyword">in</span> nextProps))</span><br><span class="line">    .forEach(<span class="hljs-function"><span class="hljs-params">name</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="hljs-keyword">if</span> (name.indexOf(<span class="hljs-string">'on'</span>) === <span class="hljs-number">0</span>) &#123;</span><br><span class="line">        dom.removeEventListener(name.substr(<span class="hljs-number">2</span>).toLowerCase(), prevProps[name], <span class="hljs-literal">false</span>)</span><br><span class="line">      &#125; <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">        dom[name] = <span class="hljs-string">''</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  <span class="hljs-built_in">Object</span>.keys(nextProps)</span><br><span class="line">    .filter(<span class="hljs-function"><span class="hljs-params">name</span> =&gt;</span> name !== <span class="hljs-string">'children'</span>)</span><br><span class="line">    .forEach(<span class="hljs-function"><span class="hljs-params">name</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="hljs-keyword">if</span> (name.indexOf(<span class="hljs-string">'on'</span>) === <span class="hljs-number">0</span>) &#123;</span><br><span class="line">        dom.addEventListener(name.substr(<span class="hljs-number">2</span>).toLowerCase(), nextProps[name], <span class="hljs-literal">false</span>)</span><br><span class="line">      &#125; <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">        dom[name] = nextProps[name]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里我们只是简单处理了 <code>on</code> 开头的一些事件，并且兼容性可能也会存在问题，而且 <code>prevProps</code> 和 <code>nextProps</code> 可能会遍历到相同的属性，有重复赋值，但是在这里我们也就不多做处理了，这里的主要目的其实是为了让我们了解其原理，更为完整的实现方式可以参考我们之前已经整理过的 <a href="https://heptaluan.github.io/2019/12/22/React/08/" target="_blank" rel="noopener">渲染器的核心 Diff 算法</a></p>
<p>下面我们来看看如何支持函数组件</p>
<h2 id="函数组件"><a href="#函数组件" class="headerlink" title="函数组件"></a>函数组件</h2><p>函数组件是 <code>React</code> 里面很常见的一种组件，但是我们之前的 <code>fiber</code> 节点上的 <code>type</code> 都是 <code>DOM</code> 节点的类型，比如 <code>h1</code> 之类的，而函数组件的节点 <code>type</code> 应该就是一个函数了，所以我们需要对这种节点进行单独处理，首先需要在更新的时候检测当前节点是不是函数组件，如果是的话那么 <code>children</code> 的处理逻辑会稍微有些不太一样，我们首先来调整一下我们的 <code>performUnitOfWork</code> 函数</p>
<figure class="highlight js hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">performUnitOfWork</span>(<span class="hljs-params">fiber</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="hljs-comment">// ...</span></span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">const</span> isFunctionComponent = fiber.type <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Function</span></span><br><span class="line">  <span class="hljs-keyword">if</span> (isFunctionComponent) &#123;</span><br><span class="line">    updateFunctionComponent(fiber)</span><br><span class="line">  &#125; <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">    updateHostComponent(fiber)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="hljs-comment">// ...</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">updateFunctionComponent</span>(<span class="hljs-params">fiber</span>) </span>&#123;</span><br><span class="line">  <span class="hljs-comment">// 函数组件的 type 就是个函数，直接拿来执行可以获得 DOM 元素</span></span><br><span class="line">  <span class="hljs-keyword">const</span> children = [fiber.type(fiber.props)]</span><br><span class="line">  reconcileChildren(fiber, children)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// updateHostComponent 就是之前的操作，只是单独抽取了一个方法</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">updateHostComponent</span>(<span class="hljs-params">fiber</span>) </span>&#123;</span><br><span class="line">  <span class="hljs-keyword">if</span> (!fiber.dom) &#123;</span><br><span class="line">    <span class="hljs-comment">// 创建一个 DOM 挂载上去</span></span><br><span class="line">    fiber.dom = createDom(fiber)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="hljs-comment">// 将我们前面的 vDom 结构转换为 fiber 结构</span></span><br><span class="line">  <span class="hljs-keyword">const</span> elements = fiber.props.children</span><br><span class="line"></span><br><span class="line">  <span class="hljs-comment">// 协调子元素</span></span><br><span class="line">  reconcileChildren(fiber, elements)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后在我们提交 <code>DOM</code> 操作的时候因为函数组件没有 <code>DOM</code> 元素，所以需要注意两点</p>
<ol>
<li>获取父级 <code>DOM</code> 元素的时候需要递归往上找到真正的 <code>DOM</code></li>
<li>删除节点的时候需要递归往下找到真正的节点</li>
</ol>
<p>所以我们来修改下 <code>commitRootImpl</code></p>
<figure class="highlight js hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">commitRootImpl</span>(<span class="hljs-params">fiber</span>) </span>&#123;</span><br><span class="line">  <span class="hljs-keyword">if</span> (!fiber) &#123;</span><br><span class="line">    <span class="hljs-keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="hljs-comment">// 不再直接获取，而是向上查找真正的 DOM</span></span><br><span class="line">  <span class="hljs-comment">// const parentDom = fiber.return.dom</span></span><br><span class="line">  <span class="hljs-keyword">let</span> parentFiber = fiber.return</span><br><span class="line">  <span class="hljs-keyword">while</span> (!parentFiber.dom) &#123;</span><br><span class="line">    parentFiber = parentFiber.return</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="hljs-keyword">const</span> parentDom = parentFiber.dom</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">if</span> (fiber.effectTag === <span class="hljs-string">'REPLACEMENT'</span> &amp;&amp; fiber.dom) &#123;</span><br><span class="line">    parentDom.appendChild(fiber.dom)</span><br><span class="line">  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (fiber.effectTag === <span class="hljs-string">'DELETION'</span>) &#123;</span><br><span class="line">    <span class="hljs-comment">// 这里也不再使用 parentDom.removeChild(fiber.dom)</span></span><br><span class="line">    commitDeletion(fiber, parentDom)</span><br><span class="line">  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (fiber.effectTag === <span class="hljs-string">'UPDATE'</span> &amp;&amp; fiber.dom) &#123;</span><br><span class="line">    <span class="hljs-comment">// 更新DOM属性</span></span><br><span class="line">    updateDom(fiber.dom, fiber.alternate.props, fiber.props)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="hljs-comment">// 递归操作子元素和兄弟元素</span></span><br><span class="line">  commitRootImpl(fiber.child)</span><br><span class="line">  commitRootImpl(fiber.sibling)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">commitDeletion</span>(<span class="hljs-params">fiber, domParent</span>) </span>&#123;</span><br><span class="line">  <span class="hljs-keyword">if</span> (fiber.dom) &#123;</span><br><span class="line">    <span class="hljs-comment">// DOM 存在，是普通节点</span></span><br><span class="line">    domParent.removeChild(fiber.dom)</span><br><span class="line">  &#125; <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">    <span class="hljs-comment">// DOM 不存在，是函数组件，向下递归查找真实 DOM</span></span><br><span class="line">    commitDeletion(fiber.child, domParent)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现在我们可以传入函数组件了</p>
<figure class="highlight js hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">import</span> React <span class="hljs-keyword">from</span> <span class="hljs-string">'./myReact'</span></span><br><span class="line"><span class="hljs-keyword">const</span> ReactDOM = React</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">App</span>(<span class="hljs-params">props</span>) </span>&#123;</span><br><span class="line">  <span class="hljs-keyword">return</span> (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;h1 id=<span class="hljs-string">"title"</span>&gt;&#123;props.title&#125;&lt;<span class="hljs-regexp">/h1&gt;</span></span><br><span class="line"><span class="hljs-regexp">      &lt;a href="xxx"&gt;Jump&lt;/</span>a&gt;</span><br><span class="line">      &lt;section&gt;</span><br><span class="line">        &lt;p&gt;</span><br><span class="line">          Article</span><br><span class="line">        &lt;<span class="hljs-regexp">/p&gt;</span></span><br><span class="line"><span class="hljs-regexp">      &lt;/</span>section&gt;</span><br><span class="line">    &lt;<span class="hljs-regexp">/div&gt;</span></span><br><span class="line"><span class="hljs-regexp">  )</span></span><br><span class="line"><span class="hljs-regexp">&#125;</span></span><br><span class="line"><span class="hljs-regexp"></span></span><br><span class="line"><span class="hljs-regexp">ReactDOM.render(</span></span><br><span class="line"><span class="hljs-regexp">  &lt;App /</span>&gt;,</span><br><span class="line">  <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">'root'</span>)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h2 id="实现-useState"><a href="#实现-useState" class="headerlink" title="实现 useState"></a>实现 useState</h2><p><code>useState</code> 是 <code>React Hooks</code> 里面的一个 <code>API</code>，相当于之前 <code>Class Component</code> 里面的 <code>state</code>，用来管理组件内部状态，现在我们已经有一个简化版的 <code>React</code> 了，我们也可以尝试下来实现这个 <code>API</code></p>
<h4 id="简单版"><a href="#简单版" class="headerlink" title="简单版"></a>简单版</h4><p>我们还是从用法入手来实现最简单的功能，我们一般使用 <code>useState</code> 是这样的</p>
<figure class="highlight js hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">App</span>(<span class="hljs-params">props</span>) </span>&#123;</span><br><span class="line">  <span class="hljs-keyword">const</span> [count, setCount] = React.useState(<span class="hljs-number">1</span>)</span><br><span class="line">  <span class="hljs-keyword">const</span> onClickHandler = <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;</span><br><span class="line">    setCount(count + <span class="hljs-number">1</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="hljs-keyword">return</span> (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;h1&gt;Count: &#123;count&#125;&lt;<span class="hljs-regexp">/h1&gt;</span></span><br><span class="line"><span class="hljs-regexp">      &lt;button onClick=&#123;onClickHandler&#125;&gt;Count + 1&lt;/</span>button&gt;</span><br><span class="line">    &lt;<span class="hljs-regexp">/div&gt;</span></span><br><span class="line"><span class="hljs-regexp">  )</span></span><br><span class="line"><span class="hljs-regexp">&#125;</span></span><br><span class="line"><span class="hljs-regexp"></span></span><br><span class="line"><span class="hljs-regexp">ReactDOM.render(</span></span><br><span class="line"><span class="hljs-regexp">  &lt;App /</span>&gt;,</span><br><span class="line">  <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">'root'</span>)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>上述代码可以看出，我们的 <code>useState</code> 接收一个初始值，返回一个数组，里面有这个 <code>state</code> 的当前值和改变 <code>state</code> 的方法，但是需要注意的是 <code>App</code> 作为一个函数组件，每次 <code>render</code> 的时候都会运行，也就是说里面的局部变量每次 <code>render</code> 的时候都会重置，那我们的 <code>state</code> 就不能作为一个局部变量，而是应该作为一个全部变量来进行存储</p>
<figure class="highlight js hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">let</span> state = <span class="hljs-literal">null</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">useState</span>(<span class="hljs-params">init</span>) </span>&#123;</span><br><span class="line">  state = state === <span class="hljs-literal">null</span> ? init : state</span><br><span class="line">  <span class="hljs-keyword">const</span> setState = <span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> &#123;   <span class="hljs-comment">// 修改 state 的方法</span></span><br><span class="line">    state = value</span><br><span class="line">    workInProgressRoot = &#123;      <span class="hljs-comment">// 只要修改了 state，我们就需要重新处理节点</span></span><br><span class="line">      dom: currentRoot.dom,</span><br><span class="line">      props: currentRoot.props,</span><br><span class="line">      alternate: currentRoot</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="hljs-comment">// 修改 nextUnitOfWork 指向 workInProgressRoot，这样下次就会处理这个节点了</span></span><br><span class="line">    nextUnitOfWork = workInProgressRoot</span><br><span class="line">    deletions = []</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="hljs-keyword">return</span> [state, setState]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样其实我们就可以使用了</p>
<h4 id="支持多个-state"><a href="#支持多个-state" class="headerlink" title="支持多个 state"></a>支持多个 state</h4><p>但是上面的代码当中只有一个 <code>state</code> 变量，如果我们有多个 <code>useState</code> 怎么办呢？为了能支持多个 <code>useState</code>，我们的 <code>state</code> 就不能是一个简单的值了，我们可以考虑把他改成一个数组，多个 <code>useState</code> 按照调用顺序放进这个数组里面，访问的时候通过下标来访问</p>
<figure class="highlight js hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">let</span> state = []</span><br><span class="line"><span class="hljs-keyword">let</span> hookIndex = <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">useState</span>(<span class="hljs-params">init</span>) </span>&#123;</span><br><span class="line">  <span class="hljs-keyword">const</span> currentIndex = hookIndex</span><br><span class="line">  state[currentIndex] = state[currentIndex] === <span class="hljs-literal">undefined</span> ? init : state[currentIndex]</span><br><span class="line">  <span class="hljs-keyword">const</span> setState = <span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> &#123;</span><br><span class="line">    state[currentIndex] = value</span><br><span class="line">    workInProgressRoot = &#123;</span><br><span class="line">      dom: currentRoot.dom,</span><br><span class="line">      props: currentRoot.props,</span><br><span class="line">      alternate: currentRoot</span><br><span class="line">    &#125;</span><br><span class="line">    nextUnitOfWork = workInProgressRoot</span><br><span class="line">    deletions = []</span><br><span class="line">  &#125;</span><br><span class="line">  hookIndex++</span><br><span class="line">  <span class="hljs-keyword">return</span> [state[currentIndex], setState]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="支持多个组件"><a href="#支持多个组件" class="headerlink" title="支持多个组件"></a>支持多个组件</h4><p>上面的代码虽然我们支持了多个 <code>useState</code>，但是仍然只有一套全局变量，如果有多个函数组件，每个组件都来操作这个全局变量，那相互之间不就是污染了数据了吗？所以我们数据还不能全都存在全局变量上面，而是应该存在每个 <code>Fiber</code> 节点上，处理这个节点的时候再将状态放到全局变量用来通讯</p>
<figure class="highlight js hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">// 申明两个全局变量，用来处理 useState</span></span><br><span class="line"><span class="hljs-comment">// wipFiber 是当前的函数组件 fiber 节点</span></span><br><span class="line"><span class="hljs-comment">// hookIndex 是当前函数组件内部 useState 状态计数</span></span><br><span class="line"><span class="hljs-keyword">let</span> wipFiber = <span class="hljs-literal">null</span></span><br><span class="line"><span class="hljs-keyword">let</span> hookIndex = <span class="hljs-literal">null</span></span><br></pre></td></tr></table></figure>

<p>因为 <code>useState</code> 只在函数组件里面可以用，所以我们之前的 <code>updateFunctionComponent</code> 里面需要初始化处理 <code>useState</code> 变量</p>
<figure class="highlight js hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">updateFunctionComponent</span>(<span class="hljs-params">fiber</span>) </span>&#123;</span><br><span class="line">  wipFiber = fiber     <span class="hljs-comment">// 支持 useState，初始化变量</span></span><br><span class="line">  hookIndex = <span class="hljs-number">0</span></span><br><span class="line">  wipFiber.hooks = []  <span class="hljs-comment">// hooks 用来存储具体的 state 序列</span></span><br><span class="line"></span><br><span class="line">  <span class="hljs-comment">// ...</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>因为 <code>Hooks</code> 队列放到 <code>Fiber</code> 节点上去了，所以我们在 <code>useState</code> 取之前的值时需要从 <code>fiber.alternate</code> 上取，完整代码如下</p>
<figure class="highlight js hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">useState</span>(<span class="hljs-params">init</span>) </span>&#123;</span><br><span class="line">  <span class="hljs-keyword">const</span> oldHook = wipFiber.alternate        <span class="hljs-comment">// 取出上次的 Hook</span></span><br><span class="line">    &amp;&amp; wipFiber.alternate.hooks</span><br><span class="line">    &amp;&amp; wipFiber.alternate.hooks[hookIndex]</span><br><span class="line">  <span class="hljs-keyword">const</span> hook = &#123;                            <span class="hljs-comment">// Hook 数据结构</span></span><br><span class="line">    state: oldHook ? oldHook.state : init   <span class="hljs-comment">// state 是每个具体的值</span></span><br><span class="line">  &#125;</span><br><span class="line">  wipFiber.hooks.push(hook)                 <span class="hljs-comment">// 将所有 useState 调用按照顺序存到 fiber 节点上</span></span><br><span class="line">  hookIndex++</span><br><span class="line">  <span class="hljs-keyword">const</span> setState = <span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> &#123;               <span class="hljs-comment">// 修改 state 的方法</span></span><br><span class="line">    hook.state = value</span><br><span class="line">    workInProgressRoot = &#123;                  <span class="hljs-comment">// 只要修改了 state，我们就需要重新处理这个节点</span></span><br><span class="line">      dom: currentRoot.dom,</span><br><span class="line">      props: currentRoot.props,</span><br><span class="line">      alternate: currentRoot</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="hljs-comment">// 修改 nextUnitOfWork 指向 workInProgressRoot，这样下次 requestIdleCallback 就会处理这个节点了</span></span><br><span class="line">    nextUnitOfWork = workInProgressRoot</span><br><span class="line">    deletions = []</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="hljs-keyword">return</span> [hook.state, setState]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在上面的代码当中可以看出，我们在将 <code>useState</code> 和存储的 <code>state</code> 进行匹配的时候是用的 <code>useState</code> 的调用顺序匹配 <code>state</code> 的下标，如果这个下标匹配不上了，<code>state</code> 就错了，所以在 <code>React</code> 文档当中特意强调了不要在判断当中使用 <code>useState</code></p>
<figure class="highlight js hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">if</span> (something) &#123;</span><br><span class="line">  <span class="hljs-keyword">const</span> [state, setState] = useState(<span class="hljs-number">1</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>比如上述代码就不能保证每次 <code>something</code> 都满足，可能导致 <code>useState</code> 这次 <code>render</code> 执行了，下次又没执行，这样新老节点的下标就匹配不上了，对于这种代码，<code>React</code> 就会直接报错</p>
<p><img src="https://gitee.com/heptaluan/backups/raw/master/cdn/react/19-03.png" alt></p>
<h2 id="用-Hooks-模拟-Class-组件"><a href="#用-Hooks-模拟-Class-组件" class="headerlink" title="用 Hooks 模拟 Class 组件"></a>用 Hooks 模拟 Class 组件</h2><p>这个算是一个扩展功能，通过前面实现的 <code>Hooks</code> 来模拟实现 <code>Class</code> 组件，我们可以写一个方法将 <code>Class</code> 组件转化为前面的函数组件</p>
<figure class="highlight js hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">transfer</span>(<span class="hljs-params">Component</span>) </span>&#123;</span><br><span class="line">  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">props</span>) </span>&#123;</span><br><span class="line">    <span class="hljs-keyword">const</span> component = <span class="hljs-keyword">new</span> Component(props)</span><br><span class="line">    <span class="hljs-keyword">let</span> [state, setState] = useState(component.state)</span><br><span class="line">    component.props = props</span><br><span class="line">    component.state = state</span><br><span class="line">    component.setState = setState</span><br><span class="line">    <span class="hljs-keyword">return</span> component.render()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后就可以写 <code>Class</code> 了，这个 <code>Class</code> 长得很像我们在 <code>React</code> 里面写的 <code>Class</code>，有 <code>state</code>，<code>setState</code> 和 <code>render</code></p>
<figure class="highlight js hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">import</span> React <span class="hljs-keyword">from</span> <span class="hljs-string">'./myReact'</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Count</span> </span>&#123;</span><br><span class="line">  <span class="hljs-keyword">constructor</span>(props) &#123;</span><br><span class="line">    <span class="hljs-keyword">this</span>.props = props</span><br><span class="line">    <span class="hljs-keyword">this</span>.state = &#123;</span><br><span class="line">      count: <span class="hljs-number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  onClickHandler = <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="hljs-keyword">this</span>.setState(&#123;</span><br><span class="line">      count: <span class="hljs-keyword">this</span>.state.count + <span class="hljs-number">1</span></span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="hljs-keyword">return</span> (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;h3&gt;Class Component Count: &#123;<span class="hljs-keyword">this</span>.state.count&#125;&lt;<span class="hljs-regexp">/h3&gt;</span></span><br><span class="line"><span class="hljs-regexp">        &lt;button onClick=&#123;this.onClickHandler&#125;&gt;Count + 1&lt;/</span>button&gt;</span><br><span class="line">      &lt;<span class="hljs-regexp">/div&gt;</span></span><br><span class="line"><span class="hljs-regexp">    )</span></span><br><span class="line"><span class="hljs-regexp">  &#125;</span></span><br><span class="line"><span class="hljs-regexp">&#125;</span></span><br><span class="line"><span class="hljs-regexp"></span></span><br><span class="line"><span class="hljs-regexp">/</span><span class="hljs-regexp">/ export 的时候用 transfer 包装下</span></span><br><span class="line"><span class="hljs-regexp">export default React.transfer(Count)</span></span><br></pre></td></tr></table></figure>

<p>然后使用的时候直接使用 <code>&lt;Count&gt;</code> 就行了</p>
<figure class="highlight js hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;div&gt;</span><br><span class="line">  &lt;Count&gt;<span class="hljs-xml"><span class="hljs-tag">&lt;/<span class="hljs-name">Count</span>&gt;</span></span></span><br><span class="line">&lt;<span class="hljs-regexp">/div&gt;</span></span><br></pre></td></tr></table></figure>

<p>当然你也可以在 <code>React</code> 里面建一个空的 <code>Class Component</code>，让 <code>Count</code> 继承它，这样就更像了</p>
<h2 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h2><p>汇总以后的代码如下，完整代码地址可见 <a href="https://github.com/heptaluan/react-example/tree/master/example/Fiber%20%E6%9E%B6%E6%9E%84%E7%9A%84%E7%AE%80%E5%8D%95%E5%AE%9E%E7%8E%B0" target="_blank" rel="noopener">Fiber 架构的简单实现</a></p>
<figure class="highlight js hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">// 最基本的 vDom</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createTextVDom</span>(<span class="hljs-params">text</span>) </span>&#123;</span><br><span class="line">  <span class="hljs-keyword">return</span> &#123;</span><br><span class="line">    type: <span class="hljs-string">'TEXT'</span>,</span><br><span class="line">    props: &#123;</span><br><span class="line">      nodeValue: text,</span><br><span class="line">      children: []</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createElement</span>(<span class="hljs-params">type, props, ...children</span>) </span>&#123;</span><br><span class="line">  <span class="hljs-comment">// 核心逻辑不复杂，将参数都房到一个对象上返回就行</span></span><br><span class="line">  <span class="hljs-comment">// 将 children 放到 props 当中，这样我们在组件里面就能通过 this.props.children 拿到子元素</span></span><br><span class="line">  <span class="hljs-keyword">return</span> &#123;</span><br><span class="line">    type,</span><br><span class="line">    props: &#123;</span><br><span class="line">      ...props,</span><br><span class="line">      children: children.map(<span class="hljs-function"><span class="hljs-params">child</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-keyword">typeof</span> child === <span class="hljs-string">'object'</span> ? child : createTextVDom(child)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// 创建 DOM 的操作</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createDom</span>(<span class="hljs-params">vDom</span>) </span>&#123;</span><br><span class="line">  <span class="hljs-keyword">let</span> dom</span><br><span class="line">  <span class="hljs-comment">// 检查当前节点是文本还是对象</span></span><br><span class="line">  <span class="hljs-keyword">if</span> (vDom.type === <span class="hljs-string">'TEXT'</span>) &#123;</span><br><span class="line">    dom = <span class="hljs-built_in">document</span>.createTextNode(vDom.props.nodeValue)</span><br><span class="line">  &#125; <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">    dom = <span class="hljs-built_in">document</span>.createElement(vDom.type)</span><br><span class="line">    <span class="hljs-comment">// 将 vDom 上除了 children 外的属性都挂载到真正的 DOM 上去</span></span><br><span class="line">    <span class="hljs-keyword">if</span> (vDom.props) &#123;</span><br><span class="line">      <span class="hljs-built_in">Object</span>.keys(vDom.props)</span><br><span class="line">        .filter(<span class="hljs-function"><span class="hljs-params">key</span> =&gt;</span> key !== <span class="hljs-string">'children'</span>)</span><br><span class="line">        .forEach(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="hljs-keyword">if</span> (item.indexOf(<span class="hljs-string">'on'</span>) === <span class="hljs-number">0</span>) &#123;</span><br><span class="line">            dom.addEventListener(item.substr(<span class="hljs-number">2</span>).toLowerCase(), vDom.props[item], <span class="hljs-literal">false</span>)</span><br><span class="line">          &#125; <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">            dom[item] = vDom.props[item]</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="hljs-keyword">return</span> dom</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// 更新 DOM 的操作</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">updateDom</span>(<span class="hljs-params">dom, prevProps, nextProps</span>) </span>&#123;</span><br><span class="line">  <span class="hljs-comment">// 1. 过滤 children 属性</span></span><br><span class="line">  <span class="hljs-comment">// 2. 老的存在，新的没了，取消</span></span><br><span class="line">  <span class="hljs-comment">// 3. 新的存在，老的没有，新增</span></span><br><span class="line">  <span class="hljs-built_in">Object</span>.keys(prevProps)</span><br><span class="line">    .filter(<span class="hljs-function"><span class="hljs-params">name</span> =&gt;</span> name !== <span class="hljs-string">'children'</span>)</span><br><span class="line">    .filter(<span class="hljs-function"><span class="hljs-params">name</span> =&gt;</span> !(name <span class="hljs-keyword">in</span> nextProps))</span><br><span class="line">    .forEach(<span class="hljs-function"><span class="hljs-params">name</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="hljs-keyword">if</span> (name.indexOf(<span class="hljs-string">'on'</span>) === <span class="hljs-number">0</span>) &#123;</span><br><span class="line">        dom.removeEventListener(name.substr(<span class="hljs-number">2</span>).toLowerCase(), prevProps[name], <span class="hljs-literal">false</span>)</span><br><span class="line">      &#125; <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">        dom[name] = <span class="hljs-string">''</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  <span class="hljs-built_in">Object</span>.keys(nextProps)</span><br><span class="line">    .filter(<span class="hljs-function"><span class="hljs-params">name</span> =&gt;</span> name !== <span class="hljs-string">'children'</span>)</span><br><span class="line">    .forEach(<span class="hljs-function"><span class="hljs-params">name</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="hljs-keyword">if</span> (name.indexOf(<span class="hljs-string">'on'</span>) === <span class="hljs-number">0</span>) &#123;</span><br><span class="line">        dom.addEventListener(name.substr(<span class="hljs-number">2</span>).toLowerCase(), nextProps[name], <span class="hljs-literal">false</span>)</span><br><span class="line">      &#125; <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">        dom[name] = nextProps[name]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// 统一操作 DOM</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">commitRoot</span>(<span class="hljs-params"></span>) </span>&#123;</span><br><span class="line">  deletions.forEach(commitRootImpl)         <span class="hljs-comment">// 执行真正的节点删除</span></span><br><span class="line">  commitRootImpl(workInProgressRoot.child)  <span class="hljs-comment">// 开启递归</span></span><br><span class="line">  currentRoot = workInProgressRoot          <span class="hljs-comment">// 记录一下 currentRoot</span></span><br><span class="line">  workInProgressRoot = <span class="hljs-literal">null</span>                 <span class="hljs-comment">// 操作完后将 workInProgressRoot 重置</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">commitDeletion</span>(<span class="hljs-params">fiber, domParent</span>) </span>&#123;</span><br><span class="line">  <span class="hljs-keyword">if</span> (fiber.dom) &#123;</span><br><span class="line">    domParent.removeChild(fiber.dom)        <span class="hljs-comment">// DOM 存在，是普通节点</span></span><br><span class="line">  &#125; <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">    commitDeletion(fiber.child, domParent)  <span class="hljs-comment">// DOM 不存在，是函数组件，向下递归查找真实 DOM</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">commitRootImpl</span>(<span class="hljs-params">fiber</span>) </span>&#123;</span><br><span class="line">  <span class="hljs-keyword">if</span> (!fiber) &#123;</span><br><span class="line">    <span class="hljs-keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="hljs-comment">// 不再直接获取，而是向上查找真正的 DOM</span></span><br><span class="line">  <span class="hljs-comment">// const parentDom = fiber.return.dom</span></span><br><span class="line">  <span class="hljs-keyword">let</span> parentFiber = fiber.return</span><br><span class="line">  <span class="hljs-keyword">while</span> (!parentFiber.dom) &#123;</span><br><span class="line">    parentFiber = parentFiber.return</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="hljs-keyword">const</span> parentDom = parentFiber.dom</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">if</span> (fiber.effectTag === <span class="hljs-string">'REPLACEMENT'</span> &amp;&amp; fiber.dom) &#123;</span><br><span class="line">    parentDom.appendChild(fiber.dom)</span><br><span class="line">  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (fiber.effectTag === <span class="hljs-string">'DELETION'</span>) &#123;</span><br><span class="line">    <span class="hljs-comment">// 这里也不再使用 parentDom.removeChild(fiber.dom)</span></span><br><span class="line">    commitDeletion(fiber, parentDom)</span><br><span class="line">  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (fiber.effectTag === <span class="hljs-string">'UPDATE'</span> &amp;&amp; fiber.dom) &#123;</span><br><span class="line">    <span class="hljs-comment">// 更新 DOM 属性</span></span><br><span class="line">    updateDom(fiber.dom, fiber.alternate.props, fiber.props)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="hljs-comment">// 递归操作子元素和兄弟元素</span></span><br><span class="line">  commitRootImpl(fiber.child)</span><br><span class="line">  commitRootImpl(fiber.sibling)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// 任务调度，使用 workLoop 用来调度任务</span></span><br><span class="line"><span class="hljs-keyword">let</span> nextUnitOfWork = <span class="hljs-literal">null</span></span><br><span class="line"><span class="hljs-keyword">let</span> workInProgressRoot = <span class="hljs-literal">null</span></span><br><span class="line"><span class="hljs-keyword">let</span> currentRoot = <span class="hljs-literal">null</span></span><br><span class="line"><span class="hljs-keyword">let</span> deletions = <span class="hljs-literal">null</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">workLoop</span>(<span class="hljs-params">deadline</span>) </span>&#123;</span><br><span class="line">  <span class="hljs-keyword">while</span> (nextUnitOfWork &amp;&amp; deadline.timeRemaining() &gt; <span class="hljs-number">1</span>) &#123;</span><br><span class="line">    <span class="hljs-comment">// 这个 while 循环会在任务执行完或者时间到了的时候结束</span></span><br><span class="line">    nextUnitOfWork = performUnitOfWork(nextUnitOfWork)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="hljs-comment">// 任务做完后统一渲染</span></span><br><span class="line">  <span class="hljs-keyword">if</span> (!nextUnitOfWork &amp;&amp; workInProgressRoot) &#123;</span><br><span class="line">    commitRoot()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="hljs-comment">// 如果任务还没完，但是时间到了，我们需要继续注册 requestIdleCallback</span></span><br><span class="line">  requestIdleCallback(workLoop)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">buildNewFiber</span>(<span class="hljs-params">fiber, workInProgressFiber</span>) </span>&#123;</span><br><span class="line">  <span class="hljs-keyword">return</span> &#123;</span><br><span class="line">    type: fiber.type,</span><br><span class="line">    props: fiber.props,</span><br><span class="line">    dom: <span class="hljs-literal">null</span>,                    <span class="hljs-comment">// 构建 fiber 时没有 DOM，下次 perform 这个节点是才创建 DOM </span></span><br><span class="line">    <span class="hljs-keyword">return</span>: workInProgressFiber,</span><br><span class="line">    alternate: <span class="hljs-literal">null</span>,              <span class="hljs-comment">// 新增的没有老状态</span></span><br><span class="line">    effectTag: <span class="hljs-string">'REPLACEMENT'</span>      <span class="hljs-comment">// 添加一个操作标记</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">reconcileChildren</span>(<span class="hljs-params">workInProgressFiber, elements</span>) </span>&#123;</span><br><span class="line">  <span class="hljs-comment">// 构建 fiber 结构</span></span><br><span class="line">  <span class="hljs-keyword">let</span> oldFiber = workInProgressFiber.alternate</span><br><span class="line">    &amp;&amp; workInProgressFiber.alternate.child         <span class="hljs-comment">// 获取上次的 fiber 树</span></span><br><span class="line">  <span class="hljs-keyword">let</span> prevSibling = <span class="hljs-literal">null</span></span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">let</span> index = <span class="hljs-number">0</span></span><br><span class="line">  <span class="hljs-keyword">if</span> (elements &amp;&amp; elements.length) &#123;</span><br><span class="line">    <span class="hljs-keyword">if</span> (!oldFiber) &#123;                               <span class="hljs-comment">// 第一次没有 oldFiber，那全部是 REPLACEMENT</span></span><br><span class="line">      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; elements.length; i++) &#123;</span><br><span class="line">        <span class="hljs-keyword">const</span> element = elements[i]</span><br><span class="line">        <span class="hljs-keyword">const</span> newFiber = buildNewFiber(element, workInProgressFiber)</span><br><span class="line">        <span class="hljs-keyword">if</span> (i === <span class="hljs-number">0</span>) &#123;                             <span class="hljs-comment">// 父级的 child 指向第一个子元素</span></span><br><span class="line">          workInProgressFiber.child = newFiber</span><br><span class="line">        &#125; <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">          prevSibling.sibling = newFiber           <span class="hljs-comment">// 每个子元素拥有指向下一个子元素的指针</span></span><br><span class="line">        &#125;</span><br><span class="line">        prevSibling = newFiber</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">while</span> (index &lt; elements.length &amp;&amp; oldFiber) &#123;</span><br><span class="line">      <span class="hljs-keyword">let</span> element = elements[index]</span><br><span class="line">      <span class="hljs-keyword">let</span> newFiber = <span class="hljs-literal">null</span></span><br><span class="line">      <span class="hljs-keyword">const</span> sameType = oldFiber                    <span class="hljs-comment">// 对比 oldFiber 和当前 element（检测类型是否一样）</span></span><br><span class="line">        &amp;&amp; element</span><br><span class="line">        &amp;&amp; oldFiber.type === element.type</span><br><span class="line">      <span class="hljs-keyword">if</span> (sameType) &#123;                              <span class="hljs-comment">// 先比较元素类型，如果类型一样，复用节点，更新 props</span></span><br><span class="line">        newFiber = &#123;</span><br><span class="line">          type: oldFiber.type,</span><br><span class="line">          props: element.props,</span><br><span class="line">          dom: oldFiber.dom,</span><br><span class="line">          <span class="hljs-keyword">return</span>: workInProgressFiber,</span><br><span class="line">          alternate: oldFiber,                     <span class="hljs-comment">// 记录下上次状态</span></span><br><span class="line">          effectTag: <span class="hljs-string">'UPDATE'</span>                      <span class="hljs-comment">// 添加一个操作标记</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!sameType &amp;&amp; element) &#123;           <span class="hljs-comment">// 如果类型不一样，有新的节点，创建新节点替换老节点</span></span><br><span class="line">        newFiber = buildNewFiber(element, workInProgressFiber)</span><br><span class="line">      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!sameType &amp;&amp; oldFiber) &#123;          <span class="hljs-comment">// 如果类型不一样，没有新节点，有老节点，删除老节点</span></span><br><span class="line">        oldFiber.effectTag = <span class="hljs-string">'DELETION'</span>            <span class="hljs-comment">// 添加删除标记</span></span><br><span class="line">        deletions.push(oldFiber)                   <span class="hljs-comment">// 一个数组收集所有需要删除的节点</span></span><br><span class="line">      &#125;</span><br><span class="line">      oldFiber = oldFiber.sibling                  <span class="hljs-comment">// 循环处理兄弟元素</span></span><br><span class="line">      <span class="hljs-keyword">if</span> (index === <span class="hljs-number">0</span>) &#123;                           <span class="hljs-comment">// 父级的child指向第一个子元素</span></span><br><span class="line">        workInProgressFiber.child = newFiber</span><br><span class="line">      &#125; <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">        prevSibling.sibling = newFiber             <span class="hljs-comment">// 每个子元素拥有指向下一个子元素的指针</span></span><br><span class="line">      &#125;</span><br><span class="line">      prevSibling = newFiber</span><br><span class="line">      index++</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// 申明两个全局变量，用来处理 useState</span></span><br><span class="line"><span class="hljs-comment">// wipFiber 是当前的函数组件 fiber 节点</span></span><br><span class="line"><span class="hljs-comment">// hookIndex 是当前函数组件内部 useState 状态计数</span></span><br><span class="line"><span class="hljs-keyword">let</span> wipFiber = <span class="hljs-literal">null</span></span><br><span class="line"><span class="hljs-keyword">let</span> hookIndex = <span class="hljs-literal">null</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">useState</span>(<span class="hljs-params">init</span>) </span>&#123;</span><br><span class="line">  <span class="hljs-keyword">const</span> oldHook = wipFiber.alternate        <span class="hljs-comment">// 取出上次的 Hook</span></span><br><span class="line">    &amp;&amp; wipFiber.alternate.hooks</span><br><span class="line">    &amp;&amp; wipFiber.alternate.hooks[hookIndex]</span><br><span class="line">  <span class="hljs-keyword">const</span> hook = &#123;                            <span class="hljs-comment">// Hook 数据结构</span></span><br><span class="line">    state: oldHook ? oldHook.state : init   <span class="hljs-comment">// state 是每个具体的值</span></span><br><span class="line">  &#125;</span><br><span class="line">  wipFiber.hooks.push(hook)                 <span class="hljs-comment">// 将所有 useState 调用按照顺序存到 fiber 节点上</span></span><br><span class="line">  hookIndex++</span><br><span class="line">  <span class="hljs-keyword">const</span> setState = <span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> &#123;               <span class="hljs-comment">// 修改 state 的方法</span></span><br><span class="line">    hook.state = value</span><br><span class="line">    workInProgressRoot = &#123;                  <span class="hljs-comment">// 只要修改了 state，我们就需要重新处理这个节点</span></span><br><span class="line">      dom: currentRoot.dom,</span><br><span class="line">      props: currentRoot.props,</span><br><span class="line">      alternate: currentRoot</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="hljs-comment">// 修改 nextUnitOfWork 指向 workInProgressRoot，这样下次 requestIdleCallback 就会处理这个节点了</span></span><br><span class="line">    nextUnitOfWork = workInProgressRoot</span><br><span class="line">    deletions = []</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="hljs-keyword">return</span> [hook.state, setState]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">updateFunctionComponent</span>(<span class="hljs-params">fiber</span>) </span>&#123;</span><br><span class="line">  wipFiber = fiber                            <span class="hljs-comment">// 支持 useState，初始化变量</span></span><br><span class="line">  hookIndex = <span class="hljs-number">0</span></span><br><span class="line">  wipFiber.hooks = []                         <span class="hljs-comment">// Hooks 用来存储具体的 state 序列</span></span><br><span class="line">  <span class="hljs-keyword">const</span> children = [fiber.type(fiber.props)]  <span class="hljs-comment">// 函数组件的 type 就是个函数，直接拿来执行可以获得 DOM 元素</span></span><br><span class="line">  reconcileChildren(fiber, children)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// updateHostComponent 就是之前的操作，只是单独抽取了一个方法</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">updateHostComponent</span>(<span class="hljs-params">fiber</span>) </span>&#123;</span><br><span class="line">  <span class="hljs-keyword">if</span> (!fiber.dom) &#123;</span><br><span class="line">    <span class="hljs-comment">// 创建一个 DOM 挂载上去</span></span><br><span class="line">    fiber.dom = createDom(fiber)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="hljs-comment">// 将我们前面的 vDom 结构转换为 fiber 结构</span></span><br><span class="line">  <span class="hljs-keyword">const</span> elements = fiber.props.children</span><br><span class="line"></span><br><span class="line">  <span class="hljs-comment">// 协调子元素</span></span><br><span class="line">  reconcileChildren(fiber, elements)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// performUnitOfWork 用来执行任务，参数是我们的当前 fiber 任务，返回值是下一个任务</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">performUnitOfWork</span>(<span class="hljs-params">fiber</span>) </span>&#123;</span><br><span class="line">  <span class="hljs-comment">// 检测函数组件</span></span><br><span class="line">  <span class="hljs-keyword">const</span> isFunctionComponent = fiber.type <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Function</span></span><br><span class="line">  <span class="hljs-keyword">if</span> (isFunctionComponent) &#123;</span><br><span class="line">    updateFunctionComponent(fiber)</span><br><span class="line">  &#125; <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">    updateHostComponent(fiber)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="hljs-comment">// 这个函数的返回值是下一个任务，这其实是一个深度优先遍历</span></span><br><span class="line">  <span class="hljs-comment">// 先找子元素，没有子元素了就找兄弟元素，兄弟元素也没有了就返回父元素</span></span><br><span class="line">  <span class="hljs-comment">// 然后再找这个父元素的兄弟元素，最后到根节点结束</span></span><br><span class="line">  <span class="hljs-comment">// 这个遍历的顺序其实就是从上到下，从左到右</span></span><br><span class="line">  <span class="hljs-keyword">if</span> (fiber.child) &#123;</span><br><span class="line">    <span class="hljs-keyword">return</span> fiber.child</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">let</span> nextFiber = fiber</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">while</span> (nextFiber) &#123;</span><br><span class="line">    <span class="hljs-keyword">if</span> (nextFiber.sibling) &#123;</span><br><span class="line">      <span class="hljs-keyword">return</span> nextFiber.sibling</span><br><span class="line">    &#125;</span><br><span class="line">    nextFiber = nextFiber.return</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// 使用 requestIdleCallback 开启 workLoop</span></span><br><span class="line">requestIdleCallback(workLoop)</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">render</span>(<span class="hljs-params">vDom, container</span>) </span>&#123;</span><br><span class="line">  workInProgressRoot = &#123;</span><br><span class="line">    dom: container,</span><br><span class="line">    props: &#123;</span><br><span class="line">      children: [vDom]</span><br><span class="line">    &#125;,</span><br><span class="line">    alternate: currentRoot</span><br><span class="line">  &#125;</span><br><span class="line">  deletions = []</span><br><span class="line">  nextUnitOfWork = workInProgressRoot</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Component</span> </span>&#123;</span><br><span class="line">  <span class="hljs-keyword">constructor</span>(props) &#123;</span><br><span class="line">    <span class="hljs-keyword">this</span>.props = props</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">transfer</span>(<span class="hljs-params">Component</span>) </span>&#123;</span><br><span class="line">  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">props</span>) </span>&#123;</span><br><span class="line">    <span class="hljs-keyword">const</span> component = <span class="hljs-keyword">new</span> Component(props)</span><br><span class="line">    <span class="hljs-keyword">let</span> [state, setState] = useState(component.state)</span><br><span class="line">    component.props = props</span><br><span class="line">    component.state = state</span><br><span class="line">    component.setState = setState</span><br><span class="line">    <span class="hljs-keyword">return</span> component.render()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> &#123;</span><br><span class="line">  createElement,</span><br><span class="line">  render,</span><br><span class="line">  useState,</span><br><span class="line">  Component,</span><br><span class="line">  transfer</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>我们简单总结一下上面涉及到的一些知识点</p>
<ol>
<li>我们写的 <code>JSX</code> 代码最终会被 <code>Babel</code> 转化成了 <code>React.createElement()</code> 的形式</li>
<li><code>React.createElement()</code> 返回的其实就是虚拟 <code>DOM</code> 结构</li>
<li><code>ReactDOM.render</code> 方法是将 <code>vDom</code> 渲染到页面上</li>
<li><code>vDom</code> 的协调和渲染可以简单粗暴的递归，但是这个过程是同步的，如果需要处理的节点过多，可能会阻塞用户输入和动画播放，造成卡顿</li>
<li>为了解决这个问题，<code>React</code> 引入了 <code>Fiber</code> 结构，目的是将同步的协调变成异步的</li>
<li><code>Fiber</code> 改造了 <code>vDom</code> 的结构，形成具有『父元素 ==&gt; 第一个子元素』，『子元素 ==&gt; 兄弟元素』，『子元素 ==&gt; 父元素』这样的链表结构，有了这几个指针，可以从任意一个 <code>Fiber</code> 节点找到其他节点</li>
<li><code>Fiber</code> 将整棵树的同步任务拆分成了每个节点可以单独执行的异步执行结构</li>
<li><code>Fiber</code> 可以从任意一个节点开始遍历，遍历是深度优先遍历，顺序是『父元素 ==&gt; 子元素 ==&gt; 兄弟元素 ==&gt; 父元素』，也就是从上往下，从左往右</li>
<li><code>Fiber</code> 的协调阶段可以是异步的小任务，但是提交阶段（<code>commit</code>）必须是同步的，因为异步的 <code>commit</code> 可能让用户看到节点一个一个接连出现，体验不好</li>
<li>函数组件其实就是这个节点的 <code>type</code> 是个函数，直接将 <code>type</code> 拿来运行就可以得到 <code>vDom</code></li>
<li><code>useState</code> 是在 <code>Fiber</code> 节点上添加了一个数组，数组里面的每个值对应了一个 <code>useState</code>，<code>useState</code> 调用顺序必须和这个数组下标匹配，不然会报错（所以不能在判断当中使用 <code>useState</code>）</li>
</ol>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a href="https://github.com/facebook/react/blob/4c7036e807fa18a3e21a5182983c7c0f05c5936e/packages/react-reconciler/src/ReactFiberWorkLoop.new.js" target="_blank" rel="noopener">ReactFiberWorkLoop.new</a></li>
<li><a href="http://conf2017.reactjs.org/speakers/lin" target="_blank" rel="noopener">A Cartoon Intro to Fiber</a></li>
<li><a href="https://juejin.cn/post/6844903582622285831" target="_blank" rel="noopener">React Fiber</a></li>
<li><a href="https://juejin.cn/post/6844903712285016071" target="_blank" rel="noopener">浅析 React Fiber</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/37095662" target="_blank" rel="noopener">React Fiber 架构</a></li>
</ul>

        </div>
        
        <div class="level is-size-7 is-uppercase">
            <div class="level-start">
                <div class="level-item">
                    <span class="is-size-6 has-text-grey has-mr-7">#</span>
                    <a class="has-link-grey -link" href="/tags/React/">React</a>
                </div>
            </div>
        </div>
        
        
        
    </div>
</div>





<div class="card card-transparent">
    <div class="level post-navigation is-flex-wrap is-mobile">
        
        <div class="level-start">
            <a class="level level-item has-link-grey  article-nav-prev" href="/2020/12/26/JavaScript/56/">
                <i class="level-item fa fa-chevron-left"></i>
                <span class="level-item">重温 TypeScript</span>
            </a>
        </div>
        
        
        <div class="level-end">
            <a class="level level-item has-link-grey  article-nav-next" href="/2020/12/06/React/18/">
                <span class="level-item">深入 React Fiber</span>
                <i class="level-item fa fa-chevron-right"></i>
            </a>
        </div>
        
    </div>
</div>



<div class="card">
    <div class="card-content">
        <h3 class="title is-5 has-text-weight-normal">评论</h3>
        
<div id="comment-container"></div>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1.4.1/dist/gitalk.css">
<script src="https://cdn.jsdelivr.net/npm/gitalk@1.4.1/dist/gitalk.min.js"></script>
<script>
    var gitalk = new Gitalk({
        clientID: '584b59de0d23cd48fbdd',
        clientSecret: '5554c9aab0a640015867806f438bd2e10f297e5a',
        id: '7fa9722b3aa3a8931abd61b378722bea',
        repo: 'gitalk',
        owner: 'heptaluan',
        admin: "heptaluan"
    })
    gitalk.render('comment-container')
</script>

    </div>
</div>
</div>
                




<div class="column is-4-tablet is-4-desktop is-3-widescreen  has-order-1 column-left ">
    
        
<div class="card widget">
    <div class="card-content">
        <nav class="level">
            <div class="level-item has-text-centered">
                <div>
                    
                        <figure class="avatar image is-128x128 has-mb-6">
                            <img class="is-rounded" src="https://gitee.com/heptaluan/backups/raw/master/cdn/avatar.png" alt="heptaluan">
                        </figure>
                    
                    
                    <p class="is-size-4 is-block">
                        heptaluan
                    </p>
                    
                    
                    <p class="is-size-6 is-block">
                        Torches@Aimer
                    </p>
                    
                    
                    <p class="is-size-6 is-flex is-flex-center has-text-grey">
                        <i class="fas fa-map-marker-alt has-mr-7"></i>
                        <span>WuHan China</span>
                    </p>
                    
                </div>
            </div>
        </nav>
        <!-- <nav class="level is-mobile">
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        文章
                    </p>
                    <p class="title has-text-weight-normal">
                        151
                    </p>
                </div>
            </div>
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        分类
                    </p>
                    <p class="title has-text-weight-normal">
                        8
                    </p>
                </div>
            </div>
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        标签
                    </p>
                    <p class="title has-text-weight-normal">
                        8
                    </p>
                </div>
            </div>
        </nav> -->
        <!-- <div class="level">
            <a class="level-item button is-link is-rounded" href="https://github.com/ppoffice" target="_blank">
                关注我</a>
        </div> -->
        
        
    </div>
</div>
    
        
<div class="card widget" id="toc">
    <div class="card-content">
        <div class="menu">
            <h3 class="menu-label">
                目录
            </h3>
            <ul class="menu-list"><li>
        <a class="is-flex" href="#JSX">
        <span class="has-mr-6">1</span>
        <span>JSX</span>
        </a></li><li>
        <a class="is-flex" href="#createElement">
        <span class="has-mr-6">2</span>
        <span>createElement</span>
        </a></li><li>
        <a class="is-flex" href="#render">
        <span class="has-mr-6">3</span>
        <span>render</span>
        </a></li><li>
        <a class="is-flex" href="#render-的拆分">
        <span class="has-mr-6">4</span>
        <span>render 的拆分</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#requestIdleCallback">
        <span class="has-mr-6">4.1</span>
        <span>requestIdleCallback</span>
        </a></li><li>
        <a class="is-flex" href="#Fiber-数据结构">
        <span class="has-mr-6">4.2</span>
        <span>Fiber 数据结构</span>
        </a></li></ul></li><li>
        <a class="is-flex" href="#Fiber-的实现">
        <span class="has-mr-6">5</span>
        <span>Fiber 的实现</span>
        </a></li><li>
        <a class="is-flex" href="#统一提交">
        <span class="has-mr-6">6</span>
        <span>统一提交</span>
        </a></li><li>
        <a class="is-flex" href="#协调">
        <span class="has-mr-6">7</span>
        <span>协调</span>
        </a></li><li>
        <a class="is-flex" href="#函数组件">
        <span class="has-mr-6">8</span>
        <span>函数组件</span>
        </a></li><li>
        <a class="is-flex" href="#实现-useState">
        <span class="has-mr-6">9</span>
        <span>实现 useState</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#简单版">
        <span class="has-mr-6">9.1</span>
        <span>简单版</span>
        </a></li><li>
        <a class="is-flex" href="#支持多个-state">
        <span class="has-mr-6">9.2</span>
        <span>支持多个 state</span>
        </a></li><li>
        <a class="is-flex" href="#支持多个组件">
        <span class="has-mr-6">9.3</span>
        <span>支持多个组件</span>
        </a></li></ul></li><li>
        <a class="is-flex" href="#用-Hooks-模拟-Class-组件">
        <span class="has-mr-6">10</span>
        <span>用 Hooks 模拟 Class 组件</span>
        </a></li><li>
        <a class="is-flex" href="#完整代码">
        <span class="has-mr-6">11</span>
        <span>完整代码</span>
        </a></li><li>
        <a class="is-flex" href="#总结">
        <span class="has-mr-6">12</span>
        <span>总结</span>
        </a></li><li>
        <a class="is-flex" href="#参考">
        <span class="has-mr-6">13</span>
        <span>参考</span>
        </a></li></ul>
        </div>
    </div>
</div>

    
        


    
        
<div class="card widget">
    <div class="card-content">
        <div class="menu">
            <h3 class="menu-label">
                分类
            </h3>
            <ul class="menu-list">
            <li>
        <a class="level is-marginless" href="/categories/Angular/">
            <span class="level-start">
                <span class="level-item">Angular</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">15</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/CSS/">
            <span class="level-start">
                <span class="level-item">CSS</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">14</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/Essay/">
            <span class="level-start">
                <span class="level-item">Essay</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">29</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/HTTP/">
            <span class="level-start">
                <span class="level-item">HTTP</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">11</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/JavaScript/">
            <span class="level-start">
                <span class="level-item">JavaScript</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">45</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/Node-js/">
            <span class="level-start">
                <span class="level-item">Node.js</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">14</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/React/">
            <span class="level-start">
                <span class="level-item">React</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">18</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/Vue/">
            <span class="level-start">
                <span class="level-item">Vue</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">5</span>
            </span>
        </a></li>
            </ul>
        </div>
    </div>
</div>
    
        
<div class="card widget">
    <div class="card-content">
        <h3 class="menu-label">
            标签云
        </h3>
        <a href="/tags/Angular/" style="font-size: 15px;">Angular</a> <a href="/tags/CSS/" style="font-size: 13.33px;">CSS</a> <a href="/tags/Essay/" style="font-size: 18.33px;">Essay</a> <a href="/tags/HTTP/" style="font-size: 11.67px;">HTTP</a> <a href="/tags/JavaScript/" style="font-size: 20px;">JavaScript</a> <a href="/tags/Node-js/" style="font-size: 13.33px;">Node.js</a> <a href="/tags/React/" style="font-size: 16.67px;">React</a> <a href="/tags/Vue/" style="font-size: 10px;">Vue</a>
    </div>
</div>

    
    
        <div class="column-right-shadow  ">
        
            
<div class="card widget">
    <div class="card-content">
        <h3 class="menu-label">
            <a href="/tips" class="tips">
                最新文章
            </a>
        </h3>
        
        <article class="media">
            
            <a href="/2021/03/07/Vue/06/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="https://gitee.com/heptaluan/backups/raw/master/cdn/cover/06.webp" alt="Vite 的工程化流程">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2021-03-06T16:00:00.000Z">2021-03-07</time></div>
                    <a href="/2021/03/07/Vue/06/" class="has-link-black-ter is-size-6">Vite 的工程化流程</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/Vue/">Vue</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <a href="/2021/01/10/JavaScript/59/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="https://gitee.com/heptaluan/backups/raw/master/cdn/cover/59.webp" alt="在 React 当中使用 TypeScript">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2021-01-09T16:00:00.000Z">2021-01-10</time></div>
                    <a href="/2021/01/10/JavaScript/59/" class="has-link-black-ter is-size-6">在 React 当中使用 TypeScript</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/JavaScript/">JavaScript</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <a href="/2021/01/09/JavaScript/58/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="https://gitee.com/heptaluan/backups/raw/master/cdn/cover/58.webp" alt="深入 TypeScript 当中的泛型">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2021-01-08T16:00:00.000Z">2021-01-09</time></div>
                    <a href="/2021/01/09/JavaScript/58/" class="has-link-black-ter is-size-6">深入 TypeScript 当中的泛型</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/JavaScript/">JavaScript</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <a href="/2021/01/01/JavaScript/57/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="https://gitee.com/heptaluan/backups/raw/master/cdn/cover/57.webp" alt="深入 TypeScript">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2020-12-31T16:00:00.000Z">2021-01-01</time></div>
                    <a href="/2021/01/01/JavaScript/57/" class="has-link-black-ter is-size-6">深入 TypeScript</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/JavaScript/">JavaScript</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <a href="/2020/12/26/JavaScript/56/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="https://gitee.com/heptaluan/backups/raw/master/cdn/cover/56.webp" alt="重温 TypeScript">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2020-12-25T16:00:00.000Z">2020-12-26</time></div>
                    <a href="/2020/12/26/JavaScript/56/" class="has-link-black-ter is-size-6">重温 TypeScript</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/JavaScript/">JavaScript</a>
                    </p>
                </div>
            </div>
        </article>
        
    </div>
</div>

        
            <div class="card widget">
    <div class="card-content">
        <div class="menu">
        <h3 class="menu-label">
            归档
        </h3>
        <ul class="menu-list">
        
        <li>
            <a class="level is-marginless" href="/archives/2021/03/">
                <span class="level-start">
                    <span class="level-item">三月 2021</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2021/01/">
                <span class="level-start">
                    <span class="level-item">一月 2021</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2020/12/">
                <span class="level-start">
                    <span class="level-item">十二月 2020</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2020/11/">
                <span class="level-start">
                    <span class="level-item">十一月 2020</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2020/10/">
                <span class="level-start">
                    <span class="level-item">十月 2020</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">6</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2020/09/">
                <span class="level-start">
                    <span class="level-item">九月 2020</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">5</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2020/08/">
                <span class="level-start">
                    <span class="level-item">八月 2020</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">2</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2020/07/">
                <span class="level-start">
                    <span class="level-item">七月 2020</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">2</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2020/06/">
                <span class="level-start">
                    <span class="level-item">六月 2020</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">4</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2020/05/">
                <span class="level-start">
                    <span class="level-item">五月 2020</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2020/04/">
                <span class="level-start">
                    <span class="level-item">四月 2020</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">5</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2020/03/">
                <span class="level-start">
                    <span class="level-item">三月 2020</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">7</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2020/02/">
                <span class="level-start">
                    <span class="level-item">二月 2020</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">4</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2020/01/">
                <span class="level-start">
                    <span class="level-item">一月 2020</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">5</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/12/">
                <span class="level-start">
                    <span class="level-item">十二月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">7</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/11/">
                <span class="level-start">
                    <span class="level-item">十一月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">4</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/10/">
                <span class="level-start">
                    <span class="level-item">十月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">6</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/09/">
                <span class="level-start">
                    <span class="level-item">九月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">7</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/08/">
                <span class="level-start">
                    <span class="level-item">八月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/07/">
                <span class="level-start">
                    <span class="level-item">七月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">4</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/06/">
                <span class="level-start">
                    <span class="level-item">六月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">5</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/05/">
                <span class="level-start">
                    <span class="level-item">五月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">5</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/04/">
                <span class="level-start">
                    <span class="level-item">四月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">2</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/03/">
                <span class="level-start">
                    <span class="level-item">三月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">2</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/02/">
                <span class="level-start">
                    <span class="level-item">二月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">2</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/01/">
                <span class="level-start">
                    <span class="level-item">一月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/12/">
                <span class="level-start">
                    <span class="level-item">十二月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">6</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/11/">
                <span class="level-start">
                    <span class="level-item">十一月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">4</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/10/">
                <span class="level-start">
                    <span class="level-item">十月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/09/">
                <span class="level-start">
                    <span class="level-item">九月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/08/">
                <span class="level-start">
                    <span class="level-item">八月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/07/">
                <span class="level-start">
                    <span class="level-item">七月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/06/">
                <span class="level-start">
                    <span class="level-item">六月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/05/">
                <span class="level-start">
                    <span class="level-item">五月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">2</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/04/">
                <span class="level-start">
                    <span class="level-item">四月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/03/">
                <span class="level-start">
                    <span class="level-item">三月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">2</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/02/">
                <span class="level-start">
                    <span class="level-item">二月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/01/">
                <span class="level-start">
                    <span class="level-item">一月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2017/12/">
                <span class="level-start">
                    <span class="level-item">十二月 2017</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2017/11/">
                <span class="level-start">
                    <span class="level-item">十一月 2017</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2017/10/">
                <span class="level-start">
                    <span class="level-item">十月 2017</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">2</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2017/09/">
                <span class="level-start">
                    <span class="level-item">九月 2017</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">2</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2017/08/">
                <span class="level-start">
                    <span class="level-item">八月 2017</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2017/07/">
                <span class="level-start">
                    <span class="level-item">七月 2017</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2017/06/">
                <span class="level-start">
                    <span class="level-item">六月 2017</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">2</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2017/05/">
                <span class="level-start">
                    <span class="level-item">五月 2017</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2017/04/">
                <span class="level-start">
                    <span class="level-item">四月 2017</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">2</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2017/03/">
                <span class="level-start">
                    <span class="level-item">三月 2017</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2017/01/">
                <span class="level-start">
                    <span class="level-item">一月 2017</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2016/12/">
                <span class="level-start">
                    <span class="level-item">十二月 2016</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        </ul>
        </div>
    </div>
</div>
        
            <div class="card widget">
    <div class="card-content">
        <div class="menu">
            <h3 class="menu-label">
                标签
            </h3>
            <div class="field is-grouped is-grouped-multiline">
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Angular/">
                        <span class="tag">Angular</span>
                        <span class="tag is-grey">15</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/CSS/">
                        <span class="tag">CSS</span>
                        <span class="tag is-grey">14</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Essay/">
                        <span class="tag">Essay</span>
                        <span class="tag is-grey">29</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/HTTP/">
                        <span class="tag">HTTP</span>
                        <span class="tag is-grey">11</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/JavaScript/">
                        <span class="tag">JavaScript</span>
                        <span class="tag is-grey">45</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Node-js/">
                        <span class="tag">Node.js</span>
                        <span class="tag is-grey">14</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/React/">
                        <span class="tag">React</span>
                        <span class="tag is-grey">18</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Vue/">
                        <span class="tag">Vue</span>
                        <span class="tag is-grey">5</span>
                    </a>
                </div>
                
            </div>
        </div>
    </div>
</div>
        
        </div>
    
</div>

                
            </div>
        </div>
    </section>
    <footer class="footer">
    <div class="container">
        <div class="level">
            <div class="level-start has-text-centered-mobile">
                <!-- <a class="footer-logo is-block has-mb-6" href="/">
                
                    <img src="/images/logo.svg" alt="Fiber 架构的简单实现" height="28">
                
                </a> -->
                <p class="is-size-7">
                &copy; 2016 - 2021
                Made with ✿  heptaluan&nbsp;
                
                </p>
            </div>
            <!-- <div class="level-end">
            
            </div> -->
        </div>
    </div>
</footer>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script>
<script>moment.locale("zh-CN");</script>


    
    
    
    <script src="/js/animation.js"></script>
    

    
    
    
    <script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script>
    <script src="/js/gallery.js" defer></script>
    

    
    

<div id="outdated">
    <h6>Your browser is out-of-date!</h6>
    <p>Update your browser to view this website correctly. <a id="btnUpdateBrowser" href="http://outdatedbrowser.com/">Update
            my browser now </a></p>
    <p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">&times;</a></p>
</div>
<script src="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.js" defer></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        outdatedBrowser({
            bgColor: '#f25648',
            color: '#ffffff',
            lowerThan: 'flex'
        });
    });
</script>


    
    
<script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    MathJax.Hub.Config({
        'HTML-CSS': {
            matchFontHeight: false
        },
        SVG: {
            matchFontHeight: false
        },
        CommonHTML: {
            matchFontHeight: false
        },
        tex2jax: {
            inlineMath: [
                ['$','$'],
                ['\\(','\\)']
            ]
        }
    });
});
</script>

    
    

<a id="back-to-top" title="回到顶端" href="javascript:;">
    <i class="fa fa-chevron-up"></i>
</a>
<script src="/js/back-to-top.js" defer></script>


    
    

    
    
    
    

    
    
    
    
    
    <script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script>
    <script src="/js/clipboard.js" defer></script>
    

    
    
    


<script src="/js/main.js" defer></script>

    
    <div class="searchbox ins-search">
    <div class="searchbox-container ins-search-container">
        <div class="searchbox-input-wrapper">
            <input type="text" class="searchbox-input ins-search-input" placeholder="想要查找什么...">
            <span class="searchbox-close ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="searchbox-result-wrapper ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
    (function (window) {
        var INSIGHT_CONFIG = {
            TRANSLATION: {
                POSTS: '文章',
                PAGES: '页面',
                CATEGORIES: '分类',
                TAGS: '标签',
                UNTITLED: '(无标题)',
            },
            CONTENT_URL: '/content.json',
        };
        window.INSIGHT_CONFIG = INSIGHT_CONFIG;
    })(window);
</script>
<script src="/js/insight.js" defer></script>
<link rel="stylesheet" href="/css/search.css">
<link rel="stylesheet" href="/css/insight.css">
    
</body>
</html>