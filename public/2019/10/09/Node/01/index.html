<!DOCTYPE html>
<html lang="zh">
<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
<title>Node.js 中的 Stream（流） - heptaluan&#39;s blog</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">



    <meta name="description" content="本章我们来看 Node.js 当中一个比较重要的概念，那就是 Stream，也就是所谓的流，那么什么是 Stream 呢？">
<meta name="keywords" content="Node.js">
<meta property="og:type" content="article">
<meta property="og:title" content="Node.js 中的 Stream（流）">
<meta property="og:url" content="http://yoursite.com/2019/10/09/Node/01/index.html">
<meta property="og:site_name" content="heptaluan&#39;s blog">
<meta property="og:description" content="本章我们来看 Node.js 当中一个比较重要的概念，那就是 Stream，也就是所谓的流，那么什么是 Stream 呢？">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://gitee.com/heptaluan/backups/raw/master/cdn/cover/01.webp">
<meta property="og:updated_time" content="2021-03-09T08:29:33.722Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Node.js 中的 Stream（流）">
<meta name="twitter:description" content="本章我们来看 Node.js 当中一个比较重要的概念，那就是 Stream，也就是所谓的流，那么什么是 Stream 呢？">
<meta name="twitter:image" content="https://gitee.com/heptaluan/backups/raw/master/cdn/cover/01.webp">







<link rel="icon" href="https://gitee.com/heptaluan/backups/raw/master/cdn/favicon.ico">


<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.7.2/css/bulma.css">
<link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.7.0/css/font-awesome.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu:400,600|Source+Code+Pro">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.5.0/styles/atom-one-light.css">


    
    
    
    <style>body>.footer,body>.navbar,body>.section{opacity:0}</style>
    

    
    
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css">
    

    
    

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.css">


    
    
    
    

<link rel="stylesheet" href="/css/back-to-top.css">


    
    

    
    
    
    

    
    
<link rel="stylesheet" href="/css/progressbar.css">
<script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script>

    
    
    

    
    
    


<link rel="stylesheet" href="/css/style.css">
</head>
<body class="is-2-column">
    <!-- fork me on github -->
<a title="Fork me on GitHub" id="forkMe" style="position: fixed;top: 0;right: 0;z-index: 31" href="https://github.com/heptaluan" target="_blank">
    <svg style="color: #fff;fill: #a0a1a7;height: 80px;width: 80px;" viewbox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"/><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"/><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"/></svg>
</a>

<nav class="navbar navbar-main">
    <div class="container">
        <!-- <div class="navbar-brand is-flex-center">
            <a class="navbar-item navbar-logo" href="/">
            
                <img src="/images/logo.svg" alt="Node.js 中的 Stream（流）" height="28">
            
            </a>
        </div> -->

        <div class="navbar-menu">
            
            <div class="navbar-start">
                
                <a class="navbar-item" href="/">Home</a>
                
                <a class="navbar-item" href="/archives">Archives</a>
                
                <a class="navbar-item" href="/categories">Categories</a>
                
                <a class="navbar-item" href="https://heptaluan.github.io/demos/">Demos</a>
                
            </div>
            
            <div class="navbar-end">
                
                
                <a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;">
                    <i class="fas fa-list-ul"></i>
                </a>
                
                
                <a class="navbar-item search" title="搜索" href="javascript:;">
                    <i class="fa fa-search"></i>
                </a>
                
            </div>
        </div>
    </div>
</nav>
    
    <section class="section">
        <div class="container">
            <div class="columns">
                <div class="column is-8-tablet is-8-desktop is-9-widescreen has-order-2 column-main"><div class="card">
    
    <div class="card-image">
        <span class="image is-7by1">
            <img class="thumbnail" src="https://gitee.com/heptaluan/backups/raw/master/cdn/cover/01.webp" alt="Node.js 中的 Stream（流）">
        </span>
    </div>
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <div class="level-item has-text-grey">2019-10-09</div>
                <!-- <time class="level-item has-text-grey" datetime="2019-10-08T16:00:00.000Z">2019-10-09</time> -->
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/Node-js/">Node.js</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    1 小时 读完 (大约 7478 个字)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                Node.js 中的 Stream（流）
            
        </h1>
        <div class="content">
            <p>本章我们来看 <code>Node.js</code> 当中一个比较重要的概念，那就是 <code>Stream</code>，也就是所谓的流，那么什么是 <code>Stream</code> 呢？</p>
<a id="more"></a>


<h2 id="什么是-Stream"><a href="#什么是-Stream" class="headerlink" title="什么是 Stream"></a>什么是 Stream</h2><p><code>Stream</code> 的概念最早来源于 <code>Unix</code> 系统，其可以将一个大型系统拆分成一些小的组件，然后将这些小的组件可以很好地运行，<code>TCP/IP</code> 协议中的 <code>TCP</code> 协议也用到了 <code>Stream</code> 的思想，进而可以进行流量控制、差错控制，在 <code>unix</code> 中通过 <code>|</code> 来表示流，而在 <code>Node.js</code> 中则是通过 <code>pipe()</code> 方法，<code>Stream</code> 可以认为数据就像管道一样，多次不断地被传递下去，而不是一次性全部传递给下游</p>
<h2 id="Node-js-中的流"><a href="#Node-js-中的流" class="headerlink" title="Node.js 中的流"></a>Node.js 中的流</h2><p>在 <a href="https://nodejs.org/api/stream.html#stream_stream" target="_blank" rel="noopener">Node.js API 文档</a> 中可以看到下面一段话</p>
<figure class="highlight js hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">A stream is an abstract interface implemented by various objects <span class="hljs-keyword">in</span> Node. </span><br><span class="line"></span><br><span class="line">For example a request to an HTTP server is a stream, <span class="hljs-keyword">as</span> is stdout. </span><br><span class="line"></span><br><span class="line">Streams are readable, writable, or both. All streams are instances <span class="hljs-keyword">of</span> EventEmitter</span><br></pre></td></tr></table></figure>

<p>简单来说</p>
<ul>
<li><code>Stream</code> 是 <code>Node.js</code> 中一个非常重要的概念，被大量对象实现，尤其是 <code>Node.js</code> 中的 <code>I/O</code> 操作</li>
<li><code>Stream</code> 是一个抽像的接口，一般不会直接使用，需要实现内部的某些抽象方法(例如 <code>_read</code>、<code>_write</code>、<code>_transform</code>)</li>
<li><code>Stream</code> 是 <code>EventEmitter</code> 的子类，实际上 <code>Stream</code> 的数据传递内部依然是通过事件（<code>data</code>）来实现的</li>
</ul>
<h2 id="流的分类"><a href="#流的分类" class="headerlink" title="流的分类"></a>流的分类</h2><p>在 <code>Node.js</code> 中有四种类型的流，它们分别是 <code>readable</code>、<code>writeable</code>、<code>Duplex</code> 和 <code>transform</code></p>
<ul>
<li><code>readable</code>，可读流，表示数据能够被消费，例如可以通过 <code>fs.createReadStream()</code> 方法创建可读流</li>
<li><code>writeable</code>，可写流，表示数据能被写，例如可以通过 <code>fs.createWriteStream()</code> 方法创建可写流</li>
<li><code>duplex</code>，即表示既是 <code>Readable</code> 流也是 <code>Writable</code> 流，如 <code>TCP Socket</code></li>
<li><code>transform</code>，它也是 <code>Duplex</code> 流，能够用来修改或转换数据，例如 <code>zlib.createGzip</code> 方法用来使用 <code>gzip</code> 压缩数据（你可以认为 <code>transform</code> 流是一个函数，它的输入是 <code>Writable</code> 流，输出是 <code>Readable</code> 流）</li>
</ul>
<table>
<thead>
<tr>
<th>使用情景</th>
<th>类</th>
<th>需要重写的方法</th>
</tr>
</thead>
<tbody><tr>
<td>只读</td>
<td><code>Readable</code></td>
<td><code>_read</code></td>
</tr>
<tr>
<td>只写</td>
<td><code>Writable</code></td>
<td><code>_write</code></td>
</tr>
<tr>
<td>双工</td>
<td><code>Duplex</code></td>
<td><code>_read</code>，<code>_write</code></td>
</tr>
<tr>
<td>操作被写入数据，然后读出结果</td>
<td><code>Transform</code></td>
<td><code>_transform</code>，<code>_flush</code></td>
</tr>
</tbody></table>
<p>此外所有的流都是 <code>EventEmitter</code> 的实例，它们能够监听或触发事件，用于控制读取和写入数据，<code>Readable</code> 与 <code>Writable</code> 流支持的常见的事件和方法如下图所示</p>
<p><img src="https://gitee.com/heptaluan/backups/raw/master/cdn/node/24.png" alt></p>
<p>下面我们就一个一个来分类介绍</p>
<h2 id="Readable"><a href="#Readable" class="headerlink" title="Readable"></a>Readable</h2><p>可读流（<code>Readable Streams</code>）是对提供数据的源头（<code>source</code>）的抽象，可读流事实上工作在下面两种模式之一 <code>flowing</code> 和 <code>paused</code> </p>
<ul>
<li>在 <code>flowing</code> 模式下，可读流自动从系统底层读取数据，并通过 <code>EventEmitter</code> 接口的事件尽快将数据提供给应用</li>
<li>在 <code>paused</code> 模式下，必须显式调用 <code>stream.read()</code> 方法来从流中读取数据片段</li>
</ul>
<p>那如何触发这两种模式呢</p>
<ul>
<li><code>paused mode</code>，调用 <code>pause</code> 方法（没有 <code>pipe</code> 方法）、移除 <code>data</code> 事件和释放所有 <code>pipe</code></li>
<li><code>flowing mode</code>，注册事件 <code>data</code>、调用 <code>resume</code> 方法、调用 <code>pipe</code> 方法</li>
</ul>
<p>如下所示</p>
<figure class="highlight js hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">// data 事件触发 flowing mode</span></span><br><span class="line">Readable.prototype.on = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">ev, fn</span>) </span>&#123;</span><br><span class="line">  <span class="hljs-comment">// ...</span></span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">if</span> (ev === <span class="hljs-string">'data'</span> &amp;&amp; <span class="hljs-literal">false</span> !== <span class="hljs-keyword">this</span>._readableState.flowing) &#123;</span><br><span class="line">    <span class="hljs-keyword">this</span>.resume()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="hljs-comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// resume 触发 flowing mode</span></span><br><span class="line">Readable.prototype.resume = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;</span><br><span class="line">  <span class="hljs-keyword">var</span> state = <span class="hljs-keyword">this</span>._readableState</span><br><span class="line">  <span class="hljs-keyword">if</span> (!state.flowing) &#123;</span><br><span class="line">    debug(<span class="hljs-string">'resume'</span>)</span><br><span class="line">    state.flowing = <span class="hljs-literal">true</span></span><br><span class="line">    resume(<span class="hljs-keyword">this</span>, state)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// pipe 方法触发 flowing 模式</span></span><br><span class="line">Readable.prototype.resume = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;</span><br><span class="line">  <span class="hljs-keyword">if</span> (!state.flowing) &#123;</span><br><span class="line">    <span class="hljs-keyword">this</span>.resume()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>简单来说，两种模式取决于一个 <code>flowing</code> 字段</p>
<figure class="highlight js hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-literal">true</span> ==&gt; flowing mode</span><br><span class="line"></span><br><span class="line"><span class="hljs-literal">false</span> ==&gt; paused mode</span><br></pre></td></tr></table></figure>

<p>上面三种方式最后均是通过 <code>resume</code> 方法，将 <code>state.flowing = true</code>，可读流的两种操作模式是一种简单抽象，它抽象了在可读流实现（<code>Readable stream implementation</code>）内部发生的复杂的状态管理过程，在任意时刻，任意可读流应确切处于下面三种状态之一</p>
<figure class="highlight js hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">readable._readableState.flowing = <span class="hljs-literal">null</span></span><br><span class="line"></span><br><span class="line">readable._readableState.flowing = <span class="hljs-literal">false</span></span><br><span class="line"></span><br><span class="line">readable._readableState.flowing = <span class="hljs-literal">true</span></span><br></pre></td></tr></table></figure>

<p>若 <code>readable._readableState.flowing</code> 为 <code>null</code>，由于不存在数据消费者，可读流将不会产生数据，如果监听 <code>data</code> 事件，调用 <code>readable.pipe()</code> 方法，或者调用 <code>readable.resume()</code> 方法，<code>readable._readableState.flowing</code> 的值将会变为 <code>true</code>，这时，随着数据生成，可读流开始频繁触发事件</p>
<p>调用 <code>readable.pause()</code> 方法，<code>readable.unpipe()</code> 方法，或者接收背压（关于背压的概念我们会在下面进行介绍），将导致 <code>readable._readableState.flowing</code> 值变为 <code>false</code>，这将暂停事件流，但不会暂停数据生成，当 <code>readable._readableState.flowing</code> 值为 <code>false</code> 时， 数据可能堆积到流的内部缓存中</p>
<p>需要注意的是，应该选择其中『一种』来消费数据，而『不应该』在单个流使用多种方法来消费数据，对于大多数用户，建议使用 <code>readable.pipe()</code> 方法来消费流数据，因为它是最简单的一种实现，如果要精细地控制数据传递和产生的过程，可以使用 <code>EventEmitter</code> 和 <code>readable.pause()/readable.resume()</code> 提供的 <code>API</code></p>
<h4 id="paused-mode"><a href="#paused-mode" class="headerlink" title="paused mode"></a>paused mode</h4><p>在 <code>paused mode</code> 下，需要手动地读取数据，并且可以直接指定读取数据的长度</p>
<figure class="highlight js hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">var</span> Read = <span class="hljs-built_in">require</span>(<span class="hljs-string">'stream'</span>).Readable</span><br><span class="line"><span class="hljs-keyword">var</span> r = <span class="hljs-keyword">new</span> Read()</span><br><span class="line"></span><br><span class="line">r.push(<span class="hljs-string">'hello'</span>)</span><br><span class="line">r.push(<span class="hljs-string">'world'</span>)</span><br><span class="line">r.push(<span class="hljs-literal">null</span>)</span><br><span class="line"></span><br><span class="line"><span class="hljs-built_in">console</span>.log(r.read(<span class="hljs-number">1</span>).toString())  <span class="hljs-comment">// h</span></span><br><span class="line"><span class="hljs-built_in">console</span>.log(r.read(<span class="hljs-number">3</span>).toString())  <span class="hljs-comment">// ell</span></span><br></pre></td></tr></table></figure>

<p>还可以通过监听事件 <code>readable</code>，触发时手工读取 <code>chunk</code> 数据</p>
<figure class="highlight js hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">var</span> Read = <span class="hljs-built_in">require</span>(<span class="hljs-string">'stream'</span>).Readable</span><br><span class="line"><span class="hljs-keyword">var</span> r = <span class="hljs-keyword">new</span> Read()</span><br><span class="line"></span><br><span class="line">r.push(<span class="hljs-string">'hello'</span>)</span><br><span class="line">r.push(<span class="hljs-string">'world'</span>)</span><br><span class="line">r.push(<span class="hljs-literal">null</span>)</span><br><span class="line"></span><br><span class="line">r.on(<span class="hljs-string">'readable'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>&#123;</span><br><span class="line">  <span class="hljs-keyword">var</span> chunk = r.read()</span><br><span class="line">  <span class="hljs-built_in">console</span>.log(chunk.toString())</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// helloworld</span></span><br></pre></td></tr></table></figure>

<p>需要注意的是，一旦注册了 <code>readable</code> 事件，必须手工读取 <code>read</code> 数据，否则数据就会流失，看看内部实现</p>
<figure class="highlight js hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">emitReadable_</span>(<span class="hljs-params">stream</span>) </span>&#123;</span><br><span class="line">  debug(<span class="hljs-string">'emit readable'</span>)</span><br><span class="line">  stream.emit(<span class="hljs-string">'readable'</span>)</span><br><span class="line">  flow(stream)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">flow</span>(<span class="hljs-params">stream</span>) </span>&#123;</span><br><span class="line">  <span class="hljs-keyword">var</span> state = stream._readableState</span><br><span class="line">  debug(<span class="hljs-string">'flow'</span>, state.flowing)</span><br><span class="line">  <span class="hljs-keyword">if</span> (state.flowing) &#123;</span><br><span class="line">    <span class="hljs-keyword">do</span> &#123;</span><br><span class="line">      <span class="hljs-keyword">var</span> chunk = stream.read()</span><br><span class="line">    &#125; <span class="hljs-keyword">while</span> (<span class="hljs-literal">null</span> !== chunk &amp;&amp; state.flowing)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Readable.prototype.read = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">n</span>) </span>&#123;</span><br><span class="line">  <span class="hljs-comment">// ...</span></span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">var</span> res = fromList(n, state)</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">if</span> (!util.isNull(ret)) &#123;</span><br><span class="line">    <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'data'</span>, ret)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="hljs-comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>flow</code> 方法直接 <code>read</code> 数据，将得到的数据通过事件 <code>data</code> 交付出去，然而此处没有注册 <code>data</code> 事件监控，因此，得到的 <code>chunk</code> 数据并没有交付给任何对象，这样数据就白白流失了，所以在触发 <code>emit(&#39;readable&#39;)</code> 时，需要提前 <code>read</code> 数据</p>
<h4 id="flowing-mode"><a href="#flowing-mode" class="headerlink" title="flowing mode"></a>flowing mode</h4><p>通过注册 <code>data</code>、<code>pipe</code>、<code>resume</code> 可以自动获取所需要的数据，比如通过事件 <code>data</code> 的方式</p>
<figure class="highlight js hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">var</span> Read = <span class="hljs-built_in">require</span>(<span class="hljs-string">'stream'</span>).Readable</span><br><span class="line"><span class="hljs-keyword">var</span> r = <span class="hljs-keyword">new</span> Read()</span><br><span class="line"></span><br><span class="line">r.push(<span class="hljs-string">'hello'</span>)</span><br><span class="line">r.push(<span class="hljs-string">'world'</span>)</span><br><span class="line">r.push(<span class="hljs-literal">null</span>)</span><br><span class="line"></span><br><span class="line">r.on(<span class="hljs-string">'data'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">chunk</span>) </span>&#123;</span><br><span class="line">  <span class="hljs-built_in">console</span>.log(chunk.toString())</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// hello </span></span><br><span class="line"><span class="hljs-comment">// world</span></span><br></pre></td></tr></table></figure>

<p>或者通过 <code>pipe</code> 的方式</p>
<figure class="highlight js hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">var</span> Read = <span class="hljs-built_in">require</span>(<span class="hljs-string">'stream'</span>).Readable</span><br><span class="line"><span class="hljs-keyword">var</span> r = <span class="hljs-keyword">new</span> Read()</span><br><span class="line"></span><br><span class="line">r.push(<span class="hljs-string">'hello'</span>)</span><br><span class="line">r.push(<span class="hljs-string">'world'</span>)</span><br><span class="line">r.push(<span class="hljs-literal">null</span>)</span><br><span class="line"></span><br><span class="line">r.pipe(process.stdout)</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// helloworld</span></span><br></pre></td></tr></table></figure>

<p>以上两种 <code>mode</code> 总体如下</p>
<p><img src="https://gitee.com/heptaluan/backups/raw/master/cdn/node/07.png" alt></p>
<h4 id="readable-与-data-事件"><a href="#readable-与-data-事件" class="headerlink" title="readable 与 data 事件"></a>readable 与 data 事件</h4><p><code>read()</code> 是 <code>Readable</code> 流的基石，无论流处于什么模式，只要是涉及读取数据最终都会转到 <code>read()</code> 上面来，它的主要功能是</p>
<ul>
<li>读取缓冲区数据并返回给消费者，并按需发射各种事件</li>
<li>按需调用 <code>_read()</code>，<code>_read()</code> 会从底层汲取数据，并填充缓冲区</li>
</ul>
<p>它的流程大致如下</p>
<p><img src="https://gitee.com/heptaluan/backups/raw/master/cdn/node/25.png" alt></p>
<p>务必记住 <code>read()</code> 是『同步』的，因此它并不是直接从底层数据那里读取数据，而是从缓冲区读取数据，而缓冲区的数据则是由 <code>_read()</code> 负责补充</p>
<p><code>_read()</code> 可以是同步或者异步，<code>Node.js</code> 内部的实现经常会调用 <code>read(0)</code>，因为参数是 <code>0</code> 所以不会破坏缓冲区中的数据和状态，但可以触发 <code>_read()</code> 来从底层汲取数据并填充缓冲区，<code>_read()</code> 是流实现者需要重写的函数，它从底层汲取数据并填充缓冲区（<code>flowing</code> 模式不会填充而是直接发送给消费者），它的大致流程如下</p>
<p><img src="https://gitee.com/heptaluan/backups/raw/master/cdn/node/26.png" alt></p>
<p>注意在 <code>addChunk()</code> 后会根据情况发射 <code>readable</code> 或者 <code>data</code> 事件，然后依次调用</p>
<figure class="highlight js hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">read() ==&gt; _read(<span class="hljs-number">0</span>) ==&gt; ... ==&gt; addChunk()</span><br></pre></td></tr></table></figure>

<p>从而形成一个循环，因为一旦调用了 <code>_read()</code> 之后，流就会默默在底层读取数据，直到数据都消耗完为止</p>
<h4 id="readable-事件"><a href="#readable-事件" class="headerlink" title="readable 事件"></a>readable 事件</h4><p>文档上关于 <code>readable</code> 事件的描述如下</p>
<blockquote>
<p>事实上，<code>readable</code> 事件表明流有了新的动态，要么是有了新的数据，要么是到了流的尾部，对于前者 <code>stream.read()</code> 将返回可用的数据，而对于后者 <code>stream.read()</code> 将返回 <code>null</code></p>
</blockquote>
<p>由此我们可以知道 <code>readable</code> 事件意味着</p>
<ul>
<li>流有了新的数据（注意，这里只说明有了新数据，至于新数据如何读取是调用者自己的事情）</li>
<li>流到达了尾部</li>
</ul>
<p>来看下面这个示例</p>
<figure class="highlight js hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">// 可以将 size 设为 1 或 undefined 来进行测试</span></span><br><span class="line"><span class="hljs-keyword">const</span> size = <span class="hljs-number">1</span></span><br><span class="line"><span class="hljs-keyword">const</span> rs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>).createReadStream(<span class="hljs-string">'./test.js'</span>)</span><br><span class="line"></span><br><span class="line">rs.on(<span class="hljs-string">'readable'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="hljs-built_in">console</span>.log(rs.read(size))</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>总之，<code>readable</code> 只是负责通知用户流有了新的动态，事件发生的时候是否读取数据，如何读取数据则是调用者的事情（如果一直不读取事件，则数据会存在于缓冲区中），例如可以给 <code>readable</code> 注册一个回调函数，该回调函数调用无参的 <code>read()</code>，它会读取并清空缓冲区的全部数据，这样就使得每次 <code>readable</code> 发生的时候都可以读取到最新的数据</p>
<h4 id="readable-的触发时机"><a href="#readable-的触发时机" class="headerlink" title="readable 的触发时机"></a>readable 的触发时机</h4><p><code>readable</code> 在以下几种情况会被触发</p>
<ul>
<li>在 <code>onEofChunk</code> 中，且 <code>_read()</code> 从底层汲取的数据为空，这个场景意味着流中的数据已经全部消耗完</li>
<li>在 <code>addChunk()</code> 中，且 <code>_read()</code> 从底层汲取的数据不为空且处于 <code>pause</code> 模式，这个场景意味着流中有新数据</li>
<li>在 <code>read(n)</code> 中，且 <code>n</code> 为 <code>0</code> 是的某些情况下</li>
<li>通过 <code>on()</code> 为 <code>readable</code> 添加监听器，如果此时缓冲区有数据则会触发，这个场景意味着流中已经有数据可供 <code>read()</code> 直接调用</li>
</ul>
<h4 id="data-事件"><a href="#data-事件" class="headerlink" title="data 事件"></a>data 事件</h4><p><code>data</code> 事件的意义则明确很多，文档上关于 <code>data</code> 事件的描述如下</p>
<blockquote>
<p>The ‘data’ event is emitted whenever the stream is relinquishing ownership of a chunk of data to a consumer.</p>
</blockquote>
<p>与 <code>readable</code> 不同的是，<code>data</code> 事件代表的意义清晰单一，流将数据交付给消费者时触发，并且会将对应的数据通过回调传递给用户</p>
<h4 id="data-的触发时机"><a href="#data-的触发时机" class="headerlink" title="data 的触发时机"></a>data 的触发时机</h4><p>从源码来看，有两个地方会触发 <code>data</code> 事件</p>
<ul>
<li>在 <code>read()</code> 中，如果缓冲区此时有数据可以返回给调用者，这种情况只会在调用 <code>pipe()</code> 时候发生，如果 <code>readable()</code> 被暂停过并重新启动，此时缓冲区内残留的数据会通过 <code>read()</code> 读出然后借助 <code>data</code> 事件传递出去</li>
<li>在 <code>addChunk()</code> 中，此时 <code>_read()</code> 从底层汲取的数据不为空，且满足以下条件<ul>
<li>处于 <code>flowing</code> 模式</li>
<li>缓冲区为空</li>
<li>处于异步调用模式</li>
</ul>
</li>
</ul>
<p>在这种情况下，数据直接就交付给消费者了，并没有在缓冲区缓存，而文档中的说法是</p>
<blockquote>
<p>当流转换到 <code>flowing</code> 模式时会触发该事件，调用 <code>readable.pipe()</code>， <code>readable.resume()</code> 方法，或为 <code>data</code> 事件添加回调可以将流转换到 <code>flowing</code> 模式， <code>data</code> 事件也会在调用 <code>readable.read()</code> 方法并有数据返回时触发</p>
</blockquote>
<p>似乎两者不太一致？其实本质上调用 <code>readable.pipe()</code>、<code>readable.resume()</code> 或为 <code>data</code> 事件添加回调，最终都会依次调用</p>
<figure class="highlight js hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">read() ==&gt; _read() ==&gt; addChunk()</span><br></pre></td></tr></table></figure>

<p>然后最终才进行发射 <code>data</code> 事件，结合 <code>_read()</code> 的流程图，可以发现，通过 <code>on()</code> 为 <code>readable</code> 和 <code>data</code> 事件添加监听器后，程序就开始循环汲取底层数据直至消耗完为止</p>
<h4 id="如果同时监听-readable-和-data-事件"><a href="#如果同时监听-readable-和-data-事件" class="headerlink" title="如果同时监听 readable 和 data 事件"></a>如果同时监听 readable 和 data 事件</h4><p>如下示例</p>
<figure class="highlight js hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">const</span> rs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>).createReadStream(<span class="hljs-string">'./test.js'</span>)</span><br><span class="line"></span><br><span class="line">rs.on(<span class="hljs-string">'readable'</span>, () =&gt; <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'readable 触发'</span>))</span><br><span class="line">rs.on(<span class="hljs-string">'data'</span>, <span class="hljs-built_in">console</span>.log)</span><br></pre></td></tr></table></figure>

<p>运行结果如下</p>
<figure class="highlight console hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;Buffer 63 6f 6e 73 74 20 72 73 20 3d 20 72 65 71 75 69 72 65 28 27 66 73 27 29 2e 63 72 65 61 74 65 52 65 61 64 53 74 72 65 61 6d 28 27 2e 2f 74 65 73 74 2e ... &gt;</span><br><span class="line">readable 触发</span><br></pre></td></tr></table></figure>

<p>从上面的流程图我们知道，在 <code>addChunk()</code> 中当有新数据到来的时候，<code>redable</code> 和 <code>data</code> 都有可能触发，那究竟触发哪个？让我们来看看 <code>addChunk()</code> 的源码</p>
<figure class="highlight js hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">addChunk</span>(<span class="hljs-params">stream, state, chunk, addToFront</span>) </span>&#123;</span><br><span class="line">  <span class="hljs-comment">// 如果处于 flowing 模式，且缓冲区为空，且为异步调用时候，触发 data 事件</span></span><br><span class="line">  <span class="hljs-keyword">if</span> (state.flowing &amp;&amp; state.length === <span class="hljs-number">0</span> &amp;&amp; !state.sync) &#123;</span><br><span class="line">    state.awaitDrain = <span class="hljs-number">0</span></span><br><span class="line">    stream.emit(<span class="hljs-string">'data'</span>, chunk)</span><br><span class="line">  &#125; <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">    <span class="hljs-comment">// 更新缓冲区已有数据数量</span></span><br><span class="line">    state.length += state.objectMode ? <span class="hljs-number">1</span> : chunk.length</span><br><span class="line">    <span class="hljs-keyword">if</span> (addToFront)</span><br><span class="line">      <span class="hljs-comment">// 插入缓冲区头部</span></span><br><span class="line">      state.buffer.unshift(chunk)</span><br><span class="line">    <span class="hljs-keyword">else</span></span><br><span class="line">      <span class="hljs-comment">// 插入缓冲区尾部</span></span><br><span class="line">      state.buffer.push(chunk)</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">if</span> (state.needReadable)</span><br><span class="line">      <span class="hljs-comment">// 触发 readable 事件</span></span><br><span class="line">      emitReadable(stream)</span><br><span class="line">  &#125;</span><br><span class="line">  maybeReadMore(stream, state)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由于为 <code>data</code> 事件添加回调会使得流进入 <code>flowing</code> 模式，因此我们的例子中，有新数据时只会发射 <code>data</code> 事件，而 <code>readable</code> 事件则流结束的时候发射一次</p>
<h2 id="Writable"><a href="#Writable" class="headerlink" title="Writable"></a>Writable</h2><p>所有 <code>Writable</code> 流都实现了 <code>stream.Writable</code> 类定义的接口，尽管特定的 <code>Writable</code> 流的实现可能略有差别，所有的 <code>Writable streams</code> 都可以按一种基本模式进行使用，如下</p>
<figure class="highlight js hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">const</span> myStream = getWritableStreamSomehow()</span><br><span class="line"></span><br><span class="line">myStream.write(<span class="hljs-string">'some data'</span>)</span><br><span class="line">myStream.write(<span class="hljs-string">'some more data'</span>)</span><br><span class="line">myStream.end(<span class="hljs-string">'done writing data'</span>)</span><br></pre></td></tr></table></figure>

<p>本质上 只是需要实现的是 <code>_write(data, enc, next)</code> 方法</p>
<figure class="highlight js hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">const</span> Writable = <span class="hljs-built_in">require</span>(<span class="hljs-string">'stream'</span>).Writable</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">const</span> writable = Writable()</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// 实现 _write 方法</span></span><br><span class="line"><span class="hljs-comment">// 这是将数据写入底层的逻辑</span></span><br><span class="line">writable._write = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">data, enc, next</span>) </span>&#123;</span><br><span class="line">  <span class="hljs-comment">// 将流中的数据写入底层</span></span><br><span class="line">  process.stdout.write(data.toString().toUpperCase())</span><br><span class="line">  <span class="hljs-comment">// 写入完成时，调用 next() 方法通知流传入下一个数据</span></span><br><span class="line">  process.nextTick(next)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// 所有数据均已写入底层</span></span><br><span class="line">writable.on(<span class="hljs-string">'finish'</span>, () =&gt; process.stdout.write(<span class="hljs-string">'DONE'</span>))</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// 将一个数据写入流中</span></span><br><span class="line">writable.write(<span class="hljs-string">'a'</span> + <span class="hljs-string">'\n'</span>)</span><br><span class="line">writable.write(<span class="hljs-string">'b'</span> + <span class="hljs-string">'\n'</span>)</span><br><span class="line">writable.write(<span class="hljs-string">'c'</span> + <span class="hljs-string">'\n'</span>)</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// 再无数据写入流时，需要调用 end() 方法</span></span><br><span class="line">writable.end()</span><br></pre></td></tr></table></figure>

<p>上游通过调用 <code>writable.write(data)</code> 将数据写入可写流中，<code>write()</code> 方法会调用 <code>_write()</code> 将 <code>data</code> 写入底层，在 <code>_write</code> 方法中，当数据成功写入底层后，必须调用 <code>next([err])</code> 告诉流开始处理下一个数据</p>
<p><code>next</code> 的调用既可以是同步的，也可以是异步的，上游必须调用 <code>writable.end(data)</code> 来结束可写流，<code>data</code> 是可选的，此后，不能再调用 <code>write</code> 新增数据，在 <code>end</code> 方法调用后，当所有底层的写操作均完成时，会触发 <code>finish</code> 事件</p>
<h4 id="Readable-Stream-与-Writeable-Stream"><a href="#Readable-Stream-与-Writeable-Stream" class="headerlink" title="Readable Stream 与 Writeable Stream"></a>Readable Stream 与 Writeable Stream</h4><p>二者的关系</p>
<ul>
<li><code>Readable Stream</code> 是提供数据的 <code>Stream</code>，外部来源的数据均会存储到内部的 <code>Buffer</code> 数组内缓存起来</li>
<li><code>writeable Stream</code> 是消费数据的 <code>Stream</code>，从 <code>readable stream</code> 中获取数据，然后对得到的 <code>chunk</code> 块数据进行处理，至于如何处理，就依赖于具体实现（也就是 <code>_write</code> 的实现）</li>
</ul>
<p>首先看看 <code>Readdable Stream</code> 与 <code>writeable stream</code> 二者之间的流动关系</p>
<p><img src="https://gitee.com/heptaluan/backups/raw/master/cdn/node/08.png" alt></p>
<h4 id="pipe-的流程"><a href="#pipe-的流程" class="headerlink" title="pipe 的流程"></a>pipe 的流程</h4><p><code>stream</code> 内部是从 <code>readable stream</code> 流到 <code>writeable stream</code>，有两种处理方法</p>
<h6 id="pipe-连接两个-stream"><a href="#pipe-连接两个-stream" class="headerlink" title="pipe 连接两个 stream"></a>pipe 连接两个 stream</h6><figure class="highlight js hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">var</span> Read = <span class="hljs-built_in">require</span>(<span class="hljs-string">'stream'</span>).Readable</span><br><span class="line"><span class="hljs-keyword">var</span> Write = <span class="hljs-built_in">require</span>(<span class="hljs-string">'stream'</span>).Writable</span><br><span class="line"><span class="hljs-keyword">var</span> r = <span class="hljs-keyword">new</span> Read()</span><br><span class="line"><span class="hljs-keyword">var</span> w = <span class="hljs-keyword">new</span> Write()</span><br><span class="line"></span><br><span class="line">r.push(<span class="hljs-string">'hello'</span>)</span><br><span class="line">r.push(<span class="hljs-string">'world'</span>)</span><br><span class="line">r.push(<span class="hljs-literal">null</span>)</span><br><span class="line"></span><br><span class="line">w._write = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">chunk, ev, cb</span>) </span>&#123;</span><br><span class="line">  <span class="hljs-built_in">console</span>.log(chunk.toString())</span><br><span class="line">  cb()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">r.pipe(w)</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// hello</span></span><br><span class="line"><span class="hljs-comment">// world</span></span><br></pre></td></tr></table></figure>

<p><code>pipe</code> 是一种最简单直接的方法连接两个 <code>stream</code>，内部实现了数据传递的整个过程，在开发的时候不需要关注内部数据的流动</p>
<figure class="highlight js hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">Readable.prototype.pipe = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">dest, pipeOpts</span>) </span>&#123;</span><br><span class="line">  <span class="hljs-keyword">var</span> src = <span class="hljs-keyword">this</span></span><br><span class="line"></span><br><span class="line">  <span class="hljs-comment">// ...</span></span><br><span class="line"></span><br><span class="line">  src.on(<span class="hljs-string">'data'</span>, ondata)</span><br><span class="line"></span><br><span class="line">  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ondata</span>(<span class="hljs-params">chunk</span>) </span>&#123;</span><br><span class="line">    <span class="hljs-keyword">var</span> ret = dest.write(chunk)</span><br><span class="line">    <span class="hljs-keyword">if</span> (<span class="hljs-literal">false</span> === ret) &#123;</span><br><span class="line">      debug(<span class="hljs-string">'false write response, pause'</span>,</span><br><span class="line">        src._readableState.awaitDrain)</span><br><span class="line">      src._readableState.awaitDrain++</span><br><span class="line">      src.pause()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="hljs-comment">// ...</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>附一张 <code>pipe()</code> 的流程图</p>
<p><img src="https://gitee.com/heptaluan/backups/raw/master/cdn/node/27.png" alt></p>
<h6 id="事件-data-事件-drain-联合实现"><a href="#事件-data-事件-drain-联合实现" class="headerlink" title="事件 data + 事件 drain 联合实现"></a>事件 data + 事件 drain 联合实现</h6><figure class="highlight js hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">var</span> Read = <span class="hljs-built_in">require</span>(<span class="hljs-string">'stream'</span>).Readable</span><br><span class="line"><span class="hljs-keyword">var</span> Write = <span class="hljs-built_in">require</span>(<span class="hljs-string">'stream'</span>).Writable</span><br><span class="line"><span class="hljs-keyword">var</span> r = <span class="hljs-keyword">new</span> Read()</span><br><span class="line"><span class="hljs-keyword">var</span> w = <span class="hljs-keyword">new</span> Write()</span><br><span class="line"></span><br><span class="line">r.push(<span class="hljs-string">'hello'</span>)</span><br><span class="line">r.push(<span class="hljs-string">'world'</span>)</span><br><span class="line">r.push(<span class="hljs-literal">null</span>)</span><br><span class="line"></span><br><span class="line">w._write = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">chunk, ev, cb</span>) </span>&#123;</span><br><span class="line">  <span class="hljs-built_in">console</span>.log(chunk.toString())</span><br><span class="line">  cb()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">r.on(<span class="hljs-string">'data'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">chunk</span>) </span>&#123;</span><br><span class="line">  <span class="hljs-keyword">if</span> (!w.write(chunk)) &#123;</span><br><span class="line">    r.pause()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">w.on(<span class="hljs-string">'drain'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>&#123;</span><br><span class="line">  r.resume()</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// hello</span></span><br><span class="line"><span class="hljs-comment">// world</span></span><br></pre></td></tr></table></figure>

<h2 id="Duplex"><a href="#Duplex" class="headerlink" title="Duplex"></a>Duplex</h2><p><code>Duplex</code> 实际上就是继承了 <code>Readable</code> 和 <code>Writable</code> 的一类流，所以，一个 <code>Duplex</code> 对象既可当成可读流来使用（需要实现 <code>_read</code> 方法），也可当成可写流来使用（需要实现 <code>_write</code> 方法）</p>
<figure class="highlight js hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">var</span> Duplex = <span class="hljs-built_in">require</span>(<span class="hljs-string">'stream'</span>).Duplex</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">var</span> duplex = Duplex()</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// 可读端底层读取逻辑</span></span><br><span class="line">duplex._read = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;</span><br><span class="line">  <span class="hljs-keyword">this</span>._readNum = <span class="hljs-keyword">this</span>._readNum || <span class="hljs-number">0</span></span><br><span class="line">  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._readNum &gt; <span class="hljs-number">1</span>) &#123;</span><br><span class="line">    <span class="hljs-keyword">this</span>.push(<span class="hljs-literal">null</span>)</span><br><span class="line">  &#125; <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">    <span class="hljs-keyword">this</span>.push(<span class="hljs-string">' '</span> + (<span class="hljs-keyword">this</span>._readNum++))</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// 可写端底层写逻辑</span></span><br><span class="line">duplex._write = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">buf, enc, next</span>) </span>&#123;</span><br><span class="line">  <span class="hljs-comment">// a, b</span></span><br><span class="line">  process.stdout.write(<span class="hljs-string">'_write '</span> + buf.toString() + <span class="hljs-string">'\n'</span>)</span><br><span class="line">  next()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// 0, 1</span></span><br><span class="line">duplex.on(<span class="hljs-string">'data'</span>, data =&gt; <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'ondata'</span>, data.toString()))</span><br><span class="line"></span><br><span class="line">duplex.write(<span class="hljs-string">'a'</span>)</span><br><span class="line">duplex.write(<span class="hljs-string">'b'</span>)</span><br><span class="line"></span><br><span class="line">duplex.end()</span><br></pre></td></tr></table></figure>

<p>上面的代码中实现了 <code>_read</code> 方法，所以可以监听 <code>data</code> 事件来消耗 <code>Duplex</code> 产生的数据，同时，又实现了 <code>_write</code> 方法，可作为下游去消耗数据，因为它既可读又可写，所以它有两端，可写端和可读端，可写端的接口与 <code>Writable</code> 一致，作为下游来使用，可读端的接口与 <code>Readable</code> 一致，作为上游来使用，下面是另外一个示例，读取从 <code>A</code> 到 <code>Z</code> 的字母</p>
<figure class="highlight js hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">const</span> &#123; Duplex &#125; = <span class="hljs-built_in">require</span>(<span class="hljs-string">'stream'</span>)</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">const</span> inoutStream = <span class="hljs-keyword">new</span> Duplex(&#123;</span><br><span class="line">  write(chunk, encoding, callback) &#123;</span><br><span class="line">    <span class="hljs-built_in">console</span>.log(chunk.toString())</span><br><span class="line">    callback()</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  read() &#123;</span><br><span class="line">    <span class="hljs-keyword">this</span>.push(<span class="hljs-built_in">String</span>.fromCharCode(<span class="hljs-keyword">this</span>.currentCharCode++))</span><br><span class="line">    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.currentCharCode &gt; <span class="hljs-number">90</span>) &#123;</span><br><span class="line">      <span class="hljs-keyword">this</span>.push(<span class="hljs-literal">null</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">inoutStream.currentCharCode = <span class="hljs-number">65</span></span><br><span class="line"></span><br><span class="line">process.stdin.pipe(inoutStream).pipe(process.stdout)</span><br><span class="line"></span><br><span class="line">inoutStream.end()</span><br></pre></td></tr></table></figure>

<p>我们将可读的 <code>stdin</code> 流传输到 <code>duplex stream</code> 当中以使用 <code>callback()</code>，然后将 <code>duplex stream</code> 本身传输到可写的 <code>stdout</code> 流以查看我们的输出结果</p>
<h2 id="Transform"><a href="#Transform" class="headerlink" title="Transform"></a>Transform</h2><p><code>Tranform</code> 继承自 <code>Duplex</code>，并已经实现了 <code>_read</code> 和 <code>_write</code> 方法，我们只需要实现将两者结合起来的 <code>transform</code> 方法即可，它具有 <code>write</code> 方法，我们可以使用它来推送数据</p>
<p><img src="https://gitee.com/heptaluan/backups/raw/master/cdn/node/09.png" alt></p>
<p>下面是一个简单的 <code>transform stream</code> 示例，它会将你的输入结果转换为大写</p>
<figure class="highlight js hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">const</span> &#123; Transform &#125; = <span class="hljs-built_in">require</span>(<span class="hljs-string">'stream'</span>)</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">const</span> upperCaseTr = <span class="hljs-keyword">new</span> Transform(&#123;</span><br><span class="line">  transform(chunk, encoding, callback) &#123;</span><br><span class="line">    <span class="hljs-keyword">this</span>.push(chunk.toString().toUpperCase())</span><br><span class="line">    callback()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">process.stdin.pipe(upperCaseTr).pipe(process.stdout)</span><br></pre></td></tr></table></figure>

<h4 id="内置的-transform-stream"><a href="#内置的-transform-stream" class="headerlink" title="内置的 transform stream"></a>内置的 transform stream</h4><p><code>Node.js</code> 有一些内置的 <code>transform stream</code>，比如 <code>zlib</code> 和 <code>crypto</code>，下面是一个使用 <code>zlib.createGzip()</code> 方法结合 <code>fs</code> 的 <code>readable/writable</code> 流实现的一个文件压缩示例</p>
<figure class="highlight js hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>)</span><br><span class="line"><span class="hljs-keyword">const</span> zlib = <span class="hljs-built_in">require</span>(<span class="hljs-string">'zlib'</span>)</span><br><span class="line"><span class="hljs-keyword">const</span> file = process.argv[<span class="hljs-number">2</span>]</span><br><span class="line"></span><br><span class="line">fs.createReadStream(file)</span><br><span class="line">  .pipe(zlib.createGzip())</span><br><span class="line">  .pipe(fs.createWriteStream(file + <span class="hljs-string">'.gz'</span>))</span><br></pre></td></tr></table></figure>

<p>上述示例可以将传递进来的文件进行 <code>gzip</code> 压缩，下面我们来稍微扩展一下，比如我们希望用户在运行时可以看到进度结果，并且在完成的时侯看到已经完成的提示</p>
<figure class="highlight js hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>)</span><br><span class="line"><span class="hljs-keyword">const</span> zlib = <span class="hljs-built_in">require</span>(<span class="hljs-string">'zlib'</span>)</span><br><span class="line"><span class="hljs-keyword">const</span> file = process.argv[<span class="hljs-number">2</span>]</span><br><span class="line"></span><br><span class="line">fs.createReadStream(file)</span><br><span class="line">  .pipe(zlib.createGzip())</span><br><span class="line">  .on(<span class="hljs-string">'data'</span>, () =&gt; process.stdout.write(<span class="hljs-string">'.'</span>))</span><br><span class="line">  .pipe(fs.createWriteStream(file + <span class="hljs-string">'.zz'</span>))</span><br><span class="line">  .on(<span class="hljs-string">'finish'</span>, () =&gt; <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Done'</span>))</span><br></pre></td></tr></table></figure>

<p>在上面示例当中，我们也可以不使用 <code>on</code> 去监听其中的数据事件，而只需创建一个 <code>transform stream</code> 来追踪进度，然后将 <code>.on()</code> 方法替换为另一个 <code>.pipe()</code> 即可</p>
<figure class="highlight js hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>)</span><br><span class="line"><span class="hljs-keyword">const</span> zlib = <span class="hljs-built_in">require</span>(<span class="hljs-string">'zlib'</span>)</span><br><span class="line"><span class="hljs-keyword">const</span> file = process.argv[<span class="hljs-number">2</span>]</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">const</span> &#123; Transform &#125; = <span class="hljs-built_in">require</span>(<span class="hljs-string">'stream'</span>)</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">const</span> reportProgress = <span class="hljs-keyword">new</span> Transform(&#123;</span><br><span class="line">  transform(chunk, encoding, callback) &#123;</span><br><span class="line">    process.stdout.write(<span class="hljs-string">'.'</span>)</span><br><span class="line">    callback(<span class="hljs-literal">null</span>, chunk)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">fs.createReadStream(file)</span><br><span class="line">  .pipe(zlib.createGzip())</span><br><span class="line">  .pipe(reportProgress)</span><br><span class="line">  .pipe(fs.createWriteStream(file + <span class="hljs-string">'.zz'</span>))</span><br><span class="line">  .on(<span class="hljs-string">'finish'</span>, () =&gt; <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Done'</span>))</span><br></pre></td></tr></table></figure>

<p>注意上面示例当中的 <code>callback()</code> 方法的第二个参数，这样写是为了优先推送数据，在或者，我们需要在 <code>gzip</code> 压缩之前或之后对文件进行加密，和上面的示例一样，我们只需要按照我们想要的顺序添加另外一个 <code>transform stream</code> 即可</p>
<figure class="highlight js hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">const</span> crypto = <span class="hljs-built_in">require</span>(<span class="hljs-string">'crypto'</span>)</span><br><span class="line"><span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>)</span><br><span class="line"><span class="hljs-keyword">const</span> zlib = <span class="hljs-built_in">require</span>(<span class="hljs-string">'zlib'</span>)</span><br><span class="line"><span class="hljs-keyword">const</span> file = process.argv[<span class="hljs-number">2</span>]</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">const</span> &#123; Transform &#125; = <span class="hljs-built_in">require</span>(<span class="hljs-string">'stream'</span>)</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">const</span> reportProgress = <span class="hljs-keyword">new</span> Transform(&#123;</span><br><span class="line">  transform(chunk, encoding, callback) &#123;</span><br><span class="line">    process.stdout.write(<span class="hljs-string">'.'</span>)</span><br><span class="line">    callback(<span class="hljs-literal">null</span>, chunk)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">fs.createReadStream(file)</span><br><span class="line">  .pipe(zlib.createGzip())</span><br><span class="line">  .pipe(crypto.createCipher(<span class="hljs-string">'aes192'</span>, <span class="hljs-string">'a_secret'</span>))</span><br><span class="line">  .pipe(reportProgress)</span><br><span class="line">  .pipe(fs.createWriteStream(file + <span class="hljs-string">'.zz'</span>))</span><br><span class="line">  .on(<span class="hljs-string">'finish'</span>, () =&gt; <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Done'</span>))</span><br></pre></td></tr></table></figure>

<p>当然，为了解压上面我们压缩过的内容，我们只需要以相反的顺序执行 <code>crypto</code> 和 <code>zlib</code> 即可</p>
<figure class="highlight js hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">fs.createReadStream(file)</span><br><span class="line">  .pipe(crypto.createDecipher(<span class="hljs-string">'aes192'</span>, <span class="hljs-string">'a_secret'</span>))</span><br><span class="line">  .pipe(zlib.createGunzip())</span><br><span class="line">  .pipe(reportProgress)</span><br><span class="line">  .pipe(fs.createWriteStream(file.slice(<span class="hljs-number">0</span>, <span class="hljs-number">-3</span>)))</span><br><span class="line">  .on(<span class="hljs-string">'finish'</span>, () =&gt; <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Done'</span>))</span><br></pre></td></tr></table></figure>

<h2 id="自定义流"><a href="#自定义流" class="headerlink" title="自定义流"></a>自定义流</h2><p>自定义流的实现很简单，只要实现相应的内部待实现方法就可以了，具体来说</p>
<ul>
<li><code>readable stream</code>，实现 <code>_read</code> 方法来解决数据的获取问题</li>
<li><code>writeable stream</code>，实现 <code>_write</code> 方法来解决数据的去向问题</li>
<li><code>tranform stream</code>，实现 <code>_tranform</code> 方法来解决数据存放在 <code>Buffer</code> 前的转换工作</li>
</ul>
<p>代码如下</p>
<figure class="highlight js hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">// 自定义 readable stream 的实现</span></span><br><span class="line"><span class="hljs-keyword">var</span> Stream = <span class="hljs-built_in">require</span>(<span class="hljs-string">'stream'</span>)</span><br><span class="line"><span class="hljs-keyword">var</span> Read = Stream.Readable</span><br><span class="line"><span class="hljs-keyword">var</span> util = <span class="hljs-built_in">require</span>(<span class="hljs-string">'util'</span>)</span><br><span class="line"></span><br><span class="line">util.inherits(MyReadStream, Read)</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">MyReadStream</span>(<span class="hljs-params">data, opt</span>) </span>&#123;</span><br><span class="line">  Read.call(<span class="hljs-keyword">this</span>, opt)</span><br><span class="line">  <span class="hljs-keyword">this</span>.data = data || []</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">MyReadStream.prototype._read = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;</span><br><span class="line">  <span class="hljs-keyword">var</span> _this = <span class="hljs-keyword">this</span></span><br><span class="line">  <span class="hljs-keyword">this</span>.data.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">d</span>) </span>&#123;</span><br><span class="line">    _this.push(d)</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="hljs-keyword">this</span>.push(<span class="hljs-literal">null</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">var</span> data = [<span class="hljs-string">'aa'</span>, <span class="hljs-string">'bb'</span>, <span class="hljs-string">'cc'</span>]</span><br><span class="line"><span class="hljs-keyword">var</span> r = <span class="hljs-keyword">new</span> MyReadStream(data)</span><br><span class="line"></span><br><span class="line">r.on(<span class="hljs-string">'data'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">chunk</span>) </span>&#123;</span><br><span class="line">  <span class="hljs-built_in">console</span>.log(chunk.toString())</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="背压"><a href="#背压" class="headerlink" title="背压"></a>背压</h2><p>我们在上面介绍可读流（<code>Readable Streams</code>）的时候，提及了一个背压的概念，下面我们就来看看到底什么是背压，本小结内容主要是参考 <a href="https://nodejs.org/en/docs/guides/backpressuring-in-streams/" target="_blank" rel="noopener">Backpressuring in Streams</a> 这个文章整合而成</p>
<h4 id="数据流中的积压问题"><a href="#数据流中的积压问题" class="headerlink" title="数据流中的积压问题"></a>数据流中的积压问题</h4><p>通常在数据处理的时候我们会遇到一个普遍的问题，那就是背压，意思是在数据传输过程中有一大堆数据在缓存之后积压着，每次当数据到达结尾又遇到复杂的运算，又或者无论什么原因它比预期的慢，这样累积下来，从源头来的数据就会变得很庞大，像一个塞子一样堵塞住</p>
<p>为解决这个问题，必须存在一种适当的代理机制，确保流从一个源流入另外一个的时候是平滑顺畅的，不同的社区组织针对他们各自的问题单独做了解决，好例子比如 <code>Unix</code> 的管道和 <code>TCP</code> 的 <code>Socket</code>，在 <code>Node.js</code> 中，流（<code>stream</code>）已经是被采纳的解决方案</p>
<h4 id="数据太多，速度太快"><a href="#数据太多，速度太快" class="headerlink" title="数据太多，速度太快"></a>数据太多，速度太快</h4><p>有太多的例子证明有时 <code>Readable</code> 传输给 <code>Writable</code> 的速度远大于它接受和处理的速度，如果发生了这种情况，消费者开始为后面的消费而将数据列队形式积压起来，写入队列的时间越来越长，也正因为如此，更多的数据不得不保存在内存中知道整个流程全部处理完毕，写入磁盘的速度远比从磁盘读取数据慢得多，因此当我们试图压缩一个文件并写入磁盘时，积压的问题也就出现了，因为写磁盘的速度不能跟上读磁盘的速度</p>
<figure class="highlight js hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">// 数据将会在读入侧堆积，这样写入侧才能和数据流的读入速度保持同步</span></span><br><span class="line">inp.pipe(gzip).pipe(outputFile)</span><br></pre></td></tr></table></figure>

<p>这就是为什么说积压机制很重要，如果积压机制不存在，进程将用完你全部的系统内存，从而对其它进程产生显著影响，它独占系统大量资源直到任务完成为止，这最终将会导致一些问题</p>
<ul>
<li>明显使得其它进程处理变慢</li>
<li>太多繁重的垃圾回收  </li>
<li>内存耗尽</li>
</ul>
<h4 id="pipe-的背压平衡机制"><a href="#pipe-的背压平衡机制" class="headerlink" title="pipe 的背压平衡机制"></a>pipe 的背压平衡机制</h4><p>假设现在有一对 <code>Readable</code> 和 <code>Writable</code>，要求编程实现从 <code>Readable</code> 里面读取数据然后写到 <code>Writable</code> 中，那么面临的问题很有可能就是如果两者对数据的产生/消费速度不一致，那么需要手动协调两者速度使得任务可以完成，思路可能这样</p>
<ol start="0">
<li><code>Readable</code> 进入 <code>flowing</code> 模式，然后进入步骤 <code>2</code></li>
<li>听 <code>data</code> 事件，一旦有数据到达则进入步骤 <code>2</code>，如果捕捉到 <code>end</code> 事件就结束任务</li>
<li>数据写入到 <code>Writable</code>，如果返回 <code>true</code> 进入步骤 <code>1</code>，否则进入步骤 <code>3</code></li>
<li><code>Readable</code> 进入 <code>pause</code> 模式，并等待 <code>Writable</code> 发射 <code>drain</code> 事件</li>
<li>果 <code>Writable</code> 发射了 <code>drain</code> 事件，则返回步骤 <code>1</code></li>
</ol>
<p>而事实上 <code>pipe()</code> 的过程和上述很相似，它的源码如下</p>
<figure class="highlight js hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">Readable.prototype.pipe = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">dest, pipeOpts</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="hljs-comment">// ...</span></span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">var</span> ondrain = pipeOnDrain(src)</span><br><span class="line">  <span class="hljs-comment">// 当写操作返回 false 的时候，正常情况下必然会在稍后触发一个 drain 事件</span></span><br><span class="line">  dest.on(<span class="hljs-string">'drain'</span>, ondrain)</span><br><span class="line">  src.on(<span class="hljs-string">'data'</span>, ondata)</span><br><span class="line">  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ondata</span>(<span class="hljs-params">chunk</span>) </span>&#123;</span><br><span class="line">    <span class="hljs-keyword">var</span> ret = dest.write(chunk)</span><br><span class="line">    <span class="hljs-comment">// 如果写操作的返回值为 false，则暂停 readable 流</span></span><br><span class="line">    <span class="hljs-keyword">if</span> (ret === <span class="hljs-literal">false</span>) &#123;</span><br><span class="line">      <span class="hljs-keyword">if</span> (((state.pipesCount === <span class="hljs-number">1</span> &amp;&amp; state.pipes === dest) ||</span><br><span class="line">        (state.pipesCount &gt; <span class="hljs-number">1</span> &amp;&amp; state.pipes.indexOf(dest) !== <span class="hljs-number">-1</span>)) &amp;&amp;</span><br><span class="line">        !cleanedUp) &#123;</span><br><span class="line">        state.awaitDrain++</span><br><span class="line">      &#125;</span><br><span class="line">      src.pause()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="hljs-comment">// ...</span></span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">return</span> dest</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">pipeOnDrain</span>(<span class="hljs-params">src</span>) </span>&#123;</span><br><span class="line">  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;</span><br><span class="line">    <span class="hljs-keyword">var</span> state = src._readableState</span><br><span class="line">    <span class="hljs-keyword">if</span> (state.awaitDrain)</span><br><span class="line">      state.awaitDrain--</span><br><span class="line">    <span class="hljs-keyword">if</span> (state.awaitDrain === <span class="hljs-number">0</span> &amp;&amp; EE.listenerCount(src, <span class="hljs-string">'data'</span>)) &#123;</span><br><span class="line">      <span class="hljs-comment">// 将流重新设为 flowing 模式</span></span><br><span class="line">      state.flowing = <span class="hljs-literal">true</span></span><br><span class="line">      <span class="hljs-comment">// 将缓冲区中残留的数据读取并重新触发 data 事件</span></span><br><span class="line">      flow(src)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过上面的代码我们可以看到</p>
<ul>
<li>当向 <code>dest</code> 写入数据返回 <code>false</code> 时，马上调用 <code>src.pause()</code> 暂停流，<code>src.pause()</code> 将暂停事件流，但不会暂停数据生成</li>
<li>也就是说 <code>src</code> 此时依然汲取底层数据填充缓冲区，只是暂停发射 <code>data</code> 事件，等到缓冲区的数据量超过警戒线才会停止汲取</li>
<li>因为写入数据返回 <code>false</code>，因此在稍后的某个时候 <code>dest</code> 必然会发射 <code>drain</code> 事件</li>
<li>当 <code>drain</code> 事件发生后，<code>src</code> 再次进入 <code>flowing</code> 模式自动产生数据，同时将缓冲区中的残留数据写入 <code>dest</code></li>
</ul>
<h4 id="pipe-的生命周期"><a href="#pipe-的生命周期" class="headerlink" title=".pipe() 的生命周期"></a>.pipe() 的生命周期</h4><p>为了对积压有一个更好的理解，这里有一副 <code>Readable</code> 流正通过 <code>piped</code> 流入 <code>Writable</code> 流的整个生命周期图</p>
<figure class="highlight js hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">                                                     +===================+</span><br><span class="line">                         x--&gt;  Piping functions   +--&gt;   src.pipe(dest)  |</span><br><span class="line">                         x     are <span class="hljs-keyword">set</span> up during     |===================|</span><br><span class="line">                         x     the .pipe method.     |  Event callbacks  |</span><br><span class="line">  +===============+      x                           |-------------------|</span><br><span class="line">  |   Your Data   |      x     They exist outside    | .on('close', cb)  |</span><br><span class="line">  +=======+=======+      x     the data flow, but    | .on('data', cb)   |</span><br><span class="line">          |              x     importantly attach    | .on('drain', cb)  |</span><br><span class="line">          |              x     events, and their     | .on('unpipe', cb) |</span><br><span class="line">+---------v---------+    x     respective callbacks. | .on('error', cb)  |</span><br><span class="line">|  Readable Stream  +----+                           | .on('finish', cb) |</span><br><span class="line">+-^-------^-------^-+    |                           | .on('end', cb)    |</span><br><span class="line">  ^       |       ^      |                           +-------------------+</span><br><span class="line">  |       |       |      |</span><br><span class="line">  |       ^       |      |</span><br><span class="line">  ^       ^       ^      |    +-------------------+         +=================+</span><br><span class="line">  ^       |       ^      +----&gt;  Writable Stream  +---------&gt;  .write(chunk)  |</span><br><span class="line">  |       |       |           +-------------------+         +=======+=========+</span><br><span class="line">  |       |       |                                                 |</span><br><span class="line">  |       ^       |                              +------------------v---------+</span><br><span class="line">  ^       |       +-&gt; if (!chunk)                |    Is this chunk too big?  |</span><br><span class="line">  ^       |       |     emit.end()               |    Is the queue busy?      |</span><br><span class="line">  |       |       +-&gt; else                       +-------+----------------+---+</span><br><span class="line">  |       ^       |     emit.write()                     |                |</span><br><span class="line">  |       ^       ^                                   +--v---+        +---v---+</span><br><span class="line">  |       |       ^-----------------------------------&lt;  No  |        |  Yes  |</span><br><span class="line">  ^       |                                           +------+        +---v---+</span><br><span class="line">  ^       |                                                               |</span><br><span class="line">  |       ^               emit.pause()            +=================+     |</span><br><span class="line">  |       ^---------------^-----------------------+  return false   &lt;-----+---+</span><br><span class="line">  |                                               +=================+         |</span><br><span class="line">  |                                                                           |</span><br><span class="line">  ^            when queue is empty     +============+                         |</span><br><span class="line">  ^------------^-----------------------&lt;  Buffering |                         |</span><br><span class="line">               |                       |============|                         |</span><br><span class="line">               +&gt; emit.drain()         |  ^Buffer^  |                         |</span><br><span class="line">               +&gt; emit.resume()        +------------+                         |</span><br><span class="line">                                       |  ^Buffer^  |                         |</span><br><span class="line">                                       +------------+   add chunk to queue    |</span><br><span class="line">                                       |            &lt;---^---------------------&lt;</span><br><span class="line">                                       +============+</span><br></pre></td></tr></table></figure>

<p>注意，如果你创建一些管道准备把一些流串联起来从而操纵数据，你应该实现 <code>Transform</code> 流，在这种情况下，从 <code>Readable</code> 流中的输出进入 <code>Transform</code>，并且会被管道输送进入 <code>Writable</code></p>
<figure class="highlight js hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Readable.pipe(Transformable).pipe(Writable)</span><br></pre></td></tr></table></figure>

<p>积压将被自动应用，但是同时请注意输入和输出 <code>Transform</code> 的水准值，可以手动控制，并且会影响到积压系统，如果想要了解更多，可以参考 <a href="https://cnodejs.org/topic/56ba030271204e03637a3870" target="_blank" rel="noopener">通过源码解析 Node.js 中导流（pipe）的实现</a> 这篇文章</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>在 <code>Node.js</code> 中有四种类型的流，它们是 <code>readable</code>、<code>writeable</code>、<code>duplex</code> 和 <code>transform</code></p>
<ul>
<li><code>readable</code>，可读流，表示数据能够被消费，是对提供数据的源头（<code>source</code>）的抽象，工作在下面两种模式之一<ul>
<li>在 <code>flowing</code> 模式下，可读流自动从系统底层读取数据，并通过 <code>EventEmitter</code> 接口的事件尽快将数据提供给应用<ul>
<li>通过注册 <code>data</code>、<code>pipe</code>、<code>resume</code> 可以自动获取所需要的数据，比如通过事件 <code>data</code> 的方式</li>
</ul>
</li>
<li>在 <code>paused</code> 模式下，必须显式调用 <code>stream.read()</code> 方法来从流中读取数据片段<ul>
<li>在 <code>paused mode</code> 下，需要手动地读取数据，并且可以直接指定读取数据的长度</li>
<li>还可以通过监听事件 <code>readable</code>，触发时手工读取 <code>chunk</code> 数据</li>
<li>一旦注册了 <code>readable</code> 事件，必须手工读取 <code>read</code> 数据，否则数据就会流失</li>
</ul>
</li>
<li>如何触发<ul>
<li><code>paused mode</code>，调用 <code>pause</code> 方法（没有 <code>pipe</code> 方法）、移除 <code>data</code> 事件和释放所有 <code>pipe</code></li>
<li><code>flowing mode</code>，注册事件 <code>data</code>、调用 <code>resume</code> 方法、调用 <code>pipe</code> 方法</li>
</ul>
</li>
</ul>
</li>
<li><code>writeable</code>，可写流，表示数据能被写，所有 <code>Writable</code> 流都实现了 <code>stream.Writable</code> 类定义的接口<ul>
<li>本质上 只是需要实现的是 <code>_write(data, enc, next)</code> 方法</li>
<li>在 <code>_write</code> 方法中，当数据成功写入底层后，必须调用 <code>next([err])</code> 告诉流开始处理下一个数据</li>
<li><code>next</code> 的调用既可以是同步的，也可以是异步的</li>
<li>上游必须调用 <code>writable.end(data)</code> 来结束可写流，<code>data</code> 是可选的，此后，不能再调用 <code>write</code> 新增数据</li>
<li>在 <code>end</code> 方法调用后，当所有底层的写操作均完成时，会触发 <code>finish</code> 事件</li>
</ul>
</li>
<li><code>duplex</code>，实际上就是继承了 <code>Readable</code> 和 <code>Writable</code> 的一类流<ul>
<li>一个 <code>duplex</code> 对象既可当成可读流来使用（需要实现 <code>_read</code> 方法），也可当成可写流来使用（需要实现 <code>_write</code> 方法）</li>
</ul>
</li>
<li><code>transform</code>，它也是 <code>duplex</code> 流，能够用来修改或转换数据，例如 <code>zlib.createGzip</code> 方法用来使用 <code>gzip</code> 压缩数据（内置的 <code>transform stream</code>）<ul>
<li>你可以认为 <code>transform</code> 流是一个函数，它的输入是 <code>Writable</code> 流，输出是 <code>Readable</code> 流</li>
<li><code>Tranform</code> 继承自 <code>duplex</code>，并已经实现了 <code>_read</code> 和 <code>_write</code> 方法</li>
<li>只需要实现将两者结合起来的 <code>transform</code> 方法即可，它具有 <code>write</code> 方法，我们可以使用它来推送数据</li>
</ul>
</li>
</ul>
<p>推荐一下这篇文章 <a href="https://github.com/zoubin/streamify-your-node-program" target="_blank" rel="noopener">Node Stream</a>，干货很多</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a href="https://github.com/substack/stream-handbook" target="_blank" rel="noopener">stream-handbook</a></li>
<li><a href="http://fe.meituan.com/stream-basics.html" target="_blank" rel="noopener">Node.js Stream - 基础篇</a></li>
<li><a href="http://fe.meituan.com/stream-internals.html" target="_blank" rel="noopener">Node.js Stream - 进阶篇</a></li>
<li><a href="http://fe.meituan.com/stream-in-action.html" target="_blank" rel="noopener">Node.js Stream - 实战篇</a></li>
<li><a href="https://github.com/zoubin/streamify-your-node-program" target="_blank" rel="noopener">streamify-your-node-program</a></li>
<li><a href="http://nodejs.cn/api/stream.html#stream_stream" target="_blank" rel="noopener">Node.js 中文网</a></li>
<li><a href="https://www.freecodecamp.org/news/node-js-streams-everything-you-need-to-know-c9141306be93/" target="_blank" rel="noopener">Node.js Streams: Everything you need to know</a></li>
<li><a href="https://github.com/jabez128/stream-handbook" target="_blank" rel="noopener">stream-handbook</a></li>
<li><a href="https://github.com/zoubin/streamify-your-node-program/blob/master/README.md" target="_blank" rel="noopener">streamify-your-node-program</a></li>
</ul>

        </div>
        
        <div class="level is-size-7 is-uppercase">
            <div class="level-start">
                <div class="level-item">
                    <span class="is-size-6 has-text-grey has-mr-7">#</span>
                    <a class="has-link-grey -link" href="/tags/Node-js/">Node.js</a>
                </div>
            </div>
        </div>
        
        
        
    </div>
</div>





<div class="card card-transparent">
    <div class="level post-navigation is-flex-wrap is-mobile">
        
        <div class="level-start">
            <a class="level level-item has-link-grey  article-nav-prev" href="/2019/10/17/JavaScript/47/">
                <i class="level-item fa fa-chevron-left"></i>
                <span class="level-item">正则表达式</span>
            </a>
        </div>
        
        
        <div class="level-end">
            <a class="level level-item has-link-grey  article-nav-next" href="/2019/10/02/Node/09/">
                <span class="level-item">Node.js 中的 HTTP 模块</span>
                <i class="level-item fa fa-chevron-right"></i>
            </a>
        </div>
        
    </div>
</div>



<div class="card">
    <div class="card-content">
        <h3 class="title is-5 has-text-weight-normal">评论</h3>
        
<div id="comment-container"></div>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1.4.1/dist/gitalk.css">
<script src="https://cdn.jsdelivr.net/npm/gitalk@1.4.1/dist/gitalk.min.js"></script>
<script>
    var gitalk = new Gitalk({
        clientID: '584b59de0d23cd48fbdd',
        clientSecret: '5554c9aab0a640015867806f438bd2e10f297e5a',
        id: '60e9034873ab8b74f432470389e66c48',
        repo: 'gitalk',
        owner: 'heptaluan',
        admin: "heptaluan"
    })
    gitalk.render('comment-container')
</script>

    </div>
</div>
</div>
                




<div class="column is-4-tablet is-4-desktop is-3-widescreen  has-order-1 column-left ">
    
        
<div class="card widget">
    <div class="card-content">
        <nav class="level">
            <div class="level-item has-text-centered">
                <div>
                    
                        <figure class="avatar image is-128x128 has-mb-6">
                            <img class="is-rounded" src="https://gitee.com/heptaluan/backups/raw/master/cdn/avatar.png" alt="heptaluan">
                        </figure>
                    
                    
                    <p class="is-size-4 is-block">
                        heptaluan
                    </p>
                    
                    
                    <p class="is-size-6 is-block">
                        Torches@Aimer
                    </p>
                    
                    
                    <p class="is-size-6 is-flex is-flex-center has-text-grey">
                        <i class="fas fa-map-marker-alt has-mr-7"></i>
                        <span>WuHan China</span>
                    </p>
                    
                </div>
            </div>
        </nav>
        <!-- <nav class="level is-mobile">
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        文章
                    </p>
                    <p class="title has-text-weight-normal">
                        151
                    </p>
                </div>
            </div>
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        分类
                    </p>
                    <p class="title has-text-weight-normal">
                        8
                    </p>
                </div>
            </div>
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        标签
                    </p>
                    <p class="title has-text-weight-normal">
                        8
                    </p>
                </div>
            </div>
        </nav> -->
        <!-- <div class="level">
            <a class="level-item button is-link is-rounded" href="https://github.com/ppoffice" target="_blank">
                关注我</a>
        </div> -->
        
        
    </div>
</div>
    
        
<div class="card widget" id="toc">
    <div class="card-content">
        <div class="menu">
            <h3 class="menu-label">
                目录
            </h3>
            <ul class="menu-list"><li>
        <a class="is-flex" href="#什么是-Stream">
        <span class="has-mr-6">1</span>
        <span>什么是 Stream</span>
        </a></li><li>
        <a class="is-flex" href="#Node-js-中的流">
        <span class="has-mr-6">2</span>
        <span>Node.js 中的流</span>
        </a></li><li>
        <a class="is-flex" href="#流的分类">
        <span class="has-mr-6">3</span>
        <span>流的分类</span>
        </a></li><li>
        <a class="is-flex" href="#Readable">
        <span class="has-mr-6">4</span>
        <span>Readable</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#paused-mode">
        <span class="has-mr-6">4.1</span>
        <span>paused mode</span>
        </a></li><li>
        <a class="is-flex" href="#flowing-mode">
        <span class="has-mr-6">4.2</span>
        <span>flowing mode</span>
        </a></li><li>
        <a class="is-flex" href="#readable-与-data-事件">
        <span class="has-mr-6">4.3</span>
        <span>readable 与 data 事件</span>
        </a></li><li>
        <a class="is-flex" href="#readable-事件">
        <span class="has-mr-6">4.4</span>
        <span>readable 事件</span>
        </a></li><li>
        <a class="is-flex" href="#readable-的触发时机">
        <span class="has-mr-6">4.5</span>
        <span>readable 的触发时机</span>
        </a></li><li>
        <a class="is-flex" href="#data-事件">
        <span class="has-mr-6">4.6</span>
        <span>data 事件</span>
        </a></li><li>
        <a class="is-flex" href="#data-的触发时机">
        <span class="has-mr-6">4.7</span>
        <span>data 的触发时机</span>
        </a></li><li>
        <a class="is-flex" href="#如果同时监听-readable-和-data-事件">
        <span class="has-mr-6">4.8</span>
        <span>如果同时监听 readable 和 data 事件</span>
        </a></li></ul></li><li>
        <a class="is-flex" href="#Writable">
        <span class="has-mr-6">5</span>
        <span>Writable</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#Readable-Stream-与-Writeable-Stream">
        <span class="has-mr-6">5.1</span>
        <span>Readable Stream 与 Writeable Stream</span>
        </a></li><li>
        <a class="is-flex" href="#pipe-的流程">
        <span class="has-mr-6">5.2</span>
        <span>pipe 的流程</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#pipe-连接两个-stream">
        <span class="has-mr-6">5.2.1</span>
        <span>pipe 连接两个 stream</span>
        </a></li><li>
        <a class="is-flex" href="#事件-data-事件-drain-联合实现">
        <span class="has-mr-6">5.2.2</span>
        <span>事件 data + 事件 drain 联合实现</span>
        </a></li></ul></li></ul></li><li>
        <a class="is-flex" href="#Duplex">
        <span class="has-mr-6">6</span>
        <span>Duplex</span>
        </a></li><li>
        <a class="is-flex" href="#Transform">
        <span class="has-mr-6">7</span>
        <span>Transform</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#内置的-transform-stream">
        <span class="has-mr-6">7.1</span>
        <span>内置的 transform stream</span>
        </a></li></ul></li><li>
        <a class="is-flex" href="#自定义流">
        <span class="has-mr-6">8</span>
        <span>自定义流</span>
        </a></li><li>
        <a class="is-flex" href="#背压">
        <span class="has-mr-6">9</span>
        <span>背压</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#数据流中的积压问题">
        <span class="has-mr-6">9.1</span>
        <span>数据流中的积压问题</span>
        </a></li><li>
        <a class="is-flex" href="#数据太多，速度太快">
        <span class="has-mr-6">9.2</span>
        <span>数据太多，速度太快</span>
        </a></li><li>
        <a class="is-flex" href="#pipe-的背压平衡机制">
        <span class="has-mr-6">9.3</span>
        <span>pipe 的背压平衡机制</span>
        </a></li><li>
        <a class="is-flex" href="#pipe-的生命周期">
        <span class="has-mr-6">9.4</span>
        <span>.pipe() 的生命周期</span>
        </a></li></ul></li><li>
        <a class="is-flex" href="#总结">
        <span class="has-mr-6">10</span>
        <span>总结</span>
        </a></li><li>
        <a class="is-flex" href="#参考">
        <span class="has-mr-6">11</span>
        <span>参考</span>
        </a></li></ul>
        </div>
    </div>
</div>

    
        


    
        
<div class="card widget">
    <div class="card-content">
        <div class="menu">
            <h3 class="menu-label">
                分类
            </h3>
            <ul class="menu-list">
            <li>
        <a class="level is-marginless" href="/categories/Angular/">
            <span class="level-start">
                <span class="level-item">Angular</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">15</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/CSS/">
            <span class="level-start">
                <span class="level-item">CSS</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">14</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/Essay/">
            <span class="level-start">
                <span class="level-item">Essay</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">29</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/HTTP/">
            <span class="level-start">
                <span class="level-item">HTTP</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">11</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/JavaScript/">
            <span class="level-start">
                <span class="level-item">JavaScript</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">45</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/Node-js/">
            <span class="level-start">
                <span class="level-item">Node.js</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">14</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/React/">
            <span class="level-start">
                <span class="level-item">React</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">18</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/Vue/">
            <span class="level-start">
                <span class="level-item">Vue</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">5</span>
            </span>
        </a></li>
            </ul>
        </div>
    </div>
</div>
    
        
<div class="card widget">
    <div class="card-content">
        <h3 class="menu-label">
            标签云
        </h3>
        <a href="/tags/Angular/" style="font-size: 15px;">Angular</a> <a href="/tags/CSS/" style="font-size: 13.33px;">CSS</a> <a href="/tags/Essay/" style="font-size: 18.33px;">Essay</a> <a href="/tags/HTTP/" style="font-size: 11.67px;">HTTP</a> <a href="/tags/JavaScript/" style="font-size: 20px;">JavaScript</a> <a href="/tags/Node-js/" style="font-size: 13.33px;">Node.js</a> <a href="/tags/React/" style="font-size: 16.67px;">React</a> <a href="/tags/Vue/" style="font-size: 10px;">Vue</a>
    </div>
</div>

    
    
        <div class="column-right-shadow  ">
        
            
<div class="card widget">
    <div class="card-content">
        <h3 class="menu-label">
            <a href="/tips" class="tips">
                最新文章
            </a>
        </h3>
        
        <article class="media">
            
            <a href="/2021/03/07/Vue/06/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="https://gitee.com/heptaluan/backups/raw/master/cdn/cover/06.webp" alt="Vite 的工程化流程">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2021-03-06T16:00:00.000Z">2021-03-07</time></div>
                    <a href="/2021/03/07/Vue/06/" class="has-link-black-ter is-size-6">Vite 的工程化流程</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/Vue/">Vue</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <a href="/2021/01/10/JavaScript/59/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="https://gitee.com/heptaluan/backups/raw/master/cdn/cover/59.webp" alt="在 React 当中使用 TypeScript">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2021-01-09T16:00:00.000Z">2021-01-10</time></div>
                    <a href="/2021/01/10/JavaScript/59/" class="has-link-black-ter is-size-6">在 React 当中使用 TypeScript</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/JavaScript/">JavaScript</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <a href="/2021/01/09/JavaScript/58/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="https://gitee.com/heptaluan/backups/raw/master/cdn/cover/58.webp" alt="深入 TypeScript 当中的泛型">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2021-01-08T16:00:00.000Z">2021-01-09</time></div>
                    <a href="/2021/01/09/JavaScript/58/" class="has-link-black-ter is-size-6">深入 TypeScript 当中的泛型</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/JavaScript/">JavaScript</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <a href="/2021/01/01/JavaScript/57/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="https://gitee.com/heptaluan/backups/raw/master/cdn/cover/57.webp" alt="深入 TypeScript">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2020-12-31T16:00:00.000Z">2021-01-01</time></div>
                    <a href="/2021/01/01/JavaScript/57/" class="has-link-black-ter is-size-6">深入 TypeScript</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/JavaScript/">JavaScript</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <a href="/2020/12/26/JavaScript/56/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="https://gitee.com/heptaluan/backups/raw/master/cdn/cover/56.webp" alt="重温 TypeScript">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2020-12-25T16:00:00.000Z">2020-12-26</time></div>
                    <a href="/2020/12/26/JavaScript/56/" class="has-link-black-ter is-size-6">重温 TypeScript</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/JavaScript/">JavaScript</a>
                    </p>
                </div>
            </div>
        </article>
        
    </div>
</div>

        
            <div class="card widget">
    <div class="card-content">
        <div class="menu">
        <h3 class="menu-label">
            归档
        </h3>
        <ul class="menu-list">
        
        <li>
            <a class="level is-marginless" href="/archives/2021/03/">
                <span class="level-start">
                    <span class="level-item">三月 2021</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2021/01/">
                <span class="level-start">
                    <span class="level-item">一月 2021</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2020/12/">
                <span class="level-start">
                    <span class="level-item">十二月 2020</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2020/11/">
                <span class="level-start">
                    <span class="level-item">十一月 2020</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2020/10/">
                <span class="level-start">
                    <span class="level-item">十月 2020</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">6</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2020/09/">
                <span class="level-start">
                    <span class="level-item">九月 2020</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">5</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2020/08/">
                <span class="level-start">
                    <span class="level-item">八月 2020</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">2</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2020/07/">
                <span class="level-start">
                    <span class="level-item">七月 2020</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">2</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2020/06/">
                <span class="level-start">
                    <span class="level-item">六月 2020</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">4</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2020/05/">
                <span class="level-start">
                    <span class="level-item">五月 2020</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2020/04/">
                <span class="level-start">
                    <span class="level-item">四月 2020</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">5</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2020/03/">
                <span class="level-start">
                    <span class="level-item">三月 2020</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">7</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2020/02/">
                <span class="level-start">
                    <span class="level-item">二月 2020</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">4</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2020/01/">
                <span class="level-start">
                    <span class="level-item">一月 2020</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">5</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/12/">
                <span class="level-start">
                    <span class="level-item">十二月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">7</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/11/">
                <span class="level-start">
                    <span class="level-item">十一月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">4</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/10/">
                <span class="level-start">
                    <span class="level-item">十月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">6</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/09/">
                <span class="level-start">
                    <span class="level-item">九月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">7</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/08/">
                <span class="level-start">
                    <span class="level-item">八月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/07/">
                <span class="level-start">
                    <span class="level-item">七月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">4</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/06/">
                <span class="level-start">
                    <span class="level-item">六月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">5</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/05/">
                <span class="level-start">
                    <span class="level-item">五月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">5</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/04/">
                <span class="level-start">
                    <span class="level-item">四月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">2</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/03/">
                <span class="level-start">
                    <span class="level-item">三月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">2</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/02/">
                <span class="level-start">
                    <span class="level-item">二月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">2</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/01/">
                <span class="level-start">
                    <span class="level-item">一月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/12/">
                <span class="level-start">
                    <span class="level-item">十二月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">6</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/11/">
                <span class="level-start">
                    <span class="level-item">十一月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">4</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/10/">
                <span class="level-start">
                    <span class="level-item">十月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/09/">
                <span class="level-start">
                    <span class="level-item">九月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/08/">
                <span class="level-start">
                    <span class="level-item">八月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/07/">
                <span class="level-start">
                    <span class="level-item">七月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/06/">
                <span class="level-start">
                    <span class="level-item">六月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/05/">
                <span class="level-start">
                    <span class="level-item">五月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">2</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/04/">
                <span class="level-start">
                    <span class="level-item">四月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/03/">
                <span class="level-start">
                    <span class="level-item">三月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">2</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/02/">
                <span class="level-start">
                    <span class="level-item">二月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/01/">
                <span class="level-start">
                    <span class="level-item">一月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2017/12/">
                <span class="level-start">
                    <span class="level-item">十二月 2017</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2017/11/">
                <span class="level-start">
                    <span class="level-item">十一月 2017</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2017/10/">
                <span class="level-start">
                    <span class="level-item">十月 2017</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">2</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2017/09/">
                <span class="level-start">
                    <span class="level-item">九月 2017</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">2</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2017/08/">
                <span class="level-start">
                    <span class="level-item">八月 2017</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2017/07/">
                <span class="level-start">
                    <span class="level-item">七月 2017</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2017/06/">
                <span class="level-start">
                    <span class="level-item">六月 2017</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">2</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2017/05/">
                <span class="level-start">
                    <span class="level-item">五月 2017</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2017/04/">
                <span class="level-start">
                    <span class="level-item">四月 2017</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">2</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2017/03/">
                <span class="level-start">
                    <span class="level-item">三月 2017</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2017/01/">
                <span class="level-start">
                    <span class="level-item">一月 2017</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2016/12/">
                <span class="level-start">
                    <span class="level-item">十二月 2016</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        </ul>
        </div>
    </div>
</div>
        
            <div class="card widget">
    <div class="card-content">
        <div class="menu">
            <h3 class="menu-label">
                标签
            </h3>
            <div class="field is-grouped is-grouped-multiline">
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Angular/">
                        <span class="tag">Angular</span>
                        <span class="tag is-grey">15</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/CSS/">
                        <span class="tag">CSS</span>
                        <span class="tag is-grey">14</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Essay/">
                        <span class="tag">Essay</span>
                        <span class="tag is-grey">29</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/HTTP/">
                        <span class="tag">HTTP</span>
                        <span class="tag is-grey">11</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/JavaScript/">
                        <span class="tag">JavaScript</span>
                        <span class="tag is-grey">45</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Node-js/">
                        <span class="tag">Node.js</span>
                        <span class="tag is-grey">14</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/React/">
                        <span class="tag">React</span>
                        <span class="tag is-grey">18</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Vue/">
                        <span class="tag">Vue</span>
                        <span class="tag is-grey">5</span>
                    </a>
                </div>
                
            </div>
        </div>
    </div>
</div>
        
        </div>
    
</div>

                
            </div>
        </div>
    </section>
    <footer class="footer">
    <div class="container">
        <div class="level">
            <div class="level-start has-text-centered-mobile">
                <!-- <a class="footer-logo is-block has-mb-6" href="/">
                
                    <img src="/images/logo.svg" alt="Node.js 中的 Stream（流）" height="28">
                
                </a> -->
                <p class="is-size-7">
                &copy; 2016 - 2021
                Made with ✿  heptaluan&nbsp;
                
                </p>
            </div>
            <!-- <div class="level-end">
            
            </div> -->
        </div>
    </div>
</footer>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script>
<script>moment.locale("zh-CN");</script>


    
    
    
    <script src="/js/animation.js"></script>
    

    
    
    
    <script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script>
    <script src="/js/gallery.js" defer></script>
    

    
    

<div id="outdated">
    <h6>Your browser is out-of-date!</h6>
    <p>Update your browser to view this website correctly. <a id="btnUpdateBrowser" href="http://outdatedbrowser.com/">Update
            my browser now </a></p>
    <p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">&times;</a></p>
</div>
<script src="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.js" defer></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        outdatedBrowser({
            bgColor: '#f25648',
            color: '#ffffff',
            lowerThan: 'flex'
        });
    });
</script>


    
    
<script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    MathJax.Hub.Config({
        'HTML-CSS': {
            matchFontHeight: false
        },
        SVG: {
            matchFontHeight: false
        },
        CommonHTML: {
            matchFontHeight: false
        },
        tex2jax: {
            inlineMath: [
                ['$','$'],
                ['\\(','\\)']
            ]
        }
    });
});
</script>

    
    

<a id="back-to-top" title="回到顶端" href="javascript:;">
    <i class="fa fa-chevron-up"></i>
</a>
<script src="/js/back-to-top.js" defer></script>


    
    

    
    
    
    

    
    
    
    
    
    <script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script>
    <script src="/js/clipboard.js" defer></script>
    

    
    
    


<script src="/js/main.js" defer></script>

    
    <div class="searchbox ins-search">
    <div class="searchbox-container ins-search-container">
        <div class="searchbox-input-wrapper">
            <input type="text" class="searchbox-input ins-search-input" placeholder="想要查找什么...">
            <span class="searchbox-close ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="searchbox-result-wrapper ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
    (function (window) {
        var INSIGHT_CONFIG = {
            TRANSLATION: {
                POSTS: '文章',
                PAGES: '页面',
                CATEGORIES: '分类',
                TAGS: '标签',
                UNTITLED: '(无标题)',
            },
            CONTENT_URL: '/content.json',
        };
        window.INSIGHT_CONFIG = INSIGHT_CONFIG;
    })(window);
</script>
<script src="/js/insight.js" defer></script>
<link rel="stylesheet" href="/css/search.css">
<link rel="stylesheet" href="/css/insight.css">
    
</body>
</html>