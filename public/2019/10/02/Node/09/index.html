<!DOCTYPE html>
<html lang="zh">
<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
<title>Node.js 中的 HTTP 模块 - heptaluan&#39;s blog</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">



    <meta name="description" content="HTTP 模块是 Node.js 中非常重要的一个核心模块，通过 HTTP 模块，可以使用其 http.createServer() 方法创建一个 HTTP 服务器，也可以使用其 http.request() 方法创建一个 HTTP 客户端，Node.js 对 HTTP 协议及相关 API 的封装比较底层，其仅能处理流和消息，对于消息的处理，也仅解析成『报文头』和『报文体』，但是不解析实际的报文头">
<meta name="keywords" content="Node.js">
<meta property="og:type" content="article">
<meta property="og:title" content="Node.js 中的 HTTP 模块">
<meta property="og:url" content="http://yoursite.com/2019/10/02/Node/09/index.html">
<meta property="og:site_name" content="heptaluan&#39;s blog">
<meta property="og:description" content="HTTP 模块是 Node.js 中非常重要的一个核心模块，通过 HTTP 模块，可以使用其 http.createServer() 方法创建一个 HTTP 服务器，也可以使用其 http.request() 方法创建一个 HTTP 客户端，Node.js 对 HTTP 协议及相关 API 的封装比较底层，其仅能处理流和消息，对于消息的处理，也仅解析成『报文头』和『报文体』，但是不解析实际的报文头">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://gitee.com/heptaluan/backups/raw/master/cdn/cover/09.webp">
<meta property="og:updated_time" content="2021-03-09T08:29:33.727Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Node.js 中的 HTTP 模块">
<meta name="twitter:description" content="HTTP 模块是 Node.js 中非常重要的一个核心模块，通过 HTTP 模块，可以使用其 http.createServer() 方法创建一个 HTTP 服务器，也可以使用其 http.request() 方法创建一个 HTTP 客户端，Node.js 对 HTTP 协议及相关 API 的封装比较底层，其仅能处理流和消息，对于消息的处理，也仅解析成『报文头』和『报文体』，但是不解析实际的报文头">
<meta name="twitter:image" content="https://gitee.com/heptaluan/backups/raw/master/cdn/cover/09.webp">







<link rel="icon" href="https://gitee.com/heptaluan/backups/raw/master/cdn/favicon.ico">


<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.7.2/css/bulma.css">
<link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.7.0/css/font-awesome.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu:400,600|Source+Code+Pro">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.5.0/styles/atom-one-light.css">


    
    
    
    <style>body>.footer,body>.navbar,body>.section{opacity:0}</style>
    

    
    
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css">
    

    
    

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.css">


    
    
    
    

<link rel="stylesheet" href="/css/back-to-top.css">


    
    

    
    
    
    

    
    
<link rel="stylesheet" href="/css/progressbar.css">
<script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script>

    
    
    

    
    
    


<link rel="stylesheet" href="/css/style.css">
</head>
<body class="is-2-column">
    <!-- fork me on github -->
<a title="Fork me on GitHub" id="forkMe" style="position: fixed;top: 0;right: 0;z-index: 31" href="https://github.com/heptaluan" target="_blank">
    <svg style="color: #fff;fill: #a0a1a7;height: 80px;width: 80px;" viewbox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"/><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"/><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"/></svg>
</a>

<nav class="navbar navbar-main">
    <div class="container">
        <!-- <div class="navbar-brand is-flex-center">
            <a class="navbar-item navbar-logo" href="/">
            
                <img src="/images/logo.svg" alt="Node.js 中的 HTTP 模块" height="28">
            
            </a>
        </div> -->

        <div class="navbar-menu">
            
            <div class="navbar-start">
                
                <a class="navbar-item" href="/">Home</a>
                
                <a class="navbar-item" href="/archives">Archives</a>
                
                <a class="navbar-item" href="/categories">Categories</a>
                
                <a class="navbar-item" href="https://heptaluan.github.io/demos/">Demos</a>
                
            </div>
            
            <div class="navbar-end">
                
                
                <a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;">
                    <i class="fas fa-list-ul"></i>
                </a>
                
                
                <a class="navbar-item search" title="搜索" href="javascript:;">
                    <i class="fa fa-search"></i>
                </a>
                
            </div>
        </div>
    </div>
</nav>
    
    <section class="section">
        <div class="container">
            <div class="columns">
                <div class="column is-8-tablet is-8-desktop is-9-widescreen has-order-2 column-main"><div class="card">
    
    <div class="card-image">
        <span class="image is-7by1">
            <img class="thumbnail" src="https://gitee.com/heptaluan/backups/raw/master/cdn/cover/09.webp" alt="Node.js 中的 HTTP 模块">
        </span>
    </div>
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <div class="level-item has-text-grey">2019-10-02</div>
                <!-- <time class="level-item has-text-grey" datetime="2019-10-01T16:00:00.000Z">2019-10-02</time> -->
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/Node-js/">Node.js</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    24 分钟 读完 (大约 3553 个字)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                Node.js 中的 HTTP 模块
            
        </h1>
        <div class="content">
            <p><code>HTTP</code> 模块是 <code>Node.js</code> 中非常重要的一个核心模块，通过 <code>HTTP</code> 模块，可以使用其 <code>http.createServer()</code> 方法创建一个 <code>HTTP</code> 服务器，也可以使用其 <code>http.request()</code> 方法创建一个 <code>HTTP</code> 客户端，<code>Node.js</code> 对 <code>HTTP</code> 协议及相关 <code>API</code> 的封装比较底层，其仅能处理流和消息，对于消息的处理，也仅解析成『报文头』和『报文体』，但是不解析实际的报文头和报文体内容，这样不仅解决了 <code>HTTP</code> 原本比较难用的特性，也可以支持更多的 <code>HTTP</code> 应用</p>
<p>本文内容主要分为两部分『客户端』与『服务端』，我们下面就一个一个来进行了解</p>
<a id="more"></a>


<h2 id="服务端"><a href="#服务端" class="headerlink" title="服务端"></a>服务端</h2><p>实现 <code>HTTP</code> 服务端功能，要通过 <code>http.createServer()</code> 方法创建一个服务端对象 <code>http.Server</code>，这个方法接收一个可选传入参数 <code>requestListener</code>，该参数是一个函数，传入后将做为 <code>http.Server</code> 的 <code>request</code> 事件监听，不传入时，则需要通过在 <code>http.Server</code> 对象的 <code>request</code> 事件中单独添加，下面是两种创建 <code>http.Server</code> 对象及添加 <code>request</code> 事件监听器的示例</p>
<figure class="highlight js hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">var</span> http = <span class="hljs-built_in">require</span>(<span class="hljs-string">'http'</span>)</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// 创建 server 对象，并添加 request 事件监听器</span></span><br><span class="line"><span class="hljs-keyword">var</span> server = http.createServer(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">req, res</span>) </span>&#123;</span><br><span class="line">  res.writeHeader(<span class="hljs-number">200</span>, &#123; <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'text/plain'</span> &#125;)</span><br><span class="line">  res.end(<span class="hljs-string">'baidu.com'</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// 创建 server 对象，通过 server 对象的 request 事件添加事件事件监听器</span></span><br><span class="line"><span class="hljs-keyword">var</span> server = <span class="hljs-keyword">new</span> http.Server()</span><br><span class="line">server.on(<span class="hljs-string">'request'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">req, res</span>) </span>&#123;</span><br><span class="line">  res.writeHeader(<span class="hljs-number">200</span>, &#123; <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'text/plain'</span> &#125;)</span><br><span class="line">  res.end(<span class="hljs-string">'baidu.com'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="http-server"><a href="#http-server" class="headerlink" title="http.server"></a>http.server</h4><p><code>http.server</code> 是一个基于事件的 <code>HTTP</code> 服务器，所有的请求都被封装到独立的事件当中，我们只需要对事件编写相应的函数就可以实现 <code>HTTP</code> 服务器的所有功能，它继承自 <code>EventEmitter</code>，提供了以下的事件</p>
<ul>
<li><code>request</code>，当客户端请求到来的时候触发该事件，提供两个参数 <code>request</code> 和 <code>response</code>，分别是 <code>http.ServerRequest</code> 和 <code>http.ServerResponse</code>，表示请求和响应的信息</li>
<li><code>connection</code>，当 <code>TCP</code> 建立连接的时候触发该事件，提供了一个参数 <code>socket</code>，为 <code>net.socket</code> 的实例（底层协议对象）</li>
<li><code>close</code>，当服务器关闭的时候会被触发</li>
</ul>
<p>除此之外还有 <code>checkContinue</code>、<code>upgrade</code>、<code>clientError</code> 等事件，一般比较常见的还是 <code>request</code> 事件，所以官方也提供了一个更为简便的创建方式 <code>http.createServer([requestListener])</code>，就如上面示例当中的一样</p>
<h4 id="request-amp-amp-response"><a href="#request-amp-amp-response" class="headerlink" title="request &amp;&amp; response"></a>request &amp;&amp; response</h4><p><code>request</code> 代表着请求信息，比如我们请求的 <code>url</code> 地址为 <code>http://localhost:8080/index.html?name=123</code>，则服务器接收到的信息如下</p>
<figure class="highlight js hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">let</span> server = http.createServer(<span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="hljs-keyword">let</span> &#123; pathname, query &#125; = url.parse(req.url, <span class="hljs-literal">true</span>)</span><br><span class="line">  <span class="hljs-built_in">console</span>.log(pathname)     <span class="hljs-comment">// index.html</span></span><br><span class="line">  <span class="hljs-built_in">console</span>.log(query)        <span class="hljs-comment">// &#123; name: 123 &#125;</span></span><br><span class="line">  <span class="hljs-built_in">console</span>.log(req.url)      <span class="hljs-comment">// /index.html?name=123</span></span><br><span class="line">  <span class="hljs-built_in">console</span>.log(req.headers)  <span class="hljs-comment">// 获取请求头</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p><code>response</code> 代表着响应信息</p>
<figure class="highlight js hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">let</span> server = http.createServer(<span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  res.setHeader(<span class="hljs-string">'Content-Type'</span>, <span class="hljs-string">'text/html;charset=utf8'</span>)</span><br><span class="line">  <span class="hljs-comment">// 一旦调用会立刻向客户端发送</span></span><br><span class="line">  res.writeHead(<span class="hljs-number">200</span>, &#123;</span><br><span class="line">    <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'text/html;charset=utf8'</span></span><br><span class="line">  &#125;)</span><br><span class="line">  res.statusCode = <span class="hljs-number">400</span></span><br><span class="line">  res.end()</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h2><p><code>HTTP</code> 模块不仅可以做为 <code>HTTP</code> 服务器使用，也适用于客户端，<code>HTTP</code> 模块提供了创建 <code>HTTP</code> 客户端对象的方法，使用客户端对象可以创建对 <code>HTTP</code> 服务的访问，<code>http.request()</code> 方法用于创建 <code>HTTP</code> 请求，该方法会返回一个 <code>http.ClientRequest</code> 对象， 是 <code>http.createClient()</code> 方法的替代方法</p>
<p>请求创建后并不会立即发送请求，我们还可以继续访问和设置请求头，比如使用 <code>setHeader(name, value)</code>、<code>getHeader(name)</code> 和 <code>removeHeader(name)</code> 等 <code>API</code> 进行修改，实际的请求头会与第一个数据块一起发送或当调用 <code>request.end()</code> 时发送</p>
<h4 id="http-ClientRequest"><a href="#http-ClientRequest" class="headerlink" title="http.ClientRequest"></a>http.ClientRequest</h4><p><code>http.ClientRequest</code> 对象由 <code>http.request()</code> 创建并返回，它是一个正在处理的 <code>HTTP</code> 请求，其头部已经在队列中，<code>Header</code> 将会随着第一个数据块发送，或在连接关闭时发送</p>
<p><code>http.ClientRequest</code> 实现了 <code>Writable Stream</code> 接口，其对于向服务器发送数据，本质上是对这个可写流的操作，它还是一个 <code>EventEmitter</code>，包含 <code>response</code>、<code>socket</code>、<code>upgrade</code>、<code>continue</code> 等事件</p>
<h4 id="http-Agent"><a href="#http-Agent" class="headerlink" title="http.Agent"></a>http.Agent</h4><p><code>http.Agent</code> 是会把套接字做成资源池，用于 <code>HTTP</code> 客户端请求，当需要自定义一些自定义的代理参数（如主机的套接字并发数、套接字发送 <code>TCP KeepAlive</code> 包的频率等）时可以设置此对象，该对象由构造函数 <code>new Agent([options])</code> 创建返回</p>
<blockquote>
<p>更多详细内容可以参考官方文档 <a href="http://nodejs.cn/api/http.html#http_new_agent_options" target="_blank" rel="noopener">new Agent([options])</a></p>
</blockquote>
<h4 id="http-globalAgent"><a href="#http-globalAgent" class="headerlink" title="http.globalAgent"></a>http.globalAgent</h4><p><code>Agent</code> 的全局实例，是 <code>HTTP</code> 客户端的默认请求代理对象，其结构类似如下</p>
<figure class="highlight js hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#123; </span><br><span class="line">  domain: <span class="hljs-literal">null</span>,</span><br><span class="line">  _events: &#123; <span class="hljs-attr">free</span>: [<span class="hljs-built_in">Function</span>] &#125;,</span><br><span class="line">  _maxListeners: <span class="hljs-literal">undefined</span>,</span><br><span class="line">  defaultPort: <span class="hljs-number">80</span>,</span><br><span class="line">  protocol: <span class="hljs-string">'http:'</span>,</span><br><span class="line">  options: &#123; <span class="hljs-attr">path</span>: <span class="hljs-literal">null</span> &#125;,</span><br><span class="line">  requests: &#123;&#125;,</span><br><span class="line">  sockets: &#123;&#125;,</span><br><span class="line">  freeSockets: &#123;&#125;,</span><br><span class="line">  keepAliveMsecs: <span class="hljs-number">1000</span>,</span><br><span class="line">  keepAlive: <span class="hljs-literal">false</span>,</span><br><span class="line">  maxSockets: <span class="hljs-literal">Infinity</span>,</span><br><span class="line">  maxFreeSockets: <span class="hljs-number">256</span> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="GET-请求"><a href="#GET-请求" class="headerlink" title="GET 请求"></a>GET 请求</h4><figure class="highlight js hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">const</span> http = <span class="hljs-built_in">require</span>(<span class="hljs-string">'http'</span>)</span><br><span class="line"><span class="hljs-keyword">const</span> options = &#123;</span><br><span class="line">  host: <span class="hljs-string">'localhost'</span>,</span><br><span class="line">  port: <span class="hljs-number">8080</span>,</span><br><span class="line">  method: <span class="hljs-string">'get'</span>,</span><br><span class="line">  path: <span class="hljs-string">'/post'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">let</span> req = http.request(options)</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// 当服务器把请求体发回来的时候，或者说客户端接受到响应的时候</span></span><br><span class="line">req.on(<span class="hljs-string">'response'</span>, (res) =&gt; &#123;</span><br><span class="line">  <span class="hljs-keyword">let</span> result = []</span><br><span class="line">  res.on(<span class="hljs-string">'data'</span>, (data) =&gt; &#123;</span><br><span class="line">    result.push(data)</span><br><span class="line">  &#125;)</span><br><span class="line">  res.on(<span class="hljs-string">'end'</span>, () =&gt; &#123;</span><br><span class="line">    <span class="hljs-keyword">let</span> str = Buffer.concat(result)</span><br><span class="line">    <span class="hljs-built_in">console</span>.log(str.toString())</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// 只有调用 end() 才会真正向服务器发请求</span></span><br><span class="line">req.end()</span><br></pre></td></tr></table></figure>

<p>对应服务端代码如下</p>
<figure class="highlight js hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>)</span><br><span class="line"><span class="hljs-keyword">const</span> app = express()</span><br><span class="line"><span class="hljs-keyword">const</span> bodyParser = <span class="hljs-built_in">require</span>(<span class="hljs-string">'body-parser'</span>)</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// 处理 JSON 的请求体</span></span><br><span class="line">app.use(bodyParser.json())</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// GET 请求的内容是存储在 req.body 当中</span></span><br><span class="line">app.get(<span class="hljs-string">'/post'</span>, (req, res, next) =&gt; &#123;</span><br><span class="line">  <span class="hljs-comment">// console.log(req.body)</span></span><br><span class="line">  res.send(<span class="hljs-string">'123'</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.listen(<span class="hljs-number">8080</span>)</span><br></pre></td></tr></table></figure>

<h4 id="POST-请求"><a href="#POST-请求" class="headerlink" title="POST 请求"></a>POST 请求</h4><figure class="highlight js hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">let</span> http = <span class="hljs-built_in">require</span>(<span class="hljs-string">'http'</span>)</span><br><span class="line"><span class="hljs-keyword">let</span> options = &#123;</span><br><span class="line">  host: <span class="hljs-string">'localhost'</span>,</span><br><span class="line">  port: <span class="hljs-number">8080</span>,</span><br><span class="line">  method: <span class="hljs-string">'POST'</span>,</span><br><span class="line">  path: <span class="hljs-string">'/post'</span>,</span><br><span class="line">  headers: &#123;</span><br><span class="line">    <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// 需要注意，此时请求并没发出</span></span><br><span class="line"><span class="hljs-keyword">let</span> req = http.request(options)</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// 当服务器把请求体发回来的时候，或者说客户端接受到响应的时候</span></span><br><span class="line">req.on(<span class="hljs-string">'response'</span>, (res) =&gt; &#123;</span><br><span class="line">  <span class="hljs-keyword">let</span> result = []</span><br><span class="line">  res.on(<span class="hljs-string">'data'</span>, (data) =&gt; &#123;</span><br><span class="line">    result.push(data)</span><br><span class="line">  &#125;)</span><br><span class="line">  res.on(<span class="hljs-string">'end'</span>, (data) =&gt; &#123;</span><br><span class="line">    <span class="hljs-keyword">let</span> str = Buffer.concat(result)</span><br><span class="line">    <span class="hljs-built_in">console</span>.log(str.toString())</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// 向请求体写数据</span></span><br><span class="line">req.write(<span class="hljs-string">'&#123;"name": "zhangsan"&#125;'</span>)</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// 是结束写入请求体，只有调用 end() 才会真正向服务器发请求</span></span><br><span class="line">req.end()</span><br></pre></td></tr></table></figure>

<p>对应服务端代码如下</p>
<figure class="highlight js hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>)</span><br><span class="line"><span class="hljs-keyword">const</span> app = express()</span><br><span class="line"><span class="hljs-keyword">const</span> bodyParser = <span class="hljs-built_in">require</span>(<span class="hljs-string">'body-parser'</span>)</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// 针对 POST 请求，因为内容是一个 chunk 数据流累计的结果，所以采用 bodyParser 来进行处理</span></span><br><span class="line">app.use(bodyParser.json())</span><br><span class="line"></span><br><span class="line">app.post(<span class="hljs-string">'/post'</span>, (req, res, next) =&gt; &#123;</span><br><span class="line">  <span class="hljs-comment">// console.log(req.body)</span></span><br><span class="line">  res.send(<span class="hljs-string">'123'</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.listen(<span class="hljs-number">8080</span>)</span><br></pre></td></tr></table></figure>

<h2 id="请求与响应过程"><a href="#请求与响应过程" class="headerlink" title="请求与响应过程"></a>请求与响应过程</h2><p>先来回顾一下之前的示例，创建一个基本的服务器</p>
<figure class="highlight js hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">const</span> http = <span class="hljs-built_in">require</span>(<span class="hljs-string">'http'</span>)</span><br><span class="line"></span><br><span class="line">http.createServer(<span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  res.end(<span class="hljs-string">'hello world'</span>)</span><br><span class="line">&#125;).listen(<span class="hljs-number">8080</span>)</span><br></pre></td></tr></table></figure>

<p>使用起来就是这么简单，因为 <code>Node.js</code> 已经把具体实现细节给封装起来了，我们只需要调用 <code>HTTP</code> 模块提供的方法即可，那么，一个请求是如何处理，然后响应的呢？我们先来简单的梳理一下</p>
<figure class="highlight js hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">             _______</span><br><span class="line">            |       | <span class="hljs-xml"><span class="hljs-tag">&lt;<span class="hljs-name">==</span> <span class="hljs-attr">res</span></span></span></span><br><span class="line"><span class="hljs-xml">request ==&gt; |   ?   | </span></span><br><span class="line"><span class="hljs-xml">            |_______| ==&gt; req</span></span><br><span class="line"><span class="hljs-xml">               /\</span></span><br><span class="line"><span class="hljs-xml">               ||</span></span><br><span class="line"><span class="hljs-xml">        http.createServer()</span></span><br></pre></td></tr></table></figure>

<ul>
<li>先调用 <code>http.createServer()</code> 生成一个 <code>http.Server</code> 对象来处理请求</li>
<li>每次收到请求，都先解析生成 <code>req</code>（<code>http.IncomingMessage</code>）和 <code>res</code>（<code>http.ServerResponse</code>），然后交由用户函数处理</li>
<li>用户函数调用 <code>res.end()</code> 来结束处理，响应请求</li>
</ul>
<p>我们先来看看 <code>http.IncomingMessage</code> 和 <code>http.ServerResponse</code></p>
<h4 id="IncomingMessage"><a href="#IncomingMessage" class="headerlink" title="IncomingMessage"></a>IncomingMessage</h4><p>在 <code>Node.js</code> 服务器接收到请求时，会利用 <code>http-parser</code> 对象来解析请求报文，为了便于开发者使用，<code>Node.js</code> 会基于解析后的请求报文创建 <code>IncomingMessage</code> 对象，<code>IncomingMessage</code> 构造函数（代码片段）如下</p>
<figure class="highlight js hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">IncomingMessage</span>(<span class="hljs-params">socket</span>) </span>&#123;</span><br><span class="line">  Stream.Readable.call(<span class="hljs-keyword">this</span>)</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">this</span>.socket = socket</span><br><span class="line">  <span class="hljs-keyword">this</span>.connection = socket</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">this</span>.httpVersion = <span class="hljs-literal">null</span></span><br><span class="line">  <span class="hljs-keyword">this</span>.complete = <span class="hljs-literal">false</span></span><br><span class="line">  <span class="hljs-keyword">this</span>.headers = &#123;&#125;     <span class="hljs-comment">// 解析后的请求头</span></span><br><span class="line">  <span class="hljs-keyword">this</span>.rawHeaders = []  <span class="hljs-comment">// 原始的头部信息</span></span><br><span class="line"></span><br><span class="line">  <span class="hljs-comment">// request (server) only</span></span><br><span class="line">  <span class="hljs-keyword">this</span>.url = <span class="hljs-string">''</span>         <span class="hljs-comment">// 请求 url 地址</span></span><br><span class="line">  <span class="hljs-keyword">this</span>.method = <span class="hljs-literal">null</span>    <span class="hljs-comment">// 请求地址</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">util.inherits(IncomingMessage, Stream.Readable)</span><br></pre></td></tr></table></figure>

<p><code>HTTP</code> 协议是基于请求和响应，请求对象我们已经介绍了，那么接下来就是响应对象，在 <code>Node.js</code> 中，响应对象是 <code>ServerResponse</code> 类的实例</p>
<h4 id="ServerResponse"><a href="#ServerResponse" class="headerlink" title="ServerResponse"></a>ServerResponse</h4><figure class="highlight js hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ServerResponse</span>(<span class="hljs-params">req</span>) </span>&#123;</span><br><span class="line">  OutgoingMessage.call(<span class="hljs-keyword">this</span>)</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">if</span> (req.method === <span class="hljs-string">'HEAD'</span>) <span class="hljs-keyword">this</span>._hasBody = <span class="hljs-literal">false</span></span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">this</span>.sendDate = <span class="hljs-literal">true</span></span><br><span class="line">  <span class="hljs-keyword">this</span>._sent100 = <span class="hljs-literal">false</span></span><br><span class="line">  <span class="hljs-keyword">this</span>._expect_continue = <span class="hljs-literal">false</span></span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">if</span> (req.httpVersionMajor &lt; <span class="hljs-number">1</span> || req.httpVersionMinor &lt; <span class="hljs-number">1</span>) &#123;</span><br><span class="line">    <span class="hljs-keyword">this</span>.useChunkedEncodingByDefault = chunkExpression.test(req.headers.te)</span><br><span class="line">    <span class="hljs-keyword">this</span>.shouldKeepAlive = <span class="hljs-literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">util.inherits(ServerResponse, OutgoingMessage)</span><br></pre></td></tr></table></figure>

<p>通过以上代码，我们可以发现 <code>ServerResponse</code> 继承于 <code>OutgoingMessage</code>，在 <code>OutgoingMessage</code> 对象中会包含用于生成响应报文的相关信息，下面就让我们正式开始探寻 <code>http.createServer()</code> 方法的内部原理</p>
<h4 id="http-createServer"><a href="#http-createServer" class="headerlink" title="http.createServer"></a>http.createServer</h4><p><code>http.createServer</code> 的实现如下</p>
<figure class="highlight js hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">// lib/http.js</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createServer</span>(<span class="hljs-params">requestListener</span>) </span>&#123;</span><br><span class="line">  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Server(requestListener)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// lib/_http_server.js</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Server</span>(<span class="hljs-params">requestListener</span>) </span>&#123;</span><br><span class="line">  <span class="hljs-keyword">if</span> (!(<span class="hljs-keyword">this</span> <span class="hljs-keyword">instanceof</span> Server)) <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Server(requestListener)</span><br><span class="line">  net.Server.call(<span class="hljs-keyword">this</span>, &#123; <span class="hljs-attr">allowHalfOpen</span>: <span class="hljs-literal">true</span> &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">if</span> (requestListener) &#123;</span><br><span class="line">    <span class="hljs-keyword">this</span>.on(<span class="hljs-string">'request'</span>, requestListener)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">this</span>.on(<span class="hljs-string">'connection'</span>, connectionListener)</span><br><span class="line"></span><br><span class="line">  <span class="hljs-comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>http.createServer()</code> 函数返回一个 <code>http.Server</code> 实例，该实例监听了 <code>request</code> 和 <code>connection</code> 两个事件</p>
<ul>
<li><code>request</code> 事件绑定 <code>requestListener()</code> 函数，<code>req</code> 和 <code>res</code> 准备好时触发</li>
<li><code>connection</code> 事件绑定 <code>connectionListener()</code> 函数，连接时触发</li>
</ul>
<p>用户函数是 <code>requestListener()</code>，也就是说，在触发 <code>request</code> 事件后，就会调用我们设置的 <code>requestListener</code> 函数，如下</p>
<figure class="highlight js hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(req, res) =&gt; &#123;</span><br><span class="line">  res.end(<span class="hljs-string">'hello world'</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="connectionListenerInternal"><a href="#connectionListenerInternal" class="headerlink" title="connectionListenerInternal"></a>connectionListenerInternal</h4><p><code>connection</code> 事件，顾名思义用来跟踪网络连接，因此我们需要知道 <code>request</code> 事件何时触发</p>
<figure class="highlight js hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">connectionListener</span>(<span class="hljs-params">socket</span>) </span>&#123;</span><br><span class="line">  defaultTriggerAsyncIdScope(</span><br><span class="line">    getOrSetAsyncId(socket), connectionListenerInternal, <span class="hljs-keyword">this</span>, socket</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">connectionListenerInternal</span>(<span class="hljs-params">server, socket</span>) </span>&#123;</span><br><span class="line">  httpSocketSetup(socket)</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">if</span> (socket.server === <span class="hljs-literal">null</span>)</span><br><span class="line">    socket.server = server</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">if</span> (server.timeout &amp;&amp; <span class="hljs-keyword">typeof</span> socket.setTimeout === <span class="hljs-string">'function'</span>)</span><br><span class="line">    socket.setTimeout(server.timeout)</span><br><span class="line">  <span class="hljs-comment">// 处理超时情况</span></span><br><span class="line">  socket.on(<span class="hljs-string">'timeout'</span>, socketOnTimeout)</span><br><span class="line"></span><br><span class="line">  <span class="hljs-comment">// 获取 parser 对象（见下方）</span></span><br><span class="line">  <span class="hljs-keyword">var</span> parser = parsers.alloc()</span><br><span class="line">  parser.reinitialize(HTTPParser.REQUEST)</span><br><span class="line">  parser.socket = socket</span><br><span class="line">  socket.parser = parser</span><br><span class="line">  parser.incoming = <span class="hljs-literal">null</span></span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">var</span> state = &#123;</span><br><span class="line">    outgoing: [],</span><br><span class="line">    incoming: [],</span><br><span class="line">    <span class="hljs-comment">//...</span></span><br><span class="line">  &#125;</span><br><span class="line">  parser.onIncoming = parserOnIncoming.bind(<span class="hljs-literal">undefined</span>, server, socket, state)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 <code>connectionListenerInternal</code> 函数内部可以发现有一个 <code>parser</code> 对象，<code>parser</code> 对象是由一个叫做 <code>FreeList</code> 的数据结构实现，其主要目的是复用 <code>parser</code>，通过调用 <code>parsers.alloc()</code> 和 <code>parsers.free(parser)</code> 来获取释放 <code>parser</code>，下面就先来看看 <code>FreeList</code> 这个对象</p>
<h4 id="FreeList"><a href="#FreeList" class="headerlink" title="FreeList"></a>FreeList</h4><p>在 <code>Node.js</code> 中为了避免频繁创建和销毁对象，有一个通用的 <code>FreeList</code> 机制，在 <code>HTTP</code> 模块中，就利用到了 <code>FreeList</code> 机制，即用来动态管理 <code>http-parser</code> 对象</p>
<figure class="highlight js hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">var</span> parsers = <span class="hljs-keyword">new</span> FreeList(<span class="hljs-string">'parsers'</span>, <span class="hljs-number">1000</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;</span><br><span class="line">  <span class="hljs-keyword">var</span> parser = <span class="hljs-keyword">new</span> HTTPParser(HTTPParser.REQUEST)</span><br><span class="line">  <span class="hljs-comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>具体实现如下</p>
<figure class="highlight js hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FreeList</span> </span>&#123;</span><br><span class="line">  <span class="hljs-keyword">constructor</span>(name, max, ctor) &#123;</span><br><span class="line">    <span class="hljs-keyword">this</span>.name = name  <span class="hljs-comment">// 管理的对象名称</span></span><br><span class="line">    <span class="hljs-keyword">this</span>.ctor = ctor  <span class="hljs-comment">// 管理对象的构造函数</span></span><br><span class="line">    <span class="hljs-keyword">this</span>.max = max    <span class="hljs-comment">// 存储对象的最大值</span></span><br><span class="line">    <span class="hljs-keyword">this</span>.list = []    <span class="hljs-comment">// 存储对象的数组</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  alloc() &#123;</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.list.length </span><br><span class="line">      ? <span class="hljs-keyword">this</span>.list.pop()</span><br><span class="line">      : <span class="hljs-keyword">this</span>.ctor.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  free(obj) &#123;</span><br><span class="line">    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.list.length &lt; <span class="hljs-keyword">this</span>.max) &#123;</span><br><span class="line">      <span class="hljs-keyword">this</span>.list.push(obj)</span><br><span class="line">      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在处理 <code>HTTP</code> 请求的场景下，当新的请求到来时，我们通过调用 <code>parsers.alloc()</code> 方法来获取 <code>http-parser</code> 对象，从而解析 <code>HTTP</code> 请求，当完成 <code>HTTP</code> 解析任务后，我们可以通过调用 <code>parsers.free()</code> 方法来归还 <code>http-parser</code> 对象</p>
<h4 id="parserOnIncoming"><a href="#parserOnIncoming" class="headerlink" title="parserOnIncoming"></a>parserOnIncoming</h4><p>既然，<code>HTTP</code> 报文是由 <code>parser</code> 来解析的，那么就让我们来看看 <code>parser</code> 是如何创建的吧</p>
<figure class="highlight js hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">var</span> parsers = <span class="hljs-keyword">new</span> FreeList(<span class="hljs-string">'parsers'</span>, <span class="hljs-number">1000</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;</span><br><span class="line">  <span class="hljs-keyword">var</span> parser = <span class="hljs-keyword">new</span> HTTPParser(HTTPParser.REQUEST)</span><br><span class="line"></span><br><span class="line">  parser._headers = []</span><br><span class="line">  parser._url = <span class="hljs-string">''</span></span><br><span class="line">  parser._consumed = <span class="hljs-literal">false</span></span><br><span class="line"></span><br><span class="line">  parser.socket = <span class="hljs-literal">null</span></span><br><span class="line">  parser.incoming = <span class="hljs-literal">null</span></span><br><span class="line">  parser.outgoing = <span class="hljs-literal">null</span></span><br><span class="line"></span><br><span class="line">  parser[kOnHeaders] = parserOnHeaders</span><br><span class="line">  parser[kOnHeadersComplete] = parserOnHeadersComplete</span><br><span class="line">  parser[kOnBody] = parserOnBody</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">return</span> parser</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>在上面以 <code>parser</code> 开头的这些对象，都是定义在 <code>_http_common.js</code> 文件中的函数对象，让我们来简单的梳理一下</p>
<ul>
<li><code>parserOnHeaders</code>，当请求头跨多个 <code>TCP</code> 数据包或者过大无法再一个运行周期内处理完才会调用该方法</li>
<li><code>kOnHeadersComplete</code>，请求头解析完成后，会调用该方法，方法内部会创建 <code>IncomingMessage</code> 对象，填充相关的属性，比如 <code>url</code>、<code>httpVersion</code>、<code>method</code>和 <code>headers</code> 等</li>
<li><code>parserOnBody</code>，不断解析已接收的请求体数据</li>
</ul>
<p>这里需要注意的是，请求报文的解析工作是由 <code>C++</code> 来完成，内部通过 <code>binding</code> 来实现，具体可以参考 <code>deps/http_parser</code> 目录</p>
<figure class="highlight js hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">const</span> &#123; methods, HTTPParser &#125; = process.binding(<span class="hljs-string">'http_parser'</span>)</span><br></pre></td></tr></table></figure>

<p>在 <code>connectionListenerInternal</code> 函数中，在最后一行设置了 <code>parser</code> 对象的 <code>onIncoming</code> 属性为绑定后的 <code>parserOnIncoming</code> 函数</p>
<figure class="highlight js hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parserOnIncoming</span>(<span class="hljs-params">server, socket, state, req, keepAlive</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="hljs-comment">// 缓冲 IncomingMessage 实例</span></span><br><span class="line">  state.incoming.push(req)</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">var</span> res = <span class="hljs-keyword">new</span> server[kServerResponse](req)</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">if</span> (socket._httpMessage) &#123;</span><br><span class="line">    <span class="hljs-comment">// 缓冲 ServerResponse 实例</span></span><br><span class="line">    state.outgoing.push(res)</span><br><span class="line">  &#125; <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">    res.assignSocket(socket)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="hljs-comment">// 判断请求头是否包含 expect 字段且 http 协议的版本为 1.1</span></span><br><span class="line">  <span class="hljs-keyword">if</span> (req.headers.expect !== <span class="hljs-literal">undefined</span> &amp;&amp;</span><br><span class="line">    (req.httpVersionMajor === <span class="hljs-number">1</span> &amp;&amp; req.httpVersionMinor === <span class="hljs-number">1</span>)) &#123;</span><br><span class="line">    <span class="hljs-comment">// continueExpression: /(?:^|\W)100-continue(?:$|\W)/i</span></span><br><span class="line">    <span class="hljs-comment">// Expect: 100-continue</span></span><br><span class="line">    <span class="hljs-keyword">if</span> (continueExpression.test(req.headers.expect)) &#123;</span><br><span class="line">      res._expect_continue = <span class="hljs-literal">true</span></span><br><span class="line"></span><br><span class="line">      <span class="hljs-keyword">if</span> (server.listenerCount(<span class="hljs-string">'checkContinue'</span>) &gt; <span class="hljs-number">0</span>) &#123;</span><br><span class="line">        server.emit(<span class="hljs-string">'checkContinue'</span>, req, res)</span><br><span class="line">      &#125; <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">        res.writeContinue()</span><br><span class="line">        server.emit(<span class="hljs-string">'request'</span>, req, res)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (server.listenerCount(<span class="hljs-string">'checkExpectation'</span>) &gt; <span class="hljs-number">0</span>) &#123;</span><br><span class="line">      server.emit(<span class="hljs-string">'checkExpectation'</span>, req, res)</span><br><span class="line">    &#125; <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">      <span class="hljs-comment">// http 协议中的 417 Expectation Failed 状态码表示客户端错误</span></span><br><span class="line">      <span class="hljs-comment">// 意味着服务器无法满足 Expect 请求消息头中的期望条件</span></span><br><span class="line">      res.writeHead(<span class="hljs-number">417</span>)</span><br><span class="line">      res.end()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="hljs-keyword">else</span> &#123;</span><br><span class="line">    server.emit(<span class="hljs-string">'request'</span>, req, res)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过观察上面的代码，我们终于发现了 <code>request</code> 事件的踪迹，在 <code>parserOnIncoming</code> 函数内，我们会基于 <code>req</code> 请求对象创建 <code>ServerResponse</code> 响应对象，在创建响应对象后，会判断请求头是否包含 <code>expect</code> 字段，然后针对不同的条件做出不同的处理，对于之前最早的示例来说，程序会直接走 <code>else</code> 分支，即触发 <code>request</code> 事件，并传递当前的请求对象和响应对象</p>
<p>最后我们来回顾一下整个流程</p>
<ul>
<li>调用 <code>http.createServer()</code> 方法创建 <code>server</code> 对象，该对象创建完后，我们调用 <code>listen()</code> 方法执行监听操作</li>
<li>当 <code>server</code> 接收到客户端的连接请求，在成功创建 <code>socket</code> 对象后，会触发 <code>connection</code> 事件</li>
<li>当 <code>connection</code> 事件触发后，会执行对应的 <code>connectionListener</code> 回调函数，在函数内部会利用 <code>http-parser</code> 对象，对请求报文进行解析</li>
<li>在完成请求头的解析后，会创建 <code>IncomingMessage</code> 对象，并填充相关的属性，比如 <code>url</code>、<code>httpVersion</code>、<code>method</code> 和 <code>headers</code> 等</li>
<li>在配置完 <code>IncomingMessage</code> 对象后，会调用 <code>parserOnIncoming</code> 函数，在该函数内会构建 <code>ServerResponse</code> 响应对象，如果请求头不包含 <code>expect</code> 字段，则 <code>server</code> 就会触发 <code>request</code> 事件，并传递当前的请求对象和响应对象</li>
<li><code>request</code> 事件触发后，就会执行我们设定的 <code>requestListener</code> 函数</li>
</ul>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a href="http://nodejs.cn/api/http.html" target="_blank" rel="noopener">http</a></li>
<li><a href="https://javascript.ruanyifeng.com/nodejs/http.html" target="_blank" rel="noopener">http 模块</a></li>
<li><a href="https://docs.pythontab.com/nodejs/httpclientrequest/" target="_blank" rel="noopener">http.ClientRequest</a></li>
<li><a href="http://liyangready.github.io/2015/09/16/nodejs%E6%BA%90%E7%A0%81-http-server/" target="_blank" rel="noopener">Node.js 源码 http server</a></li>
<li><a href="https://www.jianshu.com/p/4b32151ceffa" target="_blank" rel="noopener">http 请求响应过程</a></li>
</ul>

        </div>
        
        <div class="level is-size-7 is-uppercase">
            <div class="level-start">
                <div class="level-item">
                    <span class="is-size-6 has-text-grey has-mr-7">#</span>
                    <a class="has-link-grey -link" href="/tags/Node-js/">Node.js</a>
                </div>
            </div>
        </div>
        
        
        
    </div>
</div>





<div class="card card-transparent">
    <div class="level post-navigation is-flex-wrap is-mobile">
        
        <div class="level-start">
            <a class="level level-item has-link-grey  article-nav-prev" href="/2019/10/09/Node/01/">
                <i class="level-item fa fa-chevron-left"></i>
                <span class="level-item">Node.js 中的 Stream（流）</span>
            </a>
        </div>
        
        
        <div class="level-end">
            <a class="level level-item has-link-grey  article-nav-next" href="/2019/09/28/Node/08/">
                <span class="level-item">Node.js 中的模块机制</span>
                <i class="level-item fa fa-chevron-right"></i>
            </a>
        </div>
        
    </div>
</div>



<div class="card">
    <div class="card-content">
        <h3 class="title is-5 has-text-weight-normal">评论</h3>
        
<div id="comment-container"></div>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1.4.1/dist/gitalk.css">
<script src="https://cdn.jsdelivr.net/npm/gitalk@1.4.1/dist/gitalk.min.js"></script>
<script>
    var gitalk = new Gitalk({
        clientID: '584b59de0d23cd48fbdd',
        clientSecret: '5554c9aab0a640015867806f438bd2e10f297e5a',
        id: 'e740f4c4c6e0cb93d6fa50d18d28bc7f',
        repo: 'gitalk',
        owner: 'heptaluan',
        admin: "heptaluan"
    })
    gitalk.render('comment-container')
</script>

    </div>
</div>
</div>
                




<div class="column is-4-tablet is-4-desktop is-3-widescreen  has-order-1 column-left ">
    
        
<div class="card widget">
    <div class="card-content">
        <nav class="level">
            <div class="level-item has-text-centered">
                <div>
                    
                        <figure class="avatar image is-128x128 has-mb-6">
                            <img class="is-rounded" src="https://gitee.com/heptaluan/backups/raw/master/cdn/avatar.png" alt="heptaluan">
                        </figure>
                    
                    
                    <p class="is-size-4 is-block">
                        heptaluan
                    </p>
                    
                    
                    <p class="is-size-6 is-block">
                        Torches@Aimer
                    </p>
                    
                    
                    <p class="is-size-6 is-flex is-flex-center has-text-grey">
                        <i class="fas fa-map-marker-alt has-mr-7"></i>
                        <span>WuHan China</span>
                    </p>
                    
                </div>
            </div>
        </nav>
        <!-- <nav class="level is-mobile">
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        文章
                    </p>
                    <p class="title has-text-weight-normal">
                        151
                    </p>
                </div>
            </div>
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        分类
                    </p>
                    <p class="title has-text-weight-normal">
                        8
                    </p>
                </div>
            </div>
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        标签
                    </p>
                    <p class="title has-text-weight-normal">
                        8
                    </p>
                </div>
            </div>
        </nav> -->
        <!-- <div class="level">
            <a class="level-item button is-link is-rounded" href="https://github.com/ppoffice" target="_blank">
                关注我</a>
        </div> -->
        
        
    </div>
</div>
    
        
<div class="card widget" id="toc">
    <div class="card-content">
        <div class="menu">
            <h3 class="menu-label">
                目录
            </h3>
            <ul class="menu-list"><li>
        <a class="is-flex" href="#服务端">
        <span class="has-mr-6">1</span>
        <span>服务端</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#http-server">
        <span class="has-mr-6">1.1</span>
        <span>http.server</span>
        </a></li><li>
        <a class="is-flex" href="#request-amp-amp-response">
        <span class="has-mr-6">1.2</span>
        <span>request &amp;&amp; response</span>
        </a></li></ul></li><li>
        <a class="is-flex" href="#客户端">
        <span class="has-mr-6">2</span>
        <span>客户端</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#http-ClientRequest">
        <span class="has-mr-6">2.1</span>
        <span>http.ClientRequest</span>
        </a></li><li>
        <a class="is-flex" href="#http-Agent">
        <span class="has-mr-6">2.2</span>
        <span>http.Agent</span>
        </a></li><li>
        <a class="is-flex" href="#http-globalAgent">
        <span class="has-mr-6">2.3</span>
        <span>http.globalAgent</span>
        </a></li><li>
        <a class="is-flex" href="#GET-请求">
        <span class="has-mr-6">2.4</span>
        <span>GET 请求</span>
        </a></li><li>
        <a class="is-flex" href="#POST-请求">
        <span class="has-mr-6">2.5</span>
        <span>POST 请求</span>
        </a></li></ul></li><li>
        <a class="is-flex" href="#请求与响应过程">
        <span class="has-mr-6">3</span>
        <span>请求与响应过程</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#IncomingMessage">
        <span class="has-mr-6">3.1</span>
        <span>IncomingMessage</span>
        </a></li><li>
        <a class="is-flex" href="#ServerResponse">
        <span class="has-mr-6">3.2</span>
        <span>ServerResponse</span>
        </a></li><li>
        <a class="is-flex" href="#http-createServer">
        <span class="has-mr-6">3.3</span>
        <span>http.createServer</span>
        </a></li><li>
        <a class="is-flex" href="#connectionListenerInternal">
        <span class="has-mr-6">3.4</span>
        <span>connectionListenerInternal</span>
        </a></li><li>
        <a class="is-flex" href="#FreeList">
        <span class="has-mr-6">3.5</span>
        <span>FreeList</span>
        </a></li><li>
        <a class="is-flex" href="#parserOnIncoming">
        <span class="has-mr-6">3.6</span>
        <span>parserOnIncoming</span>
        </a></li></ul></li><li>
        <a class="is-flex" href="#参考">
        <span class="has-mr-6">4</span>
        <span>参考</span>
        </a></li></ul>
        </div>
    </div>
</div>

    
        


    
        
<div class="card widget">
    <div class="card-content">
        <div class="menu">
            <h3 class="menu-label">
                分类
            </h3>
            <ul class="menu-list">
            <li>
        <a class="level is-marginless" href="/categories/Angular/">
            <span class="level-start">
                <span class="level-item">Angular</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">15</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/CSS/">
            <span class="level-start">
                <span class="level-item">CSS</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">14</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/Essay/">
            <span class="level-start">
                <span class="level-item">Essay</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">29</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/HTTP/">
            <span class="level-start">
                <span class="level-item">HTTP</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">11</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/JavaScript/">
            <span class="level-start">
                <span class="level-item">JavaScript</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">45</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/Node-js/">
            <span class="level-start">
                <span class="level-item">Node.js</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">14</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/React/">
            <span class="level-start">
                <span class="level-item">React</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">18</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/Vue/">
            <span class="level-start">
                <span class="level-item">Vue</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">5</span>
            </span>
        </a></li>
            </ul>
        </div>
    </div>
</div>
    
        
<div class="card widget">
    <div class="card-content">
        <h3 class="menu-label">
            标签云
        </h3>
        <a href="/tags/Angular/" style="font-size: 15px;">Angular</a> <a href="/tags/CSS/" style="font-size: 13.33px;">CSS</a> <a href="/tags/Essay/" style="font-size: 18.33px;">Essay</a> <a href="/tags/HTTP/" style="font-size: 11.67px;">HTTP</a> <a href="/tags/JavaScript/" style="font-size: 20px;">JavaScript</a> <a href="/tags/Node-js/" style="font-size: 13.33px;">Node.js</a> <a href="/tags/React/" style="font-size: 16.67px;">React</a> <a href="/tags/Vue/" style="font-size: 10px;">Vue</a>
    </div>
</div>

    
    
        <div class="column-right-shadow  ">
        
            
<div class="card widget">
    <div class="card-content">
        <h3 class="menu-label">
            <a href="/tips" class="tips">
                最新文章
            </a>
        </h3>
        
        <article class="media">
            
            <a href="/2021/03/07/Vue/06/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="https://gitee.com/heptaluan/backups/raw/master/cdn/cover/06.webp" alt="Vite 的工程化流程">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2021-03-06T16:00:00.000Z">2021-03-07</time></div>
                    <a href="/2021/03/07/Vue/06/" class="has-link-black-ter is-size-6">Vite 的工程化流程</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/Vue/">Vue</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <a href="/2021/01/10/JavaScript/59/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="https://gitee.com/heptaluan/backups/raw/master/cdn/cover/59.webp" alt="在 React 当中使用 TypeScript">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2021-01-09T16:00:00.000Z">2021-01-10</time></div>
                    <a href="/2021/01/10/JavaScript/59/" class="has-link-black-ter is-size-6">在 React 当中使用 TypeScript</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/JavaScript/">JavaScript</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <a href="/2021/01/09/JavaScript/58/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="https://gitee.com/heptaluan/backups/raw/master/cdn/cover/58.webp" alt="深入 TypeScript 当中的泛型">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2021-01-08T16:00:00.000Z">2021-01-09</time></div>
                    <a href="/2021/01/09/JavaScript/58/" class="has-link-black-ter is-size-6">深入 TypeScript 当中的泛型</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/JavaScript/">JavaScript</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <a href="/2021/01/01/JavaScript/57/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="https://gitee.com/heptaluan/backups/raw/master/cdn/cover/57.webp" alt="深入 TypeScript">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2020-12-31T16:00:00.000Z">2021-01-01</time></div>
                    <a href="/2021/01/01/JavaScript/57/" class="has-link-black-ter is-size-6">深入 TypeScript</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/JavaScript/">JavaScript</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <a href="/2020/12/26/JavaScript/56/" class="media-left">
                <p class="image is-64x64">
                    <img class="thumbnail" src="https://gitee.com/heptaluan/backups/raw/master/cdn/cover/56.webp" alt="重温 TypeScript">
                </p>
            </a>
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2020-12-25T16:00:00.000Z">2020-12-26</time></div>
                    <a href="/2020/12/26/JavaScript/56/" class="has-link-black-ter is-size-6">重温 TypeScript</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/JavaScript/">JavaScript</a>
                    </p>
                </div>
            </div>
        </article>
        
    </div>
</div>

        
            <div class="card widget">
    <div class="card-content">
        <div class="menu">
        <h3 class="menu-label">
            归档
        </h3>
        <ul class="menu-list">
        
        <li>
            <a class="level is-marginless" href="/archives/2021/03/">
                <span class="level-start">
                    <span class="level-item">三月 2021</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2021/01/">
                <span class="level-start">
                    <span class="level-item">一月 2021</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2020/12/">
                <span class="level-start">
                    <span class="level-item">十二月 2020</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2020/11/">
                <span class="level-start">
                    <span class="level-item">十一月 2020</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2020/10/">
                <span class="level-start">
                    <span class="level-item">十月 2020</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">6</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2020/09/">
                <span class="level-start">
                    <span class="level-item">九月 2020</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">5</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2020/08/">
                <span class="level-start">
                    <span class="level-item">八月 2020</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">2</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2020/07/">
                <span class="level-start">
                    <span class="level-item">七月 2020</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">2</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2020/06/">
                <span class="level-start">
                    <span class="level-item">六月 2020</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">4</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2020/05/">
                <span class="level-start">
                    <span class="level-item">五月 2020</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2020/04/">
                <span class="level-start">
                    <span class="level-item">四月 2020</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">5</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2020/03/">
                <span class="level-start">
                    <span class="level-item">三月 2020</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">7</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2020/02/">
                <span class="level-start">
                    <span class="level-item">二月 2020</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">4</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2020/01/">
                <span class="level-start">
                    <span class="level-item">一月 2020</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">5</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/12/">
                <span class="level-start">
                    <span class="level-item">十二月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">7</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/11/">
                <span class="level-start">
                    <span class="level-item">十一月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">4</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/10/">
                <span class="level-start">
                    <span class="level-item">十月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">6</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/09/">
                <span class="level-start">
                    <span class="level-item">九月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">7</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/08/">
                <span class="level-start">
                    <span class="level-item">八月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/07/">
                <span class="level-start">
                    <span class="level-item">七月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">4</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/06/">
                <span class="level-start">
                    <span class="level-item">六月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">5</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/05/">
                <span class="level-start">
                    <span class="level-item">五月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">5</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/04/">
                <span class="level-start">
                    <span class="level-item">四月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">2</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/03/">
                <span class="level-start">
                    <span class="level-item">三月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">2</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/02/">
                <span class="level-start">
                    <span class="level-item">二月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">2</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/01/">
                <span class="level-start">
                    <span class="level-item">一月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/12/">
                <span class="level-start">
                    <span class="level-item">十二月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">6</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/11/">
                <span class="level-start">
                    <span class="level-item">十一月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">4</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/10/">
                <span class="level-start">
                    <span class="level-item">十月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/09/">
                <span class="level-start">
                    <span class="level-item">九月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/08/">
                <span class="level-start">
                    <span class="level-item">八月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/07/">
                <span class="level-start">
                    <span class="level-item">七月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/06/">
                <span class="level-start">
                    <span class="level-item">六月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/05/">
                <span class="level-start">
                    <span class="level-item">五月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">2</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/04/">
                <span class="level-start">
                    <span class="level-item">四月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/03/">
                <span class="level-start">
                    <span class="level-item">三月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">2</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/02/">
                <span class="level-start">
                    <span class="level-item">二月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2018/01/">
                <span class="level-start">
                    <span class="level-item">一月 2018</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2017/12/">
                <span class="level-start">
                    <span class="level-item">十二月 2017</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2017/11/">
                <span class="level-start">
                    <span class="level-item">十一月 2017</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2017/10/">
                <span class="level-start">
                    <span class="level-item">十月 2017</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">2</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2017/09/">
                <span class="level-start">
                    <span class="level-item">九月 2017</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">2</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2017/08/">
                <span class="level-start">
                    <span class="level-item">八月 2017</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2017/07/">
                <span class="level-start">
                    <span class="level-item">七月 2017</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2017/06/">
                <span class="level-start">
                    <span class="level-item">六月 2017</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">2</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2017/05/">
                <span class="level-start">
                    <span class="level-item">五月 2017</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2017/04/">
                <span class="level-start">
                    <span class="level-item">四月 2017</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">2</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2017/03/">
                <span class="level-start">
                    <span class="level-item">三月 2017</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2017/01/">
                <span class="level-start">
                    <span class="level-item">一月 2017</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2016/12/">
                <span class="level-start">
                    <span class="level-item">十二月 2016</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        </ul>
        </div>
    </div>
</div>
        
            <div class="card widget">
    <div class="card-content">
        <div class="menu">
            <h3 class="menu-label">
                标签
            </h3>
            <div class="field is-grouped is-grouped-multiline">
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Angular/">
                        <span class="tag">Angular</span>
                        <span class="tag is-grey">15</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/CSS/">
                        <span class="tag">CSS</span>
                        <span class="tag is-grey">14</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Essay/">
                        <span class="tag">Essay</span>
                        <span class="tag is-grey">29</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/HTTP/">
                        <span class="tag">HTTP</span>
                        <span class="tag is-grey">11</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/JavaScript/">
                        <span class="tag">JavaScript</span>
                        <span class="tag is-grey">45</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Node-js/">
                        <span class="tag">Node.js</span>
                        <span class="tag is-grey">14</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/React/">
                        <span class="tag">React</span>
                        <span class="tag is-grey">18</span>
                    </a>
                </div>
                
                <div class="control">
                    <a class="tags has-addons" href="/tags/Vue/">
                        <span class="tag">Vue</span>
                        <span class="tag is-grey">5</span>
                    </a>
                </div>
                
            </div>
        </div>
    </div>
</div>
        
        </div>
    
</div>

                
            </div>
        </div>
    </section>
    <footer class="footer">
    <div class="container">
        <div class="level">
            <div class="level-start has-text-centered-mobile">
                <!-- <a class="footer-logo is-block has-mb-6" href="/">
                
                    <img src="/images/logo.svg" alt="Node.js 中的 HTTP 模块" height="28">
                
                </a> -->
                <p class="is-size-7">
                &copy; 2016 - 2021
                Made with ✿  heptaluan&nbsp;
                
                </p>
            </div>
            <!-- <div class="level-end">
            
            </div> -->
        </div>
    </div>
</footer>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script>
<script>moment.locale("zh-CN");</script>


    
    
    
    <script src="/js/animation.js"></script>
    

    
    
    
    <script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script>
    <script src="/js/gallery.js" defer></script>
    

    
    

<div id="outdated">
    <h6>Your browser is out-of-date!</h6>
    <p>Update your browser to view this website correctly. <a id="btnUpdateBrowser" href="http://outdatedbrowser.com/">Update
            my browser now </a></p>
    <p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">&times;</a></p>
</div>
<script src="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.js" defer></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        outdatedBrowser({
            bgColor: '#f25648',
            color: '#ffffff',
            lowerThan: 'flex'
        });
    });
</script>


    
    
<script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    MathJax.Hub.Config({
        'HTML-CSS': {
            matchFontHeight: false
        },
        SVG: {
            matchFontHeight: false
        },
        CommonHTML: {
            matchFontHeight: false
        },
        tex2jax: {
            inlineMath: [
                ['$','$'],
                ['\\(','\\)']
            ]
        }
    });
});
</script>

    
    

<a id="back-to-top" title="回到顶端" href="javascript:;">
    <i class="fa fa-chevron-up"></i>
</a>
<script src="/js/back-to-top.js" defer></script>


    
    

    
    
    
    

    
    
    
    
    
    <script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script>
    <script src="/js/clipboard.js" defer></script>
    

    
    
    


<script src="/js/main.js" defer></script>

    
    <div class="searchbox ins-search">
    <div class="searchbox-container ins-search-container">
        <div class="searchbox-input-wrapper">
            <input type="text" class="searchbox-input ins-search-input" placeholder="想要查找什么...">
            <span class="searchbox-close ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="searchbox-result-wrapper ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
    (function (window) {
        var INSIGHT_CONFIG = {
            TRANSLATION: {
                POSTS: '文章',
                PAGES: '页面',
                CATEGORIES: '分类',
                TAGS: '标签',
                UNTITLED: '(无标题)',
            },
            CONTENT_URL: '/content.json',
        };
        window.INSIGHT_CONFIG = INSIGHT_CONFIG;
    })(window);
</script>
<script src="/js/insight.js" defer></script>
<link rel="stylesheet" href="/css/search.css">
<link rel="stylesheet" href="/css/insight.css">
    
</body>
</html>